<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <iframe src="https://extremelystiff.github.io/sandstormplayercount/widget.html" frameborder="0" scrolling="no" width="100%" height="auto" style="display:block; border:none; background:#000;"></iframe>
    
    <title>Insurgency Sandstorm Server Launcher</title>
    
    <style>
        :root {
            --primary: #d3a03e; 
            --primary-hover: #b88a32;
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #2d3748;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --success: #48bb78;
            --danger: #e53e3e;
            --header-bg: #1a202c;
            --header-text: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            font-size: 14px;
        }

        .container {
            width: 95%;
            max-width: 1920px;
            margin: 20px auto;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            color: var(--header-bg);
        }
        
        h2, h3 { color: var(--header-bg); margin-top: 0; }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab:hover { background-color: #e2e8f0; color: var(--text-main); }
        .tab.active {
            background-color: var(--header-bg);
            color: var(--header-text);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Forms --- */
        #serverForm {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            background: var(--bg-card);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .form-group { margin-bottom: 0; }
        #serverForm label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9em; }
        #serverForm input[type="text"], #serverForm input[type="number"], #serverForm select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 6px; background-color: #fcfcfc; box-sizing: border-box;
        }
        #serverForm input:focus, #serverForm select:focus { border-color: var(--primary); outline: none; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 25px; }

        /* --- Buttons --- */
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;
            transition: all 0.2s; font-weight: 600; text-decoration: none;
            display: inline-flex; align-items: center; justify-content: center; font-size: 0.95rem;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #edf2f7; color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #e2e8f0; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-large { padding: 15px 30px; font-size: 1.1rem; width: 100%; }

        .form-actions {
            grid-column: 1 / -1; display: flex; justify-content: space-between;
            align-items: center; margin-top: 20px; padding-top: 20px;
            border-top: 1px solid var(--border-color); flex-wrap: wrap; gap: 15px;
        }

        /* --- Config Output --- */
        .config-output textarea {
            width: 100%; height: 150px; padding: 15px; border: 1px solid var(--border-color);
            border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.9rem;
            background-color: #2d3748; color: #a0aec0; resize: vertical; box-sizing: border-box;
        }

        /* --- Selected Mods Chips --- */
        #selectedModsContainer {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--primary);
            margin-bottom: 20px;
            display: none; /* Hidden by default until mods selected */
        }
        
        .mod-chips-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .mod-chip {
            display: inline-flex;
            align-items: center;
            background-color: #fffaf0;
            border: 1px solid var(--primary);
            color: #744210;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mod-chip:hover {
            background-color: var(--primary);
            color: white;
        }

        .mod-chip .remove-x {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            opacity: 0.6;
        }
        .mod-chip .remove-x:hover { opacity: 1; }

        /* --- Mod Grid --- */
        .mod-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 15px;
            padding: 10px 0;
        }

        .mod-card {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 8px; overflow: hidden; transition: all 0.2s ease-in-out;
            cursor: pointer; position: relative; display: flex; flex-direction: column; height: 100%;
        }
        .mod-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
        .mod-card.selected { border: 2px solid var(--primary); background-color: #fffaf0; }
        .mod-card.selected::after {
            content: "‚úì"; position: absolute; top: 5px; right: 5px; background: var(--primary);
            color: white; width: 22px; height: 22px; border-radius: 50%; text-align: center;
            line-height: 22px; font-weight: bold; font-size: 12px; z-index: 2;
        }
		/* Hide the default checkbox input so only the custom checkmark shows */
		.mod-card input[type="checkbox"] {
		    display: none !important;
		}

        .mod-image-container { width: 100%; height: 110px; background-color: #edf2f7; position: relative; overflow: hidden; }
        .mod-image { width: 100%; height: 100%; object-fit: cover; }
        .mod-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2.5em; font-weight: 700; color: #cbd5e0; }

        .mod-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
        .mod-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; line-height: 1.3; }
        .mod-summary { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }
        
        /* --- Mutator Grid (Updated for Stability) --- */
        .mutator-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .mutator-group h3 {
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .mutator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .mutator-item {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .mutator-item:hover {
            border-color: var(--primary);
            background: #fdfdfd;
        }

        .mutator-item.active {
            border-color: var(--primary);
            background-color: #fffaf0;
            font-weight: 600;
        }

        .mutator-item input { margin-right: 10px; cursor: pointer; }
        .mutator-item label { cursor: pointer; font-size: 0.9rem; }
		/* --- Custom Mutator Styles --- */
		.mutator-item.custom-mutator {
		    background-color: #f3f6ff; /* Light blue tint to distinguish */
		    border-color: #b3c7f7;
		}
		
		.mutator-item.custom-mutator:hover {
		    background-color: #e6eeff;
		    border-color: #4a90e2;
		}
		
		.mutator-item.custom-mutator.active {
		    background-color: #ebf8ff; /* Slightly different active state */
		    border-color: var(--primary);
		}
		
		/* Delete Button (X) */
		.mutator-delete-btn {
		    margin-left: auto; /* Pushes button to the far right */
		    background: transparent;
		    border: none;
		    color: #e53e3e; /* Red */
		    cursor: pointer;
		    font-size: 1.1rem;
		    line-height: 1;
		    padding: 4px 8px;
		    border-radius: 4px;
		    opacity: 0.6;
		    transition: all 0.2s;
		    display: flex;
		    align-items: center;
		}
		
		.mutator-delete-btn:hover {
		    opacity: 1;
		    background-color: rgba(229, 62, 62, 0.1);
		}
        
        .search-box { display: flex; margin-bottom: 20px; }
        .search-box input { flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px 0 0 6px; }
        .search-box button { border-radius: 0 6px 6px 0; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
        .close-modal:hover { color: #000; }

        /* Notification */
        .notification { position: fixed; bottom: 20px; right: 20px; background-color: var(--success); color: white; padding: 15px 20px; border-radius: 6px; opacity: 0; transition: opacity 0.5s; z-index: 3000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 600; }
        .notification.show { opacity: 1; }


		/* For Game.ini section */
		/* --- Game.ini Accordion Styles --- */
.ini-section {
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 10px;
    background: #fff;
    overflow: hidden;
}

.ini-header {
    background: #f7fafc;
    padding: 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    user-select: none;
    transition: background 0.2s;
}

.ini-header:hover {
    background: #edf2f7;
}

.ini-header::after {
    content: '+';
    font-size: 1.2em;
    font-weight: bold;
    color: var(--text-muted);
}

.ini-section.open .ini-header::after {
    content: '-';
}

.ini-body {
    display: none;
    padding: 20px;
    border-top: 1px solid var(--border-color);
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

/* Hidden by default, toggled by JS */
.ini-section .ini-body { display: none; }
.ini-section.open .ini-body { display: grid; }

.ini-input-group {
    margin-bottom: 0;
}

.ini-input-group label {
    display: block;
    font-size: 0.85em;
    font-weight: 600;
    margin-bottom: 4px;
    color: #4a5568;
}

.ini-desc {
    font-size: 0.75em;
    color: #718096;
    margin-top: 2px;
    line-height: 1.3;
}
		/* end Game.ini section */
		/* --- MapCycle Generator Styling --- */
.mc-controls select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: #fcfcfc;
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--text-main);
    margin-bottom: 15px; /* Adds spacing between the dropdown and the next label */
}

.mc-controls select:focus {
    border-color: var(--primary);
    outline: none;
}

.mc-controls label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    font-size: 0.9em;
}
				/* --- END MapCycle Generator Styling --- */
		/* --- Admin List Styles --- */
.admin-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f7fafc;
    padding: 8px 12px;
    margin-bottom: 6px;
    border-radius: 4px;
    border: 1px solid #edf2f7;
    font-size: 0.9em;
}

.admin-item-info {
    display: flex;
    flex-direction: column;
}

.admin-item-id {
    font-family: 'Consolas', monospace;
    font-weight: bold;
    color: #2d3748;
}

.admin-item-name {
    font-size: 0.85em;
    color: #718096;
}

.admin-remove-btn {
    background: none;
    border: none;
    color: #e53e3e;
    cursor: pointer;
    font-size: 1.2em;
    padding: 0 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.admin-remove-btn:hover {
    opacity: 1;
}
				/* --- END Admin List Styles --- */
    </style>
</head>
<body>
    <div class="container">
        <h1>Insurgency Sandstorm Server Setup</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'serverConfig')">Server Configuration</button>
            <button class="tab" onclick="openTab(event, 'mods')">Mods</button>
            <button class="tab" onclick="openTab(event, 'mutators')">Mutators</button>
			<button class="tab" onclick="openTab(event, 'gameIni')">Game.ini Helper</button>
			<button class="tab" onclick="openTab(event, 'mapCycle')">MapCycle Generator</button>
			<button class="tab" onclick="openTab(event, 'adminTab')">Admin List</button>
        </div>
        
        <div class="main-content">
            <!-- SERVER CONFIG TAB -->
            <div id="serverConfig" class="tab-content active">
                <div class="quick-start" style="margin-bottom: 20px;">
                     <button id="quickStartButton" class="btn btn-primary btn-large" onclick="quickStart()">
                        ‚ö° Quick Launch Random Map
                    </button>
                </div>
                
                <form id="serverForm">
                    <div class="form-group">
                        <label for="os">Operating System</label>
                        <select name="os" id="os">
                            <option value="windows">Windows</option>
                            <option value="linux">Linux</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="hostname">Server Name</label>
                        <input type="text" id="hostname" name="hostname" placeholder="Enter server name">
                    </div>
                    
                    <div class="form-group">
                        <label for="scenario">Scenario</label>
                        <select name="scenario" id="scenario">
                			<option value="Bab?Scenario=Scenario_Bab_Checkpoint_Insurgents">Bab Checkpoint Insurgents</option>
                			<option value="Bab?Scenario=Scenario_Bab_Checkpoint_Security">Bab Checkpoint Security</option>
                			<option value="Bab?Scenario=Scenario_Bab_Domination">Bab Domination</option>
                			<option value="Bab?Scenario=Scenario_Bab_Firefight_East">Bab Firefight East</option>
                			<option value="Bab?Scenario=Scenario_Bab_Outpost">Bab Outpost</option>
                			<option value="Bab?Scenario=Scenario_Bab_Push_Insurgents">Bab Push Insurgents</option>
                			<option value="Bab?Scenario=Scenario_Bab_Push_Security">Bab Push Security</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Ambush">Citadel Ambush</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Checkpoint_Insurgents">Citadel Checkpoint Insurgents</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Checkpoint_Security">Citadel Checkpoint Security</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Domination">Citadel Domination</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Firefight_East">Citadel Firefight East</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Outpost">Citadel Outpost</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Push_Insurgents">Citadel Push Insurgents</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Push_Security">Citadel Push Security</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Survival">Citadel Survival</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Defusal">Citadel Defusal</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Ambush">Crossing Ambush</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Checkpoint_Insurgents">Crossing Checkpoint Insurgents</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Checkpoint_Security">Crossing Checkpoint Security</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Domination">Crossing Domination</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Firefight_West">Crossing Firefight West</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Frontline">Crossing Frontline</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Outpost">Crossing Outpost</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Push_Insurgents">Crossing Push Insurgents</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Push_Security">Crossing Push Security</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Skirmish">Crossing Skirmish</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Team_Deathmatch">Crossing Team Deathmatch</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Ambush">Farmhouse Ambush</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Checkpoint_Insurgents">Farmhouse Checkpoint Insurgents</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Checkpoint_Security">Farmhouse Checkpoint Security</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Domination">Farmhouse Domination</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Firefight_East">Farmhouse Firefight East</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Firefight_West">Farmhouse Firefight West</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Frontline">Farmhouse Frontline</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Push_Insurgents">Farmhouse Push Insurgents</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Push_Security">Farmhouse Push Security</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Skirmish">Farmhouse Skirmish</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Survival">Farmhouse Survival</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Team_Deathmatch">Farmhouse Team Deathmatch</option>
                            <option value="Forest?Scenario=Scenario_Forest_Push_Insurgents">Forest Push Insurgents</option>
                            <option value="Forest?Scenario=Scenario_Forest_Push_Security">Forest Push Security</option>
                            <option value="Forest?Scenario=Scenario_Forest_Firefight_East">Forest Firefight East</option>
                            <option value="Forest?Scenario=Scenario_Forest_Firefight_West">Forest Firefight West</option>
                            <option value="Forest?Scenario=Scenario_Forest_Survival">Forest Survival</option>
                            <option value="Forest?Scenario=Scenario_Forest_Ambush">Forest Ambush</option>
                            <option value="Forest?Scenario=Scenario_Forest_FFA">Forest FFA</option>
                            <option value="Forest?Scenario=Scenario_Forest_Defusal">Forest Defusal</option>
                            <option value="Forest?Scenario=Scenario_Forest_TDM">Forest Team Deathmatch</option>
                            <option value="Forest?Scenario=Scenario_Forest_Domination">Forest Domination</option>
                            <option value="Forest?Scenario=Scenario_Forest_Frontline">Forest Frontline</option>
                            <option value="Forest?Scenario=Scenario_Forest_Skirmish">Forest Skirmish</option>
                            <option value="Forest?Scenario=Scenario_Forest_Checkpoint_Insurgents">Forest Checkpoint Insurgents</option>
                            <option value="Forest?Scenario=Scenario_Forest_Checkpoint_Security">Forest Checkpoint Security</option>
                            <option value="Forest?Scenario=Scenario_Forest_Outpost">Forest Outpost</option>
                			<option value=Gap?Scenario=Scenario_Gap_Ambush">Gap Ambush</option>
                			<option value=Gap?Scenario=Scenario_Gap_Checkpoint_Insurgents">Gap Checkpoint Insurgents</option>
                			<option value=Gap?Scenario=Scenario_Gap_Checkpoint_Security">Gap Checkpoint Security</option>
                			<option value=Gap?Scenario=Scenario_Gap_Domination">Gap Domination</option>
                			<option value=Gap?Scenario=Scenario_Gap_Firefight">Gap Firefight</option>
                			<option value=Gap?Scenario=Scenario_Gap_Frontline">Gap Frontline</option>
                			<option value=Gap?Scenario=Scenario_Gap_Outpost">Gap Outpost</option>
                			<option value=Gap?Scenario=Scenario_Gap_Push_Insurgents">Gap Push Insurgents</option>
                			<option value=Gap?Scenario=Scenario_Gap_Push_Security">Gap Push Security</option>
                			<option value=Gap?Scenario=Scenario_Gap_Survival">Gap Survival</option>
                			<option value=Gap?Scenario=Scenario_Gap_Defusal">Gap Defusal</option>
                			<option value="Town?Scenario=Scenario_Hideout_Ambush">Hideout Ambush</option>
                			<option value="Town?Scenario=Scenario_Hideout_Checkpoint_Insurgents">Hideout Checkpoint Insurgents</option>
                			<option value="Town?Scenario=Scenario_Hideout_Checkpoint_Security">Hideout Checkpoint Security</option>
                			<option value="Town?Scenario=Scenario_Hideout_Domination">Hideout Domination</option>
                			<option value="Town?Scenario=Scenario_Hideout_Firefight_East">Hideout Firefight East</option>
                			<option value="Town?Scenario=Scenario_Hideout_Firefight_West">Hideout Firefight West</option>
                			<option value="Town?Scenario=Scenario_Hideout_Frontline">Hideout Frontline</option>
                			<option value="Town?Scenario=Scenario_Hideout_Push_Insurgents">Hideout Push Insurgents</option>
                			<option value="Town?Scenario=Scenario_Hideout_Push_Security">Hideout Push Security</option>
                			<option value="Town?Scenario=Scenario_Hideout_Skirmish">Hideout Skirmish</option>
                			<option value="Town?Scenario=Scenario_Hideout_Survival">Hideout Survival</option>
                			<option value="Town?Scenario=Scenario_Hideout_Team_Deathmatch">Hideout Team Deathmatch</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Ambush">Hillside Ambush</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Checkpoint_Insurgents">Hillside Checkpoint Insurgents</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Checkpoint_Security">Hillside Checkpoint Security</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Domination">Hillside Domination</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Firefight_East">Hillside Firefight East</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Firefight_West">Hillside Firefight West</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Frontline">Hillside Frontline</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Outpost">Hillside Outpost</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Push_Insurgents">Hillside Push Insurgents</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Push_Security">Hillside Push Security (INS2014 layout)</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Skirmish">Hillside Skirmish</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Survival">Hillside Survival</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Team_Deathmatch">Hillside Team Deathmatch</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Push_Security">LastLight Push Security</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Checkpoint_Insurgents">LastLight Checkpoint Insurgents</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Checkpoint_Security">LastLight Checkpoint Security</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Domination">LastLight Domination</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Firefight">LastLight Firefight</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Ambush"LastLight >Ambush</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Survival">LastLight Survival</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Push_Insurgents">LastLight Push Insurgents</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Push_Security">LastLight Push Security</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Outpost">LastLight Outpost</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Defusal">LastLight Defusal</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Frontline">LastLight Frontline</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Team_Deathmatch">LastLight Team Deathmatch</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Ambush">Ministry Ambush</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Checkpoint_Insurgents">Ministry Checkpoint Insurgents</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Checkpoint_Security">Ministry Checkpoint Security</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Domination">Ministry Domination</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Firefight_A">Ministry Firefight</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Skirmish">Ministry Skirmish</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Team_Deathmatch">Ministry Team Deathmatch</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Checkpoint_Insurgents">Outskirts Checkpoint Insurgents</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Checkpoint_Security">Outskirts Checkpoint Security</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Firefight_East">Outskirts Firefight East</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Firefight_West">Outskirts Firefight West</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Frontline">Outskirts Frontline</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Push_Insurgents">Outskirts Push Insurgents</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Push_Security">Outskirts Push Security</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Skirmish">Outskirts Skirmish</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Team_Deathmatch">Outskirts Team Deathmatch</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Survival">Outskirts Survival</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Defusal">Outskirts Defusal</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Ambush">PowerPlant Ambush</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Checkpoint_Insurgents">PowerPlant Checkpoint Insurgents</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Checkpoint_Security">PowerPlant Checkpoint Security</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Domination">PowerPlant Domination</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Firefight_East">PowerPlant Firefight East</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Firefight_West">PowerPlant Firefight West</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Push_Insurgents">PowerPlant Push Insurgents</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Push_Security">PowerPlant Push Security</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Survival">PowerPlant Survival</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Frontline">PowerPlant Frontline</option>	
                			<option value="Precinct?Scenario=Scenario_Precinct_Ambush">Precinct Ambush</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Checkpoint_Insurgents">Precinct Checkpoint Insurgents</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Checkpoint_Security">Precinct Checkpoint Security</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Firefight_East">Precinct Firefight East</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Firefight_West">Precinct Firefight West</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Frontline">Precinct Frontline</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Push_Insurgents">Precinct Push Insurgents</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Push_Security">Precinct Push Security</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Skirmish">Precinct Skirmish</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Team_Deathmatch">Precinct Team Deathmatch</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Survival">Precinct Survival</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Defusal">Precinct Defusal</option>
                			<option value="Prison?Scenario=Scenario_Prison_Push_Security">Prison Push Security</option>
                			<option value="Prison?Scenario=Scenario_Prison_Checkpoint_Insurgents">Prison Checkpoint Insurgents</option>
                			<option value="Prison?Scenario=Scenario_Prison_Checkpoint_Security">Prison Checkpoint Security</option>
                			<option value="Prison?Scenario=Scenario_Prison_Domination">Prison Domination</option>
                			<option value="Prison?Scenario=Scenario_Prison_Firefight">Prison Firefight</option>
                			<option value="Prison?Scenario=Scenario_Prison_Ambush">Prison Ambush</option>
                			<option value="Prison?Scenario=Scenario_Prison_Survival">Prison Survival</option>
                			<option value="Prison?Scenario=Scenario_Prison_Push_Insurgents">Prison Push Insurgents</option>
                			<option value="Prison?Scenario=Scenario_Prison_Push_Security">Prison Push Security</option>
                			<option value="Prison?Scenario=Scenario_Prison_Defusal">Prison Defusal</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Push_Security">Refinery Push Security</option>    
                			<option value="Oilfield?Scenario=Scenario_Refinery_Ambush">Refinery Ambush</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Checkpoint_Insurgents">Refinery Checkpoint Insurgents</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Checkpoint_Security">Refinery Checkpoint Security</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Domination">Refinery Domination</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Firefight_West">Refinery Firefight West</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Frontline">Refinery Frontline</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Push_Insurgents">Refinery Push Insurgents</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Push_Security">Refinery Push Security</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Skirmish">Refinery Skirmish</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Survival">Refinery Survival</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Ambush">Summit Ambush</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Checkpoint_Insurgents">Summit Checkpoint Insurgents</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Checkpoint_Security">Summit Checkpoint Security</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Firefight_East">Summit Firefight East</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Firefight_West">Summit Firefight West</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Frontline">Summit Frontline</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Push_Insurgents">Summit Push Insurgents</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Push_Security">Summit Push Security</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Skirmish">Summit Skirmish</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Team_Deathmatch">Summit Team Deathmatch</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Survival">Summit Survival</option>
                			<option value="Tell?Scenario=Scenario_Tell_Ambush">Tell Ambush</option>
                			<option value="Tell?Scenario=Scenario_Tell_Checkpoint_Insurgents">Tell Checkpoint Insurgents</option>
                			<option value="Tell?Scenario=Scenario_Tell_Checkpoint_Security">Tell Checkpoint Security</option>
                			<option value="Tell?Scenario=Scenario_Tell_Domination">Tell Domination</option>
                			<option value="Tell?Scenario=Scenario_Tell_Firefight_East">Tell Firefight East</option>
                			<option value="Tell?Scenario=Scenario_Tell_Firefight_West">Tell Firefight West</option>
                			<option value="Tell?Scenario=Scenario_Tell_Outpost">Tell Outpost</option>
                			<option value="Tell?Scenario=Scenario_Tell_Push_Insurgents">Tell Push Insurgents</option>
                			<option value="Tell?Scenario=Scenario_Tell_Push_Security">Tell Push Security</option>
                			<option value="Tell?Scenario=Scenario_Tell_Survival">Tell Survival</option>
                			<option value="Tell?Scenario=Scenario_Tell_Frontline">Tell Frontline</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Checkpoint_Insurgents">Tideway Checkpoint Insurgents</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Checkpoint_Security">Tideway Checkpoint Security</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Domination">Tideway Domination</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Firefight_West">Tideway Firefight West</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Frontline">Tideway Frontline</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Push_Insurgents">Tideway Push Insurgents</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Push_Security">Tideway Push Security</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Survival">Tideway Survival</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Push_Security">Trainyard Push Security</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Push_Insurgents">Trainyard Push Insurgents</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Firefight_West">Trainyard Firefight West</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Firefight_East">Trainyard Firefight East</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Domination_West">Trainyard Domination West</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Domination_East">Trainyard Domination East</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Frontline">Trainyard Frontline</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Ambush_East">Trainyard Ambush East</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Ambush_West">Trainyard Ambush West</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Defusal_West">Trainyard Defusal West</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Checkpoint_Security">Trainyard Checkpoint Security</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Checkpoint_Insurgents">Trainyard Checkpoint Insurgents</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Outpost">Trainyard Outpost</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Survival">Trainyard Survival</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="maxPlayers">Max Players</label>
                        <input type="number" id="maxPlayers" name="maxPlayers" placeholder="24" min="1" max="99" value="24">
                    </div>

                    <div class="form-group">
                        <label for="port">Game Port</label>
                        <input type="number" id="port" name="port" placeholder="27102" min="1" max="65535" value="27102">
                    </div>
                    
                    <div class="form-group">
                        <label for="queryPort">Query Port</label>
                        <input type="number" id="queryPort" name="queryPort" placeholder="27131" min="1" max="65535" value="27131">
                    </div>

                    <div class="form-group">
                        <label for="password">Password (Optional)</label>
                        <input type="text" id="password" name="password" placeholder="Server Password">
                    </div>

                    <div class="form-group">
                        <label for="gsltToken">GSLT Token</label>
                        <input type="text" id="gsltToken" name="gsltToken" placeholder="Steam GSLT Token">
                    </div>

                    <div class="form-group">
                        <label for="gameStatsToken">GameStats Token</label>
                        <input type="text" id="gameStatsToken" name="gameStatsToken" placeholder="GameStats Token">
                    </div>

					<!-- Checkboxes Full Row -->
					<div style="grid-column: 1 / -1; display:flex; gap: 20px; flex-wrap:wrap;">
					    <div class="checkbox-wrapper">
					        <input type="checkbox" id="enableGameStats" name="enableGameStats">
					        <label for="enableGameStats" style="margin:0;">Enable GameStats</label>
					    </div>
					    <div class="checkbox-wrapper">
					        <input type="checkbox" id="officialRules" name="officialRules">
					        <label for="officialRules" style="margin:0;">Use Official Rules</label>
					    </div>
					    <div class="checkbox-wrapper">
					        <input type="checkbox" id="enableCheats" name="enableCheats">
					        <label for="enableCheats" style="margin:0;">Enable Cheats</label>
					    </div>
					    <!-- NEW NoEAC Checkbox -->
					    <div class="checkbox-wrapper">
					        <input type="checkbox" id="noEAC" name="noEAC">
					        <label for="noEAC" style="margin:0;">Disable EAC <abbr title="Disables Easy Anti-Cheat. XP is still enabled.">?</abbr></label>
					    </div>
					</div>

                    <div class="form-actions">
                        <a id="launchLink" href="#" class="btn btn-primary btn-large" role="button">üöÄ Launch Server</a>
                        <div style="display:flex; gap:10px;">
                            <button type="button" class="btn btn-secondary" onclick="generateConfig()">Generate Config</button>
                            <button type="button" class="btn btn-secondary" onclick="generateShareLink()">Share Link</button>
                        </div>
                    </div>
                </form>
                
                <div class="config-output">
                    <label for="configOutput" style="font-weight:bold; display:block; margin-bottom:5px;">Generated Config Parameters:</label>
                    <textarea id="configOutput" readonly></textarea>
                </div>
                
                <div id="presetsContainer">
                    <h2 style="font-size:1.2rem; border-bottom:1px solid #ddd; padding-bottom:5px;">Presets</h2>
                    <div id="presetButtons"></div>
                    <div class="preset-actions" style="margin-top:15px;">
                        <button type="button" class="btn btn-secondary" onclick="savePreset()">Save Current</button>
                        <button type="button" class="btn btn-secondary" onclick="exportPresets()">Export JSON</button>
                        <button type="button" class="btn btn-secondary" onclick="importPresets()">Import JSON</button>
                    </div>
                </div>
            </div>
            
            <!-- MODS TAB -->
            <div id="mods" class="tab-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2>Mod Selection</h2>
                </div>

                <!-- SELECTED MODS CHIPS (Top of page) -->
                <div id="selectedModsContainer">
                    <h3 style="font-size:1rem; margin-bottom:10px; color:#d3a03e;">Active Mods:</h3>
                    <div id="modChipsWrapper" class="mod-chips-wrapper">
                        <!-- Chips inserted here via JS -->
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="modSearch" placeholder="Search mods by Name, Summary, or ID..." onkeyup="searchMods()">
                    <button type="button" class="btn btn-secondary" onclick="openApiHelper()">üõ†Ô∏è Mod.io API Helper</button>
                </div>
                
                <div id="modCheckboxes">
                    <p style="text-align:center; padding:20px;">Loading mods list... Please wait.</p>
                </div>
            </div>

            <!-- MUTATORS TAB -->
            <div id="mutators" class="tab-content">
                <h2>Mutators</h2>
                <div class="info-box">Mutators change gameplay mechanics and rules.</div>
                
                <div class="search-box">
                    <input type="text" id="mutatorSearch" placeholder="Search mutators..." onkeyup="searchMutators()">
                </div>

                <!-- Structured Mutator Container -->
                <div id="mutatorContainer" class="mutator-container">
                    <!-- Enabled Group -->
                    <div class="mutator-group" id="enabledMutatorGroup" style="display:none;">
                        <h3>Enabled Mutators</h3>
                        <div id="enabledMutatorGrid" class="mutator-grid"></div>
                    </div>

                    <!-- Available Group -->
                    <div class="mutator-group">
                        <h3>Available Mutators</h3>
                        <div id="availableMutatorGrid" class="mutator-grid"></div>
                    </div>
                </div>
                
                <!-- Custom Mutator Input -->
                <div style="margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
                    <h3 style="font-size:1rem;">Add Custom Mutator</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="customMutatorInput" placeholder="Enter mutator name" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;">
                        <button type="button" class="btn btn-primary" onclick="addCustomMutator()">Add</button>
                    </div>
                </div>
		    </div>

			<!-- GAME.INI TAB -->
<div id="gameIni" class="tab-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>Game.ini Configuration</h2>
        <div style="display:flex; gap:10px;">
            <button type="button" class="btn btn-secondary" onclick="copyIniToClipboard()">Copy Text</button>
            <button type="button" class="btn btn-primary" onclick="downloadGameIniFile()">Download Game.ini</button>
        </div>
    </div>

    <div class="info-box" style="background:#e3f2fd; border-left:4px solid #2196F3; padding:15px; margin-bottom:20px;">
        <p style="margin:0;"><strong>How to use:</strong> Adjust the settings below. The text box at the bottom will update automatically. 
        When finished, download the file and place it in: <br>
        <code>Insurgency/Saved/Config/WindowsServer/Game.ini</code></p>
    </div>

    <!-- The form will be generated here by JavaScript -->
    <div id="iniFormContainer"></div>

    <div class="config-output" style="margin-top:20px;">
        <label for="iniOutput" style="font-weight:bold; display:block; margin-bottom:5px;">Generated Game.ini Content:</label>
        <textarea id="iniOutput" readonly style="height:300px; font-family:'Consolas', monospace; white-space:pre;"></textarea>
    </div>
</div>

			<!-- MAPCYCLE TAB -->
<div id="mapCycle" class="tab-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>MapCycle.txt Generator</h2>
        <div style="display:flex; gap:10px;">
            <button type="button" class="btn btn-secondary" onclick="copyMapCycle()">Copy Text</button>
            <button type="button" class="btn btn-primary" onclick="downloadMapCycle()">Download MapCycle.txt</button>
        </div>
    </div>

    <div class="mapcycle-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        
        <!-- LEFT: Controls -->
        <div class="mc-controls" style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
            <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">1. Filter & Add</h3>
            
            <div class="form-group">
                <label>Select Map</label>
                <select id="mcMapSelect">
                    <option value="All">All Maps</option>
                    <!-- Populated by JS -->
                </select>
            </div>

            <div class="form-group">
                <label>Select Game Mode</label>
                <select id="mcModeSelect">
                    <option value="All">All Game Modes</option>
                    <!-- Populated by JS -->
                </select>
            </div>

            <div class="form-group">
                <label>Lighting Preference</label>
                <select id="mcLightingSelect">
                    <option value="Day">Day Only</option>
                    <option value="Night">Night Only</option>
                    <option value="Both">Both (Day & Night)</option>
                </select>
            </div>

            <button type="button" class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="addScenariosToCycle()">
                + Add To List
            </button>
            
            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
                <label style="font-weight:bold; color:#e53e3e;">Manage List</label>
                <button type="button" class="btn btn-danger" style="width:100%; margin-top:5px;" onclick="clearMapCycle()">
                    Clear List
                </button>
            </div>
        </div>

        <!-- RIGHT: Output -->
        <div class="mc-output">
            <h3 style="margin-top:0;">2. Generated File Content</h3>
            <textarea id="mapCycleOutput" readonly style="width:100%; height:400px; font-family:'Consolas', monospace; white-space:pre; padding:10px; border:1px solid #ddd; border-radius:4px; background:#f8f9fa;"></textarea>
            <div style="font-size:0.85em; color:#666; margin-top:5px;">
                File location: <code>Insurgency/Config/Server/MapCycle.txt</code>
            </div>
        </div>
    </div>
</div>

			<!-- ADMIN LIST TAB -->
<div id="adminTab" class="tab-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>Admins.txt Generator</h2>
        <div style="display:flex; gap:10px;">
            <button type="button" class="btn btn-secondary" onclick="copyAdminList()">Copy Text</button>
            <button type="button" class="btn btn-primary" onclick="downloadAdminList()">Download Admins.txt</button>
        </div>
    </div>

    <div class="mapcycle-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        
        <!-- LEFT: Controls -->
        <div class="mc-controls" style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
            <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0;">Add New Admin</h3>
            
            <div class="info-box" style="margin-bottom: 15px; font-size: 0.9em;">
                Need a SteamID64? 
                <a href="https://steamdb.info/calculator/" target="_blank" style="color: var(--primary); font-weight: bold;">
                    Open SteamDB Calculator ‚Üó
                </a>
            </div>

            <div class="form-group">
                <label for="adminSteamID">SteamID64 (Required)</label>
                <input type="text" id="adminSteamID" placeholder="e.g. 76561198012345678">
            </div>

            <div class="form-group">
                <label for="adminName">Name (Optional, for your reference)</label>
                <input type="text" id="adminName" placeholder="e.g. MyFriendBob">
            </div>

            <button type="button" class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="addAdminUser()">
                + Add Admin
            </button>
            
            <!-- Visual List of Added Admins -->
            <div style="margin-top: 25px;">
                <label style="font-weight:bold; border-bottom: 1px solid #eee; display:block; padding-bottom:5px;">Current List:</label>
                <div id="adminVisualList" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                    <p style="color:#999; font-style:italic; text-align:center;">No admins added yet.</p>
                </div>
            </div>
        </div>

        <!-- RIGHT: Output -->
        <div class="mc-output">
            <h3 style="margin-top:0;">Generated File Content</h3>
            <textarea id="adminOutput" readonly style="width:100%; height:400px; font-family:'Consolas', monospace; white-space:pre; padding:10px; border:1px solid #ddd; border-radius:4px; background:#f8f9fa;"></textarea>
            <div style="font-size:0.85em; color:#666; margin-top:5px;">
                File location: <code>Insurgency/Config/Server/Admins.txt</code>
            </div>
        </div>
    </div>
</div>
        </div> 
    </div>

    <div id="notification" class="notification"></div>

<!-- Updated API Helper Modal -->
    <div id="apiHelperModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="closeApiHelper()">&times;</span>
            <h2>Mod.io API Token Helper</h2>
            
            <div style="font-size: 0.9em; line-height: 1.5; color: #444;">
                <p><strong>Step 1: Get your Token</strong><br>
                Go to <a href="https://mod.io/me/access" target="_blank" style="color:#d3a03e;">Mod.io API Access</a>. Create a "Read" token named "Sandstorm".</p>

                <div style="margin: 15px 0;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Step 2: Paste Token (Optional)</label>
                    <input type="text" id="apiTokenField" placeholder="Paste your API Token here..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;">
                    <p style="font-size:0.8em; color:#666; margin-top:5px;">
                        <em>Pasting here allows you to download a pre-made file. We do not store this.</em>
                    </p>
                </div>

                <p><strong>Step 3: Save to GameUserSettings.ini</strong><br>
                The file is located at:<br>
                <code style="background:#f4f4f4; padding:2px 5px; display:block; margin-top:5px; word-break:break-all;">
                    \sandstorm_server\Insurgency\Saved\Config\WindowsServer\GameUserSettings.ini
                </code>
                </p>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <button class="btn btn-secondary" onclick="closeApiHelper()">Cancel</button>
                <button class="btn btn-primary" onclick="downloadIniFile()">Download .ini File</button>
            </div>
        </div>
    </div>
    


    <script>
    // =========================================================================
    // == IMMEDIATE LAUNCH REDIRECT HANDLER (FOR DISCORD-FRIENDLY LINKS)      ==
    // =========================================================================
    // This code runs instantly. If it finds "action=launch" in the URL, it
    // takes over the page to launch the game and prevents the tool from loading.
(function() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');

        if (action === 'launch') {
            // 1. Get the parameter. The browser automatically DECODES it.
            // e.g., "Bab?Scenario=..."
            const serverParams = urlParams.get('params'); 

            if (serverParams) {
                // Display a user-friendly launching message
                document.body.innerHTML = `
                    <div style="font-family: 'Roboto', sans-serif; text-align: center; color: #333; background-color: #f0f2f5; height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div>
                             <h1>Launching Insurgency: Sandstorm...</h1>
                             <p>Your game should open shortly. If it doesn't, please ensure Steam is running.</p>
                             <p style="font-size: 0.8em; color: #666;">You can close this tab.</p>
                        </div>
                    </div>
                `;

                // 2. *** THE FIX IS HERE ***
                // We must RE-ENCODE the string before passing it to the steam:// protocol.
                // e.g., "Bab%3FScenario%3D..."
                const steamUrl = 'steam://rungameid/581330//' + encodeURIComponent(serverParams);
                
                // 3. Perform the redirect with the correctly encoded URL.
                window.location.href = steamUrl;

            } else {
                document.body.innerHTML = '<h1>Error: Launch parameters were not found in the link.</h1>';
            }
            // This error is thrown intentionally to stop the rest of the script (the tool UI) from running.
            throw new Error("Redirecting to Steam. Halting further script execution.");
        }
    } catch (e) {
        // We expect the "Halting" error, so we only log other unexpected errors.
        if (!e.message.startsWith("Redirecting to Steam")) {
            console.error("An error occurred in the redirect handler:", e);
        }
    }
})();
    // =========================================================================
    // == END OF REDIRECT HANDLER                                             ==
    // =========================================================================

        // Global variables
        let mods = [];
        let selectedMods = [];
        let customMutators = [];
        let selectedMutators = [];
		// Store the global mods array alphabetically once fetched/defined
		let sortedMods = [];
		

        let modMutatorSuggestions = {
          // Format: modId: { name, suggestedMutator, description, popularity }
          // Common mod-mutator relationships based on community knowledge
          "89591": { 
            name: "Shoot House", 
            suggestedMutator: "Competitive", 
            description: "Competitive mutator improves the training experience on this map",
            popularity: 0.85
          },
          "91912": { 
            name: "Wolf-land (Nightfall 1.7 Update)", 
            suggestedMutator: "Hardcore", 
            description: "Hardcore mutator enhances the nighttime atmosphere",
            popularity: 0.9
          },
          "92807": { 
            name: "M45A1 Wolfpack", 
            suggestedMutator: "FullyLoaded", 
            description: "Makes all weapons available including this mod",
            popularity: 0.75
          },
          
          // Add ISMC mod suggestions
          "150867": { 
            name: "ISMCmod", 
            suggestedMutator: "ISMC_Casual", 
            description: "ISMC_Casual is the recommended mutator for ISMCmod",
            popularity: 0.90
          },
          "1516914": { 
            name: "ISMC Resources", 
            suggestedMutator: "ISMC_Casual", 
            description: "ISMC_Casual is the recommended mutator for ISMC Resources",
            popularity: 0.95
          }
        };



        // Load custom mutators from local storage on page load
        function loadCustomMutators() {
          try {
            const savedMutators = localStorage.getItem('customMutators');
            if (savedMutators) {
              customMutators = JSON.parse(savedMutators);
              console.log('Loaded custom mutators:', customMutators);
            }
          } catch (error) {
            console.error('Error loading custom mutators:', error);
            customMutators = [];
          }
        }
        
        // Function to add custom mutator
        function addCustomMutator() {
          const mutatorInput = document.getElementById('customMutatorInput');
          const mutatorName = mutatorInput.value.trim();
          
          if (!mutatorName) {
            alert('Please enter a mutator name');
            return;
          }
          
          // Check if already in standard mutators
          const existingStandardMutator = mutators.find(m => m.name.toLowerCase() === mutatorName.toLowerCase());
          if (existingStandardMutator) {
            alert('This mutator already exists in the standard list');
            return;
          }
          
          // Check if already in custom mutators
          const existingCustomMutator = customMutators.find(m => m.name.toLowerCase() === mutatorName.toLowerCase());
          if (existingCustomMutator) {
            alert('This custom mutator has already been added');
            return;
          }
          
          // Add to custom mutators
          const newMutator = { name: mutatorName, description: 'Custom user-added mutator', isCustom: true };
          customMutators.push(newMutator);
          
          // Save to local storage
          localStorage.setItem('customMutators', JSON.stringify(customMutators));
          
          // Add to selected mutators
          if (!selectedMutators.includes(mutatorName)) {
            selectedMutators.push(mutatorName);
          }
          
          // Clear input
          mutatorInput.value = '';
          
          // Regenerate the mutator checkboxes to include the new custom mutator
          generateMutatorCheckboxes();
          
          // Log to GAS if mods are selected
          if (selectedMods && selectedMods.length > 0) {
            logCustomMutatorToGAS(mutatorName);
          }
        }

        function logSelectedCustomMutators() {
          // Only proceed if there are mods and custom mutators selected
          if (!selectedMods || selectedMods.length === 0) return;
          
          // Find which custom mutators are currently selected
          const selectedCustomMutatorNames = selectedMutators.filter(mutatorName => {
            // Check if this is a custom mutator (not in standard mutators list)
            return !mutators.some(m => m.name === mutatorName) && 
                   customMutators.some(m => m.name === mutatorName);
          });
          
          // Log each selected custom mutator
          if (selectedCustomMutatorNames.length > 0) {
            selectedCustomMutatorNames.forEach(mutatorName => {
              logCustomMutatorToGAS(mutatorName);
            });
          }
        }
        
        // Generate mutator checkboxes
function generateMutatorCheckboxes() {
    const enabledGroup = document.getElementById('enabledMutatorGroup');
    const enabledGrid = document.getElementById('enabledMutatorGrid');
    const availableGrid = document.getElementById('availableMutatorGrid');

    // Clear grids
    enabledGrid.innerHTML = '';
    availableGrid.innerHTML = '';

    const allMutators = [
        ...mutators.map(m => ({ ...m, isCustom: false })),
        ...customMutators.map(m => ({ ...m, isCustom: true }))
    ];

    let enabledCount = 0;

    allMutators.forEach(mutator => {
        const isSelected = selectedMutators.includes(mutator.name);
        
        // Create Item Container
        const item = document.createElement('div');
        // Add specific class if it's custom
        item.className = `mutator-item ${isSelected ? 'active' : ''} ${mutator.isCustom ? 'custom-mutator' : ''}`;
        
        // Hidden Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = mutator.name;
        checkbox.checked = isSelected;
        
        // Label
        const label = document.createElement('label');
        label.textContent = mutator.name;
        
        // Append elements
        item.appendChild(checkbox);
        item.appendChild(label);

        // --- NEW: Add Delete Button for Custom Mutators ---
        if (mutator.isCustom) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'mutator-delete-btn';
            deleteBtn.innerHTML = '&times;'; // HTML entity for multiplication X
            deleteBtn.title = 'Remove custom mutator';
            
            deleteBtn.onclick = function(e) {
                e.stopPropagation(); // Prevent clicking the row (selecting the mutator)
                if(confirm(`Remove custom mutator "${mutator.name}"?`)) {
                    deleteCustomMutator(mutator.name);
                }
            };
            item.appendChild(deleteBtn);
        }
        // --------------------------------------------------

        // Click Logic (Row Selection)
        item.onclick = function(e) {
            // Check if we clicked the actual checkbox or the delete button
            if (e.target !== checkbox && !e.target.classList.contains('mutator-delete-btn')) {
                checkbox.checked = !checkbox.checked;
            }
            
            // If we clicked delete button, stop here (handled by deleteBtn.onclick)
            if (e.target.classList.contains('mutator-delete-btn')) return;

            const name = checkbox.value;
            if (checkbox.checked) {
                if (!selectedMutators.includes(name)) selectedMutators.push(name);
            } else {
                const idx = selectedMutators.indexOf(name);
                if (idx > -1) selectedMutators.splice(idx, 1);
            }
            
            // Re-render to move items to correct group
            generateMutatorCheckboxes();
            generateConfig();
        };

        // Sort into groups
        if (isSelected) {
            enabledGrid.appendChild(item);
            enabledCount++;
        } else {
            availableGrid.appendChild(item);
        }
    });

    // Toggle visibility of Enabled Group
    enabledGroup.style.display = enabledCount > 0 ? 'block' : 'none';
}
function forceRegenerateMutators() {
  console.log("Forcing regeneration of mutator checkboxes");
  generateMutatorCheckboxes();
  alert("Mutator checkboxes have been regenerated.");
}

        
        // Function to delete custom mutator
        function deleteCustomMutator(mutatorName) {
          // Remove from customMutators array
          customMutators = customMutators.filter(m => m.name !== mutatorName);
          
          // Save updated list to local storage
          localStorage.setItem('customMutators', JSON.stringify(customMutators));
          
          // Remove from selectedMutators if present
          const index = selectedMutators.indexOf(mutatorName);
          if (index !== -1) {
            selectedMutators.splice(index, 1);
          }
          
          // Regenerate mutator checkboxes
          generateMutatorCheckboxes();
        }
        
        // Initialize custom mutators form
function initializeCustomMutators() {
  // First load any saved custom mutators
  loadCustomMutators();
  
  // Add the custom mutator input form
  const mutatorContainer = document.getElementById('mutatorCheckboxes');
  if (!mutatorContainer) {
    console.error("Mutator container not found!");
    return;
  }
  
  const customMutatorForm = document.createElement('div');
  customMutatorForm.className = 'custom-mutator-form';
  customMutatorForm.style.marginBottom = '20px';
  customMutatorForm.innerHTML = `
    <h3>Add Custom Mutator</h3>
    <div class="form-group" style="display: flex; gap: 10px;">
      <input type="text" id="customMutatorInput" placeholder="Enter custom mutator name" style="flex: 1;">
      <button type="button" class="btn btn-primary" onclick="addCustomMutator()">Add</button>
    </div>
  `;
  
  // Insert before the mutator checkboxes
  mutatorContainer.parentNode.insertBefore(customMutatorForm, mutatorContainer);
  
  // Generate mutator checkboxes (which will now include any loaded custom mutators)
  // This call is important to ensure mutators appear
  generateMutatorCheckboxes();
}

        function updateMutatorCheckboxes() {
            const checkboxes = document.querySelectorAll('#mutatorCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectedMutators.includes(checkbox.value);
            });
            generateConfig(); // Update link/config
        }

        function updateSelectedMutatorsDisplay() {
            const output = document.getElementById('selectedMutatorsOutput');
            if (selectedMutators.length === 0) {
                output.textContent = 'No mutators selected';
            } else {
                output.textContent = selectedMutators.join(', ');
            }
        }

        function searchMutators() {
            const searchTerm = document.getElementById('mutatorSearch').value.toLowerCase();
            const checkboxItems = document.querySelectorAll('#mutatorCheckboxes .checkbox-item');
            
            checkboxItems.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                const description = item.querySelector('.item-description').textContent.toLowerCase();
                
                if (label.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

// Add this function somewhere in your <script> block
function applyUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    console.log("Checking for URL parameters:", window.location.search);

    // Helper function to set value if param exists and element is found
    const setInputValue = (id, paramName) => {
        if (urlParams.has(paramName)) {
            const element = document.getElementById(id);
            if (element) {
                try {
                    element.value = decodeURIComponent(urlParams.get(paramName)); // Decode potential encoding
                    console.log(`Set ${id} from param '${paramName}' to: ${element.value}`);
                } catch (e) {
                    console.error(`Error decoding parameter ${paramName} for ${id}:`, e);
                    // Fallback to raw value if decoding fails
                    element.value = urlParams.get(paramName);
                }
            } else {
                console.warn(`Element with ID ${id} not found for param ${paramName}`);
            }
        }
    };

    // Helper function for checkboxes
    const setCheckboxValue = (id, paramName) => {
        if (urlParams.has(paramName)) {
            const element = document.getElementById(id);
            if (element) {
                // Treat 'true' or existence of param (with empty value) as checked
                const paramValue = urlParams.get(paramName).toLowerCase();
                element.checked = (paramValue === 'true' || paramValue === '');
                console.log(`Set ${id} checked state from param '${paramName}' to: ${element.checked}`);
            } else {
                console.warn(`Element with ID ${id} not found for param ${paramName}`);
            }
        }
    };

    // --- Apply to Standard Form Fields ---
    setInputValue('os', 'os');
    setInputValue('hostname', 'hostname');
    setInputValue('maxPlayers', 'maxPlayers');
    setInputValue('port', 'port');
    setInputValue('queryPort', 'queryPort');
    setInputValue('scenario', 'scenario');
    setInputValue('password', 'password');
    setInputValue('gameStatsToken', 'gameStatsToken');
    setInputValue('gsltToken', 'gsltToken');

    // --- Apply to Checkboxes ---
    setCheckboxValue('enableGameStats', 'enableGameStats');
    setCheckboxValue('officialRules', 'officialRules');
    setCheckboxValue('enableCheats', 'enableCheats');
	setCheckboxValue('noEAC', 'noEAC');
    // --- Handle Mods ---
    // Needs to run AFTER mods have been fetched and 'sortedMods' is populated
    if (urlParams.has('mods')) {
        const modIdsParam = urlParams.get('mods');
        if (modIdsParam && sortedMods.length > 0) { // Ensure mods are loaded
            const modIds = modIdsParam.split(',')
                                    .map(id => parseInt(id.trim()))
                                    .filter(id => !isNaN(id));
            console.log("Applying mod IDs from URL:", modIds);

            // Filter the fetched mods based on the IDs from the URL
            selectedMods = sortedMods.filter(mod => mod && modIds.includes(mod.id));
            console.log("Selected mods after URL processing:", selectedMods);

        } else if (modIdsParam === '') { // Handle empty mods param "?mods="
             selectedMods = [];
             console.log("Cleared mods due to empty URL parameter.");
        }
        // Update UI AFTER processing mods
        generateModCheckboxes(); // Regenerate to show selections correctly
        updateSelectedModsDisplay();
    } else {
        // If no 'mods' param, ensure initial mod UI state is correct (might be redundant if fetchMods already did this)
        // generateModCheckboxes(); // Usually called after fetchMods anyway
        // updateSelectedModsDisplay();
    }


    // --- Handle Mutators ---
    if (urlParams.has('mutators')) {
        const mutatorsParam = urlParams.get('mutators');
         if (mutatorsParam) {
            selectedMutators = mutatorsParam.split(',')
                                         .map(m => decodeURIComponent(m.trim())) // Decode mutator names
                                         .filter(m => m !== '');
            console.log("Applying mutators from URL:", selectedMutators);
         } else { // Handle empty mutators param "?mutators="
             selectedMutators = [];
             console.log("Cleared mutators due to empty URL parameter.");
         }
         // Update UI AFTER processing mutators
         generateMutatorCheckboxes(); // Regenerate checkboxes to reflect selection
         updateSelectedMutatorsDisplay();
    } else {
        // If no 'mutators' param, ensure initial mutator UI state is correct
        // generateMutatorCheckboxes(); // Usually called by initializeCustomMutators
        // updateSelectedMutatorsDisplay();
    }

    // --- Final UI Updates ---
    // Trigger generation of the config string based on prefilled values
    generateConfig();
    // Update suggestions based on potentially prefilled mods/mutators
    updateMutatorSuggestions();
    console.log("URL parameter application complete.");
}

// Modify your DOMContentLoaded listener to call applyUrlParameters appropriately
document.addEventListener('DOMContentLoaded', function() {
    // 1. Load Presets
    loadPresetsFromStorage();
    
    // 2. Initialize Custom Mutators logic
    loadCustomMutators(); // Load saved custom ones
    
    // 3. *** FIX: GENERATE MUTATOR LIST IMMEDIATELY ***
    generateMutatorCheckboxes(); 
    
    // 4. Initialize Suggestions
    initMutatorSuggestions();
    
    // 5. Setup Tab Clicks
    setupModTabBehavior();

    // 6. Fetch Mods & Apply URL Params
    fetchMods().then(() => {
        console.log("Mods fetched, applying params.");
        applyUrlParameters(); 
        updateMutatorSuggestions();
    }).catch(error => {
        console.error("Error fetching mods:", error);
        applyUrlParameters(); // Try applying params anyway
    });

    // 7. Listeners for Config Generation
    document.getElementById('serverForm').addEventListener('change', generateConfig);
    document.getElementById('serverForm').addEventListener('keyup', generateConfig);

    console.log("Initialization complete.");
});
        
// This code integrates with your Google App Script backend
// to fetch popular mutator suggestions based on collected data

function createInfoModal() {
  if (document.getElementById('suggestionInfoModal')) {
    // If the modal already exists, just return (we'll show it elsewhere)
    return;
  }
  
  const modalHTML = `
    <div id="suggestionInfoModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Mod-Based Mutator Suggestions</h2>
        <p>Many Insurgency: Sandstorm mods require specific mutators to be enabled to work correctly.</p>
        <p>This feature will automatically suggest appropriate mutators based on the mods you select.</p>
        
        <div class="suggestion-examples">
          <h3>Common Mod-Mutator Combinations:</h3>
          <ul>
            <li><strong>ISMC Mods</strong> ‚Üí Use with <code>ISMC_Casual</code> mutator</li>
            <li><strong>Shoot House</strong> ‚Üí Use with <code>Competitive</code> mutator</li>
            <li><strong>Night Maps</strong> ‚Üí Often work best with <code>Hardcore</code> mutator</li>
          </ul>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
          <label>
            <input type="checkbox" id="dontShowAgain"> Don't show this message again
          </label>
        </div>
        <button class="btn btn-primary" style="margin-top: 15px; float: right;" onclick="closeInfoModal()">Got it!</button>
      </div>
    </div>
  `;
  
  // Add some additional styling
  const modalStyle = document.createElement('style');
  modalStyle.textContent = `
    #suggestionInfoModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    #suggestionInfoModal .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    #suggestionInfoModal .close {
      position: absolute;
      top: 15px;
      right: 20px;
      cursor: pointer;
      font-size: 24px;
      color: #666;
    }
    
    #suggestionInfoModal .close:hover {
      color: #000;
    }
    
    .suggestion-examples {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
    }
    
    .suggestion-examples ul {
      padding-left: 20px;
    }
    
    .suggestion-examples li {
      margin-bottom: 8px;
    }
    
    .suggestion-examples code {
      background-color: #e9ecef;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  `;
  
  // Append the modal and styles to the document
  document.head.appendChild(modalStyle);
  const modalContainer = document.createElement('div');
  modalContainer.innerHTML = modalHTML;
  document.body.appendChild(modalContainer.firstElementChild);
  
  // Add event listener for close button
  document.querySelector('#suggestionInfoModal .close').addEventListener('click', closeInfoModal);
}


// Fix 3: Improve the notification system
function createNotificationElement() {
  if (document.getElementById('notification')) return;
  
  const notificationElement = document.createElement('div');
  notificationElement.id = 'notification';
  notificationElement.className = 'notification';
  notificationElement.style.position = 'fixed';
  notificationElement.style.bottom = '20px';
  notificationElement.style.right = '20px';
  notificationElement.style.backgroundColor = '#4CAF50';
  notificationElement.style.color = 'white';
  notificationElement.style.padding = '15px 20px';
  notificationElement.style.borderRadius = '4px';
  notificationElement.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
  notificationElement.style.zIndex = '1000';
  notificationElement.style.transition = 'opacity 0.5s ease';
  notificationElement.style.opacity = '0';
  
  document.body.appendChild(notificationElement);
}

// Fix 4: Create the suggestions container properly
function createSuggestionsContainer() {
  if (document.getElementById('mutatorSuggestions')) {
    console.log("Suggestions container already exists");
    return;
  }
  
  const modsTab = document.getElementById('mods');
  if (!modsTab) {
    console.error("Mods tab not found!");
    return;
  }
  
  const suggestionsContainer = document.createElement('div');
  suggestionsContainer.id = 'mutatorSuggestions';
  suggestionsContainer.className = 'mutator-suggestions';
  
  // Explicit styling to ensure visibility
  suggestionsContainer.style.marginTop = '20px';
  suggestionsContainer.style.padding = '15px';
  suggestionsContainer.style.backgroundColor = '#e3f2fd';
  suggestionsContainer.style.borderRadius = '4px';
  suggestionsContainer.style.borderLeft = '4px solid #2196F3';
  suggestionsContainer.style.display = 'none'; // Initially hidden until we have suggestions
  
  const suggestionsTitle = document.createElement('h3');
  suggestionsTitle.textContent = 'Suggested Mutators ';
  
  const refreshButton = document.createElement('button');
  refreshButton.id = 'refreshSuggestions';
  refreshButton.className = 'btn btn-secondary btn-sm';
  refreshButton.textContent = 'Refresh Suggestions';
  refreshButton.onclick = fetchMutatorSuggestionsFromGAS;
  
  suggestionsTitle.appendChild(refreshButton);
  suggestionsContainer.appendChild(suggestionsTitle);
  
  const suggestionsContent = document.createElement('div');
  suggestionsContent.id = 'suggestionsContent';
  suggestionsContainer.appendChild(suggestionsContent);
  
  // Find the best place to insert it
  const selectedModsOutput = document.getElementById('selectedModsOutput');
  if (selectedModsOutput && selectedModsOutput.parentNode) {
    selectedModsOutput.parentNode.insertBefore(suggestionsContainer, selectedModsOutput.nextSibling);
    console.log("Inserted suggestions container after selectedModsOutput");
  } else {
    // Fallback - add to the end of the mods tab
    modsTab.appendChild(suggestionsContainer);
    console.log("Appended suggestions container to mods tab");
  }
  
  console.log("Suggestions container created with ID:", suggestionsContainer.id);
}

// Fix 5: More reliable JSONP handling
function fetchMutatorSuggestionsFromGAS() {
  try {
    // Show loading state
    showNotification("Fetching mutator suggestions...", "info");
    
    // Clean URL without any redirects
    const gasUrl = "https://script.google.com/macros/s/AKfycbyNTg4bdelp719MfGOBZePkX64zrYuQe8y9uMTlHFcwIVuO1yTcKwic33amzMD66Dex/exec";
    
    // Generate a unique callback function name
    const callbackName = 'gasCallback_' + Math.floor(Math.random() * 1000000);
    
    // Build query params - include selected mods if any
    let queryParams = `?action=getSuggestions&callback=${callbackName}&t=${Date.now()}`;
    
    // Add selected mod IDs to query if available
    if (selectedMods && selectedMods.length > 0) {
      console.log("Selected mod IDs to send:", selectedMods.map(mod => mod.id));
      const modIds = selectedMods.map(mod => String(mod.id)).join(',');
      queryParams += `&mods=${modIds}`;
    }
    
    console.log("Fetching from GAS with URL:", gasUrl + queryParams);
    
    // Create a script element for JSONP
    const script = document.createElement('script');
    script.src = gasUrl + queryParams;
    
    // Define the callback function
    window[callbackName] = function(data) {
      // Clean up
      if (script.parentNode) {
        document.head.removeChild(script);
      }
      
      delete window[callbackName];
      
      // Process the data
      console.log("Received suggestions from GAS:", data);
      
      if (data && data.success) {
        if (data.suggestions && Object.keys(data.suggestions).length > 0) {
          // If we got actual suggestions, update our database
          console.log("Received new suggestions from GAS:", data.suggestions);
          Object.assign(modMutatorSuggestions, data.suggestions);
          showNotification("Mutator suggestions updated!", "success");
        } else {
          console.log("No new suggestions in GAS response. Using existing suggestions.");
          showNotification("Using local suggestions", "info");
        }
        
        // Log our current suggestions database
        console.log("Current modMutatorSuggestions:", modMutatorSuggestions);
        
        // Always update UI
        updateMutatorSuggestions();
      }
    };
    
    // Add the script to the document to start the request
    document.head.appendChild(script);
    
  } catch (error) {
    console.error("Error in fetchMutatorSuggestionsFromGAS:", error);
    showNotification("Error loading suggestions", "error");
    
    // Fallback to existing suggestions
    updateMutatorSuggestions();
  }
}
// Fix 6: Improved updateMutatorSuggestions function
// Update the display of mutator suggestions, attaching mod data to buttons
function updateMutatorSuggestions() {
    const suggestionsContainer = document.getElementById('mutatorSuggestions');
    const suggestionsContent = document.getElementById('suggestionsContent');

    if (!suggestionsContainer || !suggestionsContent) {
        console.error("Suggestions container or content element not found");
        return;
    }
    suggestionsContent.innerHTML = ''; // Clear previous

    if (!selectedMods || selectedMods.length === 0) {
        suggestionsContainer.style.display = 'none';
        return;
    }

    const relevantSuggestions = [];
    selectedMods.forEach(mod => {
        const modIdStr = String(mod.id);
        if (modMutatorSuggestions[modIdStr]) {
            relevantSuggestions.push({
                mod: mod, // Keep the whole mod object
                suggestion: modMutatorSuggestions[modIdStr]
            });
        }
    });

    if (relevantSuggestions.length === 0) {
        suggestionsContainer.style.display = 'none';
        return;
    }

    suggestionsContainer.style.display = 'block';
    suggestionsContent.innerHTML = `<p>Recommended mutators for your selected mods:</p>`;
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'suggestion-cards';
    cardsContainer.style.display = 'flex';
    cardsContainer.style.flexWrap = 'wrap';
    cardsContainer.style.gap = '15px';
    cardsContainer.style.marginTop = '10px';

    relevantSuggestions.forEach(item => {
        const mutatorName = item.suggestion.suggestedMutator;
        const isApplied = selectedMutators.includes(mutatorName);

        const suggestionBox = document.createElement('div');
        suggestionBox.className = 'suggestion-box';
        suggestionBox.innerHTML = `
            <div class="suggestion-mod-name">Mod: ${item.mod.name}</div>
            <div class="suggestion-mutator-name">Suggests: ${mutatorName}</div>
            <div class="suggestion-description">${item.suggestion.description || 'Recommended for this mod.'}</div>
        `;

        const applyButton = document.createElement('button');
        applyButton.dataset.mutatorName = mutatorName;
        applyButton.className = 'btn apply-suggestion';

        // --- NEW: Attach suggesting mod data to the button ---
        applyButton.suggestingModData = { // Store necessary mod info
             name: item.mod.name,
             summary: item.mod.summary || '' // Include summary if available
        };
        // --- END NEW ---

        if (isApplied) {
            applyButton.textContent = 'Applied';
            applyButton.classList.add('btn-success');
            applyButton.style.backgroundColor = '#28a745';
            applyButton.style.color = 'white';
        } else {
            applyButton.textContent = 'Apply This Mutator';
            applyButton.classList.add('btn-primary');
        }

        // --- MODIFIED: Pass the mod data in the onclick call ---
        applyButton.onclick = function() {
            // Pass mutator name, button element, and the attached mod data
            applyMutatorSuggestion(this.dataset.mutatorName, this, this.suggestingModData);
        };
        // --- END MODIFIED ---

        suggestionBox.appendChild(applyButton);
        cardsContainer.appendChild(suggestionBox);
    });

    suggestionsContent.appendChild(cardsContainer);
}

function showNotification(message, type = "info") {
  const notification = document.getElementById('notification');
  if (!notification) return;
  
  // Clear any existing timeout
  if (window.notificationTimeout) {
    clearTimeout(window.notificationTimeout);
  }
  
  // Set the message
  notification.textContent = message;
  notification.className = "notification show";
  
  // Set color based on type
  notification.style.backgroundColor = 
    type === "success" ? "#4CAF50" : 
    type === "error" ? "#F44336" : 
    type === "warning" ? "#FF9800" : "#2196F3";
  
  // Hide after 3 seconds
  window.notificationTimeout = setTimeout(() => {
    notification.className = "notification";
  }, 3000);
}

// Fix 8: Modal display functions
function showSuggestionInfoModal() {
  createInfoModal();
  
  // Only show if user hasn't dismissed it before
  if (localStorage.getItem('suggestionInfoDismissed') !== 'true') {
    const modal = document.getElementById('suggestionInfoModal');
    if (modal) {
      modal.style.display = 'block';
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.transition = 'opacity 0.3s ease';
        modal.style.opacity = '1';
      }, 50);
    }
  }
}
function checkSuggestionContainerVisibility() {
  const container = document.getElementById('mutatorSuggestions');
  if (!container) {
    console.error("Mutator suggestions container not found!");
    return;
  }
  
  console.log("Mutator suggestions container:", {
    display: container.style.display,
    visibility: window.getComputedStyle(container).visibility,
    height: window.getComputedStyle(container).height,
    element: container
  });
  
  // Force visibility
  container.style.removeProperty('display');
  container.style.display = 'block';
  container.style.visibility = 'visible';
  
  console.log("Forced visibility on container");
}
        
function closeInfoModal() {
  const modal = document.getElementById('suggestionInfoModal');
  if (modal) {
    // Animate the modal closing
    modal.style.transition = 'opacity 0.3s ease';
    modal.style.opacity = '0';
    
    // After animation completes, hide the modal
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
    
    // Check if "don't show again" is checked
    const dontShowAgain = document.getElementById('dontShowAgain');
    if (dontShowAgain && dontShowAgain.checked) {
      localStorage.setItem('suggestionInfoDismissed', 'true');
    }
  }
}

// Fix 9: Function to apply a suggested mutator
// Apply a suggested mutator - MODIFIED to use suggesting mod info for new descriptions
function applyMutatorSuggestion(mutatorName, buttonElement, suggestingMod) { // Added suggestingMod parameter
    const isAlreadyApplied = selectedMutators.includes(mutatorName);

    if (isAlreadyApplied) {
        // Deselect logic (optional, as implemented before)
        const index = selectedMutators.indexOf(mutatorName);
        if (index !== -1) {
            selectedMutators.splice(index, 1);
        }
        buttonElement.textContent = 'Apply This Mutator';
        buttonElement.classList.remove('btn-success');
        buttonElement.style.backgroundColor = '';
        buttonElement.classList.add('btn-primary');
        showNotification(`Deselected mutator: ${mutatorName}`, "info");

    } else {
        // Apply the mutator
        const isStandard = mutators.some(m => m.name === mutatorName);
        const isCustom = customMutators.some(m => m.name === mutatorName);

        // --- MODIFIED: Create specific description if adding a new custom mutator ---
        if (!isStandard && !isCustom) {
            let newDescription = 'Added via suggestion'; // Default fallback
            if (suggestingMod && suggestingMod.name) {
                 newDescription = `Suggested for mod: ${suggestingMod.name}`;
                 // Optional: Add summary if you want it too
                 // if (suggestingMod.summary) {
                 //     newDescription += ` (${suggestingMod.summary})`;
                 // }
            }

            const newMutator = {
                name: mutatorName,
                description: newDescription, // Use the specific description
                isCustom: true
            };
            customMutators.push(newMutator);
            localStorage.setItem('customMutators', JSON.stringify(customMutators));
            console.log(`Added new custom mutator '${mutatorName}' with description: ${newDescription}`);
        }
        // --- END MODIFIED ---

        // Add to selected list if not already there
        if (!selectedMutators.includes(mutatorName)) {
            selectedMutators.push(mutatorName);
        }

        // Update the button state
        buttonElement.textContent = 'Applied';
        buttonElement.classList.remove('btn-primary');
        buttonElement.classList.add('btn-success');
        buttonElement.style.backgroundColor = '#28a745';
        buttonElement.style.color = 'white';

        showNotification(`Applied mutator: ${mutatorName}`, "success");
        logMutatorSelection(mutatorName); // Log if needed
    }

    // Update the underlying data and regenerate lists
    updateSelectedMutatorsDisplay();
    generateMutatorCheckboxes(); // Regenerate checkbox list on Mutators tab
}

// Fix 10: Initialize everything properly
function initMutatorSuggestions() {
  // Create UI elements
  createNotificationElement();
  createInfoModal();
  createSuggestionsContainer();
  
  // Hook into mod selection changes
  // We need to extend the existing updateSelectedModsDisplay function
  if (window.updateSelectedModsDisplay) {
    const originalUpdateSelectedModsDisplay = window.updateSelectedModsDisplay;
    window.updateSelectedModsDisplay = function() {
      // Call original function
      originalUpdateSelectedModsDisplay.apply(this, arguments);
      
      // Then update mutator suggestions
      updateMutatorSuggestions();
      
      // If mods are selected and we haven't already fetched suggestions in this session
      if (selectedMods && selectedMods.length > 0 && !window.hasFetchedSuggestions) {
        fetchMutatorSuggestionsFromGAS();
        window.hasFetchedSuggestions = true;
      }
    };
  }
  
  // Add a global function for other scripts to access
  window.showSuggestionModal = showSuggestionInfoModal;
  window.closeSuggestionModal = closeInfoModal;
  
  // Show info modal after a short delay
  setTimeout(showSuggestionInfoModal, 1000);
  
  // Update suggestions initially with the built-in data
  updateMutatorSuggestions();
}


// 4. Function to log when a user applies a suggested mutator
function logMutatorSelection(mutatorName) {
  if (!selectedMods || selectedMods.length === 0) return;
  
  // Basic input validation
  if (!mutatorName || typeof mutatorName !== 'string' || mutatorName.length > 100) return;
  
  // Prepare data to send - limit what we collect
  const data = {
    timestamp: new Date().toISOString(),
    mutator: mutatorName,
    source: 'suggestion', // Indicate this was from a suggestion
    mods: selectedMods.map(mod => ({
      id: mod.id,
      name: mod.name.substring(0, 100) // Limit name length
    })).slice(0, 20) // Limit number of mods
  };
  
  // Add a nonce to prevent replay attacks
  const nonce = Math.random().toString(36).substring(2, 15);
  data.nonce = nonce;
  
  // Send data to GAS Web App
  fetch('https://script.google.com/macros/s/AKfycbyNTg4bdelp719MfGOBZePkX64zrYuQe8y9uMTlHFcwIVuO1yTcKwic33amzMD66Dex/exec', {
    method: 'POST',
    mode: 'no-cors', // Important for GAS web apps
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  }).catch(error => {
    console.error('Error logging mutator selection:', error);
    // Silently fail - don't interrupt user experience
  });
}
        
        // Mutators data
const mutators = [
    { name: 'AllYouCanEat', description: 'Start with 100 supply points.' },
    { name: 'AntiMaterielRiflesOnly', description: 'Only anti-materiel rifles are available along with normal equipment and explosives.' },
    { name: 'ArmsRace', description: 'Every two kills give a new weapon. A kill with the final weapon wins the round.' },
    { name: 'BoltActionsOnly', description: 'Only bolt-action rifles are available along with normal equipment and explosives.' },
    { name: 'Broke', description: 'Start with 0 supply points.' },
    { name: 'BudgetAntiquing', description: 'Normal equipment and explosives, but limited to old and inexpensive weapons.' },
    { name: 'BulletSponge', description: 'Health is increased.' },
    { name: 'ChadTeam666Night', description: 'Mutator featuring 100 supply points, melee and special enemies, and vampirism.' },
    { name: 'Competitive', description: 'Equipment is more expensive, rounds are shorter, and capturing objectives is faster.' },
    { name: 'CompetitiveLoadouts', description: 'Player classes are replaced with those from Competitive.' },
    { name: 'DesertEaglesOnly', description: 'Only Desert Eagle pistols are available along with normal equipment and explosives.' },
    { name: 'FastMovement', description: 'Move Faster.' },
    { name: 'Frenzy', description: 'Fight against AI enemies who only use melee attacks. Watch out for special enemies.' },
    { name: 'FullyLoaded', description: 'All weapons, equipment, and explosives in the game are available in the Loadout Menu.' },
    { name: 'GrenadeLaunchersOnly', description: 'Only Grenade Launchers are available.' },
    { name: 'Guerrillas', description: 'Start with 5 supply points.' },
    { name: 'Gunslingers', description: 'Kill the enemy more than they kill you with a big stinkin\' revolver. And explosives.' },
    { name: 'Hardcore', description: 'Mutator featuring slower movement speeds and longer capture times.' },
    { name: 'HeadshotOnly', description: 'Players only take damage when shot in the head.' },
    { name: 'HotPotato', description: 'A live fragmentation grenade is dropped on death.' },
    { name: 'LMGOnly', description: 'Only light machine guns are available along with normal equipment and explosives.' },
    { name: 'LockedAim', description: 'Weapons always point to the center of the screen.' },
    { name: 'MakarovsOnly', description: 'Makarovs are the only option.' },
    { name: 'NoAim', description: 'Aiming down sights is disabled.' },
    { name: 'NoDeathCam', description: 'Forces the death camera to be disabled for all players.' },
    { name: 'NoDrops', description: 'No scavenging allowed.' },
    { name: 'NoThirdPerson', description: 'The third person camera for spectator mode is disabled.' },
    { name: 'OfficialRules', description: 'All gamemodes are forced to default rules.' },
    { name: 'PistolsOnly', description: 'Only pistols are available along with normal equipment and explosives.' },
    { name: 'Poor', description: 'Start with limited supply.' },
    { name: 'ShotgunsOnly', description: 'Only Shotguns are available along with normal equipment and explosives.' },
    { name: 'SlowCaptureTimes', description: 'Objectives will take longer to capture.' },
    { name: 'SlowMovement', description: 'Move slower.' },
    { name: 'SmallFirefight', description: 'Adjusts Firefight to suit a smaller player count by adjusting round count, round timer, and capture times.' },
    { name: 'SoldierOfFortune', description: 'Gain supply points as your score increases.' },
    { name: 'SpecialOperations', description: 'Start with 30 supply points.' },
    { name: 'Strapped', description: 'Start with 1 supply point.' },
    { name: 'TacticalVoiceChat', description: 'Allows dead players to speak to the living, disables proximity chat to the enemy.' },
    { name: 'TieBreaker', description: 'In Firefight, enable overtime and replaying rounds in the event of a draw.' },
    { name: 'Ultralethal', description: 'Everyone dies with one shot.' },
    { name: 'Vampirism', description: 'Receive health when dealing damage to enemies equal to the amount of damage dealt.' },
    { name: 'Warlords', description: 'Start with 10 supply points.' },
    { name: 'Welrods', description: 'Every player is forced to use the bolt-action Welrod pistol.' },
    { name: 'WelrodsOnly', description: 'Only bolt-action Welrod pistols are available along with normal equipment and explosives.' }
];
        
        function logCustomMutatorToGAS(mutatorName) {
          // Only send if user has mods selected
          if (!selectedMods || selectedMods.length === 0) return;
          
          // Basic input validation
          if (!mutatorName || typeof mutatorName !== 'string' || mutatorName.length > 100) return;
          
          // Prepare data to send - limit what we collect
          const data = {
            timestamp: new Date().toISOString(),
            mutator: mutatorName,
            mods: selectedMods.map(mod => ({
              id: mod.id,
              name: mod.name.substring(0, 100) // Limit name length
            })).slice(0, 20) // Limit number of mods to prevent abuse
          };
          
          // Add a random delay to prevent timing attacks (50-200ms)
          const randomDelay = 50 + Math.floor(Math.random() * 150);
          setTimeout(() => {
            // Add a nonce to prevent replay attacks
            const nonce = Math.random().toString(36).substring(2, 15);
            data.nonce = nonce;
            
            // Rate limiting - check if we've sent too many requests recently
            const recentRequests = localStorage.getItem('recentGASRequests') || '[]';
            let requests = JSON.parse(recentRequests);
            const now = Date.now();
            
            // Keep only requests from the last minute
            requests = requests.filter(time => now - time < 60000);
            
            // If we've made more than 5 requests in the last minute, don't send another
            if (requests.length >= 5) {
              console.log('Rate limited: Too many requests to GAS');
              return;
            }
            
            // Add this request time
            requests.push(now);
            localStorage.setItem('recentGASRequests', JSON.stringify(requests));
            
            // Send data to GAS Web App (replace with your actual GAS URL)
            fetch('https://script.google.com/macros/s/AKfycbyNTg4bdelp719MfGOBZePkX64zrYuQe8y9uMTlHFcwIVuO1yTcKwic33amzMD66Dex/exec', {
              method: 'POST',
              mode: 'no-cors', // Important for GAS web apps
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            }).catch(error => {
              console.error('Error logging custom mutator:', error);
              // Silently fail - don't interrupt user experience
            });
          }, randomDelay);
        }

        // Tab switching
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;

            // Get all elements with class="tab-content" and hide them
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                // Remove the active class from all content divs
                tabcontent[i].classList.remove("active");
            }

            // Get all elements with class="tab" and remove the class "active"
            tablinks = document.getElementsByClassName("tab");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            // Get the specific tab content element to show
            const currentTabContent = document.getElementById(tabName);

            // Show the current tab content, and add an "active" class to it
            if (currentTabContent) {
                currentTabContent.style.display = "block";
                currentTabContent.classList.add("active");
            }

            // Add the "active" class to the button that opened the tab
            if (evt && evt.currentTarget) {
              evt.currentTarget.classList.add("active");
            }
        }

        // === MODIFIED/NEW SERVER CONFIGURATION FUNCTIONS ===
        
        /**
         * Generates the server configuration string for the text area
         * AND the steam:// launch URL for the launch link. This is now the
         * single source of truth for the server command line.
         */
function generateConfig() {
    const os = document.getElementById('os').value;
    const steamParamsString = getServerParamsString(); // Use the helper
    const launchLink = document.getElementById('launchLink');
    const baseCommand = os === "windows" ?
        "InsurgencyServer.exe" :
        "Insurgency/Binaries/Linux/InsurgencyServer-Linux-Shipping";
    
    // Update the text area
    document.getElementById('configOutput').value = `${baseCommand} ${steamParamsString}`;

    // Update the main "Launch Server" link
    if (launchLink) {
        const steamURL = `steam://rungameid/581330//${encodeURIComponent(steamParamsString)}`;
        launchLink.href = steamURL;
    }
}

        /**
         * The launchServer function is now removed, as the <a> tag handles launching.
         * This function remains to power the Quick Launch button.
         */
        function quickStart() {
            document.getElementById('hostname').value = 'My Insurgency Server';
            document.getElementById('maxPlayers').value = '24';
            document.getElementById('port').value = '27102';
            document.getElementById('queryPort').value = '27131';
            
            const scenarioDropdown = document.getElementById('scenario');
            const randomIndex = Math.floor(Math.random() * scenarioDropdown.options.length);
            scenarioDropdown.selectedIndex = randomIndex;
            
            // First, generate the config and update the link's href
            generateConfig();
            
            // Then, programmatically click the link to launch the game
            document.getElementById('launchLink').click();
        }
        
        // === END MODIFIED/NEW FUNCTIONS ===

        // Preset functions
function savePreset() {
    const presetName = prompt('Enter a name for the preset:');
    if (!presetName) return;
    
    const preset = {
        name: presetName,
        os: document.getElementById('os').value,
        hostname: document.getElementById('hostname').value,
        maxPlayers: document.getElementById('maxPlayers').value,
        port: document.getElementById('port').value,
        queryPort: document.getElementById('queryPort').value,
        scenario: document.getElementById('scenario').value,
        password: document.getElementById('password').value,
        enableCheats: document.getElementById('enableCheats').checked,
        noEAC: document.getElementById('noEAC').checked, // <--- Add this
        gameStatsToken: document.getElementById('gameStatsToken').value,
        gsltToken: document.getElementById('gsltToken').value,
        enableGameStats: document.getElementById('enableGameStats').checked,
        officialRules: document.getElementById('officialRules').checked,
        selectedMutators: [...selectedMutators],
        selectedMods: [...selectedMods]
    };
    
    let presets = JSON.parse(localStorage.getItem('presets') || '[]');
    presets.push(preset);
    localStorage.setItem('presets', JSON.stringify(presets));
    renderPresetButtons(presets);
}

        function loadPresetsFromStorage() {
            const presets = JSON.parse(localStorage.getItem('presets') || '[]');
            renderPresetButtons(presets);
        }

        function renderPresetButtons(presets) {
            const presetButtonsContainer = document.getElementById('presetButtons');
            presetButtonsContainer.innerHTML = '';
            
            presets.forEach((preset, index) => {
                const presetDiv = document.createElement('div');
                presetDiv.className = 'preset';

                const presetNameSpan = document.createElement('span');
                presetNameSpan.textContent = preset.name;

                const launchButton = document.createElement('button');
                launchButton.textContent = 'Launch';
                launchButton.className = 'btn btn-primary';
                launchButton.onclick = function() {
                    loadPreset(index);
                    // After loading, click the main launch link
                    document.getElementById('launchLink').click();
                };

                const renameButton = document.createElement('button');
                renameButton.textContent = 'Rename';
                renameButton.className = 'btn btn-secondary';
                renameButton.onclick = function() {
                    renamePreset(index);
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'btn btn-danger';
                deleteButton.onclick = function() {
                    deletePreset(index);
                };

                presetDiv.appendChild(presetNameSpan);
                presetDiv.appendChild(launchButton);
                presetDiv.appendChild(renameButton);
                presetDiv.appendChild(deleteButton);

                presetButtonsContainer.appendChild(presetDiv);
            });
        }

        function deletePreset(index) {
            const presets = JSON.parse(localStorage.getItem('presets') || '[]');
            presets.splice(index, 1);
            localStorage.setItem('presets', JSON.stringify(presets));
            renderPresetButtons(presets);
        }

        function renamePreset(index) {
            const presets = JSON.parse(localStorage.getItem('presets') || '[]');
            const newName = prompt('Enter a new name for the preset:', presets[index].name);
            if (newName) {
                presets[index].name = newName;
                localStorage.setItem('presets', JSON.stringify(presets));
                renderPresetButtons(presets);
            }
        }

function loadPreset(index) {
    const presets = JSON.parse(localStorage.getItem('presets') || '[]');
    const preset = presets[index];
    if (!preset) return;
    
    document.getElementById('os').value = preset.os;
    document.getElementById('hostname').value = preset.hostname;
    document.getElementById('maxPlayers').value = preset.maxPlayers;
    document.getElementById('port').value = preset.port;
    document.getElementById('queryPort').value = preset.queryPort;
    document.getElementById('scenario').value = preset.scenario;
    document.getElementById('password').value = preset.password;
    document.getElementById('enableCheats').checked = preset.enableCheats;
    // Handle older presets that might not have this property
    document.getElementById('noEAC').checked = preset.noEAC || false; // <--- Add this
    document.getElementById('gameStatsToken').value = preset.gameStatsToken;
    document.getElementById('gsltToken').value = preset.gsltToken;
    document.getElementById('enableGameStats').checked = preset.enableGameStats;
    document.getElementById('officialRules').checked = preset.officialRules;
    
    // Load saved mutators and mods
    selectedMutators = preset.selectedMutators || [];
    selectedMods = preset.selectedMods || [];
    
    updateMutatorCheckboxes();
    updateModCheckboxes();
    updateSelectedMutatorsDisplay();
    updateSelectedModsDisplay();
    generateConfig(); 
}
        function exportPresets() {
            const presets = JSON.parse(localStorage.getItem('presets') || '[]');
            const presetsJSON = JSON.stringify(presets, null, 2);
            const blob = new Blob([presetsJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'insurgency_server_presets.json';
            link.click();
        }

        function importPresets() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'application/json';
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const presetsJSON = e.target.result;
                        const presets = JSON.parse(presetsJSON);
                        localStorage.setItem('presets', JSON.stringify(presets));
                        renderPresetButtons(presets);
                        alert('Presets imported successfully!');
                    } catch (error) {
                        alert('Error importing presets: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            fileInput.click();
        }




        // Mod functions
		// Function to fetch mods and sort them immediately
        // Mod functions
        async function fetchMods() {
            try {
                // Add timestamp as query parameter to prevent caching
                const timestamp = new Date().getTime();
                // Ensure the URL is correct and accessible
                const response = await fetch(`https://extremelystiff.github.io/ISSL/mods.json?t=${timestamp}`);
                if (!response.ok) {
                    // More specific error for debugging
                    throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
                }

                let fetchedMods = await response.json();

                // --- Sort fetched mods alphabetically by name ---
                // Add safety check here too, just in case fetched data is inconsistent
                 sortedMods = fetchedMods.sort((a, b) => {
                     const nameA = (a && typeof a.name === 'string') ? a.name : '';
                     const nameB = (b && typeof b.name === 'string') ? b.name : '';
                     return nameA.localeCompare(nameB);
                 });
                // --- END ---

                generateModCheckboxes(); // Generate using the sorted list
                console.log('Fetched and sorted mods:', sortedMods);

            } catch (error) {
                // Log the specific error that occurred during fetch/parse
                console.error('Error fetching or parsing mods:', error);
                alert('Failed to fetch mods. Using default list. Please check console for errors.');

                // Fallback list
                let fallbackMods = [
                     { id: 81844, name: "Example Content", summary: "Example Content from mod kit." },
                     { id: 89591, name: "Shoot House", summary: "Shoot House" },
                     { id: 91912, name: "Wolf-land (Nightfall 1.7 Update)", summary: "Update 0.6 - Added Night Lighting Scenario, temporarily disabled Checkpoint, various cover tweaks" },
                     { id: 92807, name: "M45A1 Wolfpack", summary: "Black variant of the M45A1" }
                ];

                // --- MODIFIED: Sort fallback mods safely ---
                sortedMods = fallbackMods.sort((a, b) => {
                    // Safety checks: Ensure a/b are objects and a.name/b.name are strings
                    const nameA = (a && typeof a.name === 'string') ? a.name : '';
                    const nameB = (b && typeof b.name === 'string') ? b.name : '';
                    // Compare the safe names (defaults to '' if invalid)
                    return nameA.localeCompare(nameB);
                });
                // --- END MODIFIED ---

                console.log('Using fallback mods (sorted):', sortedMods);
                generateModCheckboxes(); // Generate using the sorted fallback list
            }
        }

		// Generate mod checkboxes using the pre-sorted 'sortedMods' list
function generateModCheckboxes() {
    const modCheckboxesContainer = document.getElementById('modCheckboxes');
    modCheckboxesContainer.innerHTML = ''; 

    if (!sortedMods || sortedMods.length === 0) {
        modCheckboxesContainer.innerHTML = '<p style="text-align:center">No mods available. Please click "Refresh Mods".</p>';
        return;
    }

    const enabledModsSection = document.createElement('div');
    enabledModsSection.id = 'enabledModsSection';
    const enabledGrid = document.createElement('div');
    enabledGrid.className = 'mod-grid';
    
    const availableModsSection = document.createElement('div');
    availableModsSection.id = 'availableModsSection';
    const availableGrid = document.createElement('div');
    availableGrid.className = 'mod-grid';

    let enabledCount = 0;
    let availableCount = 0;

    sortedMods.forEach(mod => {
        if (!mod || !mod.id) return;
        const isSelected = selectedMods.some(selectedMod => selectedMod.id === mod.id);

        const card = document.createElement('div');
        card.className = `mod-card mod-item ${isSelected ? 'selected' : ''}`;
        
        // Search Logic
        const rawName = (mod.name !== undefined && mod.name !== null) ? String(mod.name) : "Unknown Mod";
        const rawSummary = (mod.summary !== undefined && mod.summary !== null) ? String(mod.summary) : "";
        card.dataset.searchText = `${rawName.toLowerCase()} ${rawSummary.toLowerCase()} ${mod.id}`;

        // Image
        const imgContainer = document.createElement('div');
        imgContainer.className = 'mod-image-container';
        let imageUrl = null;
        if(mod.logo && mod.logo.thumb_320x180) imageUrl = mod.logo.thumb_320x180;
        else if(mod.logoUrl) imageUrl = mod.logoUrl;
        
        if (imageUrl) {
            const img = document.createElement('img');
            img.src = imageUrl;
            img.className = 'mod-image';
            img.loading = "lazy";
            imgContainer.appendChild(img);
        } else {
            const placeholder = document.createElement('div');
            placeholder.className = 'mod-placeholder';
            placeholder.textContent = rawName.charAt(0).toUpperCase();
            imgContainer.appendChild(placeholder);
        }
        card.appendChild(imgContainer);

        // Content
        const content = document.createElement('div');
        content.className = 'mod-content';
        const title = document.createElement('div');
        title.className = 'mod-title';
        title.textContent = rawName;
        const summary = document.createElement('div');
        summary.className = 'mod-summary';
        summary.textContent = rawSummary || 'No description available.';
        content.appendChild(title);
        content.appendChild(summary);
        
        if(mod.profileUrl) {
            const linkDiv = document.createElement('div');
            linkDiv.className = 'mod-links';
            const link = document.createElement('a');
            link.href = mod.profileUrl;
            link.target = "_blank";
            link.textContent = "View on Mod.io ‚Üó";
            link.onclick = (e) => e.stopPropagation();
            linkDiv.appendChild(link);
            content.appendChild(linkDiv);
        }
        card.appendChild(content);

        // Input
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = mod.id;
        checkbox.id = `mod-checkbox-${mod.id}`; // Critical for chip removal linkage
        checkbox.checked = isSelected;
        card.appendChild(checkbox);

        // Click Handler
        card.addEventListener('click', function() {
            checkbox.checked = !checkbox.checked;
            const modId = parseInt(checkbox.value);
            
            if (checkbox.checked) {
                card.classList.add('selected');
                const modToAdd = sortedMods.find(m => m.id === modId);
                if (modToAdd && !selectedMods.some(sm => sm.id === modId)) {
                    selectedMods.push(modToAdd);
                }
            } else {
                card.classList.remove('selected');
                selectedMods = selectedMods.filter(sm => sm.id !== modId);
            }
            updateSelectedModsDisplay();
            generateConfig(); 
        });

        if (isSelected) {
            enabledGrid.appendChild(card);
            enabledCount++;
        } else {
            availableGrid.appendChild(card);
            availableCount++;
        }
    });

    if (enabledCount > 0) {
        const enabledHeader = document.createElement('h3');
        enabledHeader.textContent = `Enabled Mods (${enabledCount})`;
        enabledModsSection.appendChild(enabledHeader);
        enabledModsSection.appendChild(enabledGrid);
        modCheckboxesContainer.appendChild(enabledModsSection);
    }

    if (availableCount > 0) {
        const availableHeader = document.createElement('h3');
        availableHeader.textContent = 'Available Mods';
        if (enabledCount > 0) availableHeader.style.marginTop = '30px';
        availableModsSection.appendChild(availableHeader);
        availableModsSection.appendChild(availableGrid);
        modCheckboxesContainer.appendChild(availableModsSection);
    }
}

        function updateModCheckboxes() {
            const checkboxes = document.querySelectorAll('#modCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const modId = parseInt(checkbox.value);
                checkbox.checked = selectedMods.some(mod => mod.id === modId);
            });
            generateConfig(); // Update link/config
        }

function updateSelectedModsDisplay() {
    const container = document.getElementById('selectedModsContainer');
    const wrapper = document.getElementById('modChipsWrapper');
    
    // Clear chips
    wrapper.innerHTML = '';

    if (selectedMods.length === 0) {
        container.style.display = 'none';
    } else {
        container.style.display = 'block';
        
        selectedMods.forEach(mod => {
            const chip = document.createElement('div');
            chip.className = 'mod-chip';
            chip.innerHTML = `
                ${mod.name} 
                <span class="remove-x" onclick="removeModFromList(${mod.id})">&times;</span>
            `;
            wrapper.appendChild(chip);
        });
    }

    // Trigger updates
    updateMutatorSuggestions();
    generateConfig();
}
function openApiHelper() {
    document.getElementById('apiHelperModal').style.display = 'block';
}

function closeApiHelper() {
    document.getElementById('apiHelperModal').style.display = 'none';
}

function downloadIniFile() {
    const token = document.getElementById('apiTokenField').value.trim();
    // Default config text
    const configContent = `[/Script/ModKit.ModIOClient]
bHasUserAcceptedTerms=True
AccessToken=${token || ''}`;

    // Create Blob
    const blob = new Blob([configContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    
    // Create temporary link and click it
    const a = document.createElement('a');
    a.href = url;
    a.download = 'GameUserSettings.ini';
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    closeApiHelper();
    
    showNotification("GameUserSettings.ini downloaded!", "success");
}

// Close modal if clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('apiHelperModal');
    if (event.target == modal) {
        closeApiHelper();
    }
}
// Helper to remove mod via the "X" button on the chip
function removeModFromList(modId) {
    // Remove from array
    selectedMods = selectedMods.filter(m => m.id !== modId);
    
    // Update visual state of checkboxes/cards
    const checkbox = document.getElementById(`mod-checkbox-${modId}`); // See generating function below
    if (checkbox) checkbox.checked = false;
    
    const card = document.querySelector(`.mod-card input[value="${modId}"]`)?.closest('.mod-card');
    if (card) card.classList.remove('selected');

    updateSelectedModsDisplay();
}

// REPLACE your existing searchMods function with this:
function searchMods() {
    const rawSearchTerm = document.getElementById('modSearch').value;
    const searchTerm = rawSearchTerm.toLowerCase().trim();
    
    // Select all mod cards
    const cards = document.querySelectorAll('.mod-card');

    cards.forEach(card => {
        // Retrieve the pre-compiled search string from the data attribute
        const searchData = card.dataset.searchText; 
        
        // If search is empty, show everything. 
        // If match found, show it. Otherwise hide.
        if (searchTerm === "" || (searchData && searchData.includes(searchTerm))) {
            card.style.display = 'flex'; // Restore flex display for cards
        } else {
            card.style.display = 'none';
        }
    });
}

        // GameStats token auto-check enableGameStats
        document.getElementById('gameStatsToken').addEventListener('input', function(e) {
            document.getElementById('enableGameStats').checked = !!e.target.value.trim();
            generateConfig(); // Update link/config
        });
        
        // Modio info
function setupModTabBehavior() {
    const tabButtons = document.querySelectorAll('.tab');
    tabButtons.forEach(button => {
        if (button.textContent.trim() === 'Mods') {
            button.addEventListener('click', function() {
                const modCheckboxesContainer = document.getElementById('modCheckboxes');
                if (!modCheckboxesContainer) return;

                // Only fetch if we haven't already
                if (!sortedMods || sortedMods.length === 0) {
                    modCheckboxesContainer.innerHTML = '<p style="text-align:center; padding:20px;">Loading mods list... Please wait.</p>';
                    fetchMods().then(() => {
                        generateModCheckboxes();
                    }).catch(err => {
                        modCheckboxesContainer.innerHTML = '<p style="text-align:center;">Failed to load mod list. Please refresh.</p>';
                    });
                } else {
                    // Just regenerate to be safe/responsive
                    generateModCheckboxes();
                }
                
                // *** REMOVED: checkAndShowApiSetupHelper(); *** 
                // This stops the old popup.
            });
        }
    });
}

        function checkAndShowApiSetupHelper() {
          const hasApiToken = localStorage.getItem('modioApiToken');
          if (!hasApiToken) {
            showApiSetupHelper();
          }
        }

        function ensureModListIsVisible() {
            console.log("Ensuring mod list is visible after modal close/action.");
            const modCheckboxesContainer = document.getElementById('modCheckboxes');
            if (!modCheckboxesContainer) {
                console.error("Mod checkboxes container not found in ensureModListIsVisible.");
                return;
            }
            if (sortedMods && sortedMods.length > 0) {
                generateModCheckboxes();
            } else {
                modCheckboxesContainer.innerHTML = '<p>Mod list could not be loaded. Please try refreshing the page.</p>';
                console.warn("ensureModListIsVisible: sortedMods data is missing.");
            }
        }

        function showApiSetupHelper() {
          if (document.getElementById('apiSetupModal')) {
            document.getElementById('apiSetupModal').style.display = 'block';
            return;
          }

          const modalHTML = `
            <div id="apiSetupModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
              <div class="modal-content" style="background-color: white; margin: 10% auto; padding: 20px; border-radius: 5px; width: 80%; max-width: 700px; position: relative;">
                <span class="close" style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 24px;">√ó</span>
                <h2>Mod.io API Setup (Optional for this Tool)</h2>
                <p><strong>Note:</strong> An API token is needed for your <strong>game server</strong> to use mods, but this tool can list mods without it.</p>
                <p>Follow these steps if you want to set up your server:</p>

                <div class="setup-steps">
                  <h3>Step 1: Get your API token</h3>
                  <ol>
                    <li>Create or sign in to your <a href="https://mod.io" target="_blank">Mod.io account</a></li>
                    <li>Click your username at the top right, then click "API Access" from the left navigation</li>
                    <li>Under "OAuth 2 Management", look for "Generate Access Token"</li>
                    <li>Enter a name for your token (e.g., "My Sandstorm Server") and set it to "Read" access</li>
                    <li>Click "Create Token" and copy the generated token</li>
                  </ol>

                  <h3>Step 2: Enter your API token (Optional Storage)</h3>
                   <p>You can paste your token here to generate the config snippet, but it's primarily needed in your server's INI file.</p>
                  <div class="form-group">
                    <input type="text" id="apiTokenInput" placeholder="Paste your API token here" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                  </div>

                  <h3>Step 3: Save to GameUserSettings.ini</h3>
                  <p>Your token <strong>must</strong> be saved in this file on your server:</p>
                  <code style="display: block; background: #f5f5f5; padding: 10px; margin: 10px 0; word-break: break-all;">
                    \\sandstorm_server\\Insurgency\\Saved\\Config\\WindowsServer\\GameUserSettings.ini
                  </code>

                  <div class="generated-config" style="background: #f0f0f0; padding: 15px; margin: 15px 0; border-left: 3px solid #3498db;">
                    <h4>Copy this text to your GameUserSettings.ini file:</h4>
                    <pre id="iniConfigOutput" style="white-space: pre-wrap; word-break: break-all;"></pre>
                    <button id="copyIniConfig" class="btn btn-primary">Copy to Clipboard</button>
                  </div>
                </div>

                <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: space-between;">
                  <button id="remindLaterButton" class="btn btn-secondary">Close Helper</button>
                  <button id="saveApiToken" class="btn btn-primary">Save Token Locally & Close</button>
                </div>
              </div>
            </div>
          `;

          const modalContainer = document.createElement('div');
          modalContainer.innerHTML = modalHTML;
          document.body.appendChild(modalContainer.firstElementChild);

          document.querySelector('#apiSetupModal .close').addEventListener('click', function() {
            document.getElementById('apiSetupModal').style.display = 'none';
            ensureModListIsVisible();
          });
          document.getElementById('remindLaterButton').addEventListener('click', function() {
              document.getElementById('apiSetupModal').style.display = 'none';
              ensureModListIsVisible();
          });
          document.getElementById('apiTokenInput').addEventListener('input', updateIniConfig);
          document.getElementById('saveApiToken').addEventListener('click', saveApiToken);
          document.getElementById('copyIniConfig').addEventListener('click', copyIniConfig);
          updateIniConfig();
        }

        function updateIniConfig() {
          const token = document.getElementById('apiTokenInput').value.trim();
          const iniConfig = `[/Script/ModKit.ModIOClient]
        bHasUserAcceptedTerms=True
        AccessToken=${token || 'YOUR_TOKEN_HERE'}`;
          document.getElementById('iniConfigOutput').textContent = iniConfig;
        }

        function copyIniConfig() {
          const configText = document.getElementById('iniConfigOutput').textContent;
          navigator.clipboard.writeText(configText).then(function() {
            showNotification('Configuration copied to clipboard!', 'success');
          }).catch(function(err) {
            console.error('Could not copy text: ', err);
            showNotification('Failed to copy. Please select and copy manually.', 'error');
          });
        }

        function saveApiToken() {
          const token = document.getElementById('apiTokenInput').value.trim();
          if (token) {
              localStorage.setItem('modioApiToken', token);
              showNotification('API token saved locally!', 'success');
          } else {
              localStorage.removeItem('modioApiToken');
              showNotification('Local API token cleared.', 'info');
          }
          document.getElementById('apiSetupModal').style.display = 'none';
          ensureModListIsVisible();
        }
        
function generateShareLink() {
    // 1. Get the current server parameters string from the form.
    // We can reuse the generateConfig logic to ensure it's always up-to-date.
    generateConfig(); 
    const steamParamsString = getServerParamsString(); // We will create this small helper function.

    // 2. URI-encode the entire parameter string so it can be safely passed in a URL.
    const encodedServerParams = encodeURIComponent(steamParamsString);

    // 3. Construct the base URL of the current page.
    const baseUrl = window.location.origin + window.location.pathname;
    
    // 4. Create the final shareable URL with the action and params.
    const shareUrl = `${baseUrl}?action=launch&params=${encodedServerParams}`;

    // 5. Copy the HTTPS link to the clipboard.
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(shareUrl).then(() => {
            showNotification('Shareable link for Discord copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy link automatically: ', err);
            prompt('Copy this shareable link:', shareUrl); // Fallback for errors
        });
    } else {
        // Fallback for non-secure contexts or older browsers
        prompt('Copy this shareable link:', shareUrl);
    }
}
/**
 * HELPER FUNCTION: Extracts the core logic for getting the server parameter string.
 * This avoids code duplication between generateConfig and generateShareLink.
 */
function getServerParamsString() {
    const hostname = document.getElementById('hostname').value || "My Insurgency Server";
    const maxPlayers = document.getElementById('maxPlayers').value || "24";
    const port = document.getElementById('port').value || "27102";
    const queryPort = document.getElementById('queryPort').value || "27131";
    const scenario = document.getElementById('scenario').value;
    const password = document.getElementById('password').value;
    const enableCheats = document.getElementById('enableCheats').checked;
    const gameStatsToken = document.getElementById('gameStatsToken').value;
    const gsltToken = document.getElementById('gsltToken').value;
    const enableGameStats = document.getElementById('enableGameStats').checked;
    const officialRules = document.getElementById('officialRules').checked;
    const noEAC = document.getElementById('noEAC').checked; // <--- NEW

    // 1. Build the initial Launch URL (Server Map string)
    let travelUrl = scenario;
    const travelUrlParams = [];
    travelUrlParams.push(`MaxPlayers=${maxPlayers}`);
    if (password) {
        travelUrlParams.push(`Password=${password}`);
    }
    if (travelUrlParams.length > 0) {
        travelUrl += '?' + travelUrlParams.join('?');
    }

    // 2. Build the Command Line Arguments
    const otherParams = [
        `-Port=${port}`,
        `-QueryPort=${queryPort}`,
        '-log',
        `-hostname="${hostname}"`
    ];
    
    if (enableCheats) otherParams.push("-EnableCheats");
    
    // NEW NoEAC Logic
    if (noEAC) otherParams.push("-NoEAC");

    if (gameStatsToken && enableGameStats) {
        otherParams.push(`-GameStatsToken=${gameStatsToken}`, "-GameStats");
    }
    if (gsltToken) otherParams.push(`-GSLTToken=${gsltToken}`);
    if (officialRules) otherParams.push("-ruleset=OfficialRules");
    
    if (selectedMutators.length > 0) {
        otherParams.push(`-Mutators=${selectedMutators.join(',')}`);
    }
    
    // --- Mods Logic ---
    if (selectedMods.length > 0) {
        const modIds = selectedMods.map(mod => mod.id).join(',');
        otherParams.push(`-mods`, `-CmdModList=${modIds}`);
        
        // Forces the server to reload the map after mods finish downloading
        otherParams.push(`-ModDownloadTravelTo=${scenario}`);
    }

    return `${travelUrl} ${otherParams.join(' ')}`;
}
    </script>
<script>
// ==========================================
// GAME.INI GENERATOR LOGIC + PERSISTENCE
// ==========================================

// Configuration Schema
const iniConfigData = [
    {
        title: "General Gameplay (INSGameMode)",
        section: "[/Script/Insurgency.INSGameMode]",
        fields: [
            { key: "bKillFeed", type: "bool", def: false, desc: "Is the kill feed enabled?" },
            { key: "bKillFeedSpectator", type: "bool", def: true, desc: "Kill feed for spectators/replays?" },
            { key: "bKillerInfo", type: "bool", def: true, desc: "Show killer info to victim?" },
            { key: "bKillerInfoRevealDistance", type: "bool", def: false, desc: "Reveal distance of kills?" },
            { key: "TeamKillLimit", type: "number", def: 3, desc: "Kicks after this many TKs" },
            { key: "TeamKillGrace", type: "number", def: 0.2, desc: "Grace timer between TK incidents" },
            { key: "TeamKillReduceTime", type: "number", def: 90, desc: "Seconds to reduce TK count by 1" },
            { key: "bDeadSay", type: "bool", def: false, desc: "Can alive see dead chat?" },
            { key: "bVoiceAllowDeadChat", type: "bool", def: false, desc: "Can alive hear dead voice?" },
            { key: "bVoiceEnemyHearsLocal", type: "bool", def: true, desc: "Can enemies hear proximity voice?" }
        ]
    },
    {
        title: "Multiplayer Rules (INSMultiplayerMode)",
        section: "[/Script/Insurgency.INSMultiplayerMode]",
        fields: [
            { key: "InitialSupply", type: "number", def: 15, desc: "Starting supply points" },
            { key: "MaximumSupply", type: "number", def: 15, desc: "Max supply earnable" },
            { key: "bAutoAssignTeams", type: "bool", def: true, desc: "Auto assign teams on connect" },
            { key: "bAllowFriendlyFire", type: "bool", def: true, desc: "Enable Friendly Fire" },
            { key: "FriendlyFireModifier", type: "number", def: 0.2, desc: "Damage modifier for FF" },
            { key: "FriendlyFireReflect", type: "number", def: 0, desc: "Damage reflected back to attacker" },
            { key: "bAutoBalanceTeams", type: "bool", def: true, desc: "Enable auto balance" },
            { key: "bMapVoting", type: "bool", def: true, desc: "Enable map voting at end of game" },
            { key: "IdleLimit", type: "number", def: 150, desc: "Seconds before kicking idle player" }
        ]
    },
    {
        title: "Voting System",
        section: "[/Script/Insurgency.TeamInfo]\nbVotingEnabled=True\nTeamVoteIssues=/Script/Insurgency.VoteIssueKick\n\n[/Script/Insurgency.VoteIssueKick]",
        fields: [
            { key: "MinimumPlayersRequired", type: "number", def: 3, desc: "Min players to start vote" },
            { key: "MinimumPlayerRatio", type: "number", def: 0.25, desc: "Ratio of team to start vote" },
            { key: "VotePassRatio", type: "number", def: 0.75, desc: "Ratio of Yes votes needed" },
            { key: "VoteTimeout", type: "number", def: 90, desc: "Cooldown between votes" },
            { key: "bCanTargetEnemies", type: "bool", def: false, desc: "Can vote kick enemies?" }
        ]
    },
    {
        title: "Mutator: Headshots Only",
        section: "[/Script/Insurgency.Mutator_HeadshotOnly]",
        fields: [
            { key: "bCheckMeleeDamage", type: "bool", def: false, desc: "Should melee be checked for headshots?" }
        ]
    },
    {
        title: "Mutator: Hot Potato",
        section: "[/Script/Insurgency.Mutator_HotPotato]",
        fields: [
            { key: "bIgnoreHeadshots", type: "bool", def: false, desc: "Don't drop grenade on headshot" },
            { key: "bBotsOnly", type: "bool", def: false, desc: "Only bots drop grenades" }
        ]
    },
    {
        title: "Mutator: Vampirism",
        section: "[/Script/Insurgency.Mutator_Vampirism]",
        fields: [
            { key: "bCountFriendlyFire", type: "bool", def: false, desc: "Gain health from Friendly Fire?" },
            { key: "MaxHealth", type: "number", def: 1000, desc: "Max health gain limit" }
        ]
    },
    {
        title: "Mutator: Arms Race",
        section: "[/Script/Insurgency.Mutator_ArmsRace]", 
        fields: [
            { key: "bItemsDrop", type: "bool", def: false, desc: "If players can drop items" },
            { key: "bEnablePickupItems", type: "bool", def: false, desc: "Allow pickup items on map" },
            { key: "PenaltyPoints", type: "number", def: 2, desc: "Points taken on penalty" }
        ]
    },
    {
        title: "Co-op Settings (INSCoopMode)",
        section: "[/Script/Insurgency.INSCoopMode]",
        fields: [
            { key: "AIDifficulty", type: "number", def: 0.5, desc: "AI Difficulty (0.0 - 1.0)" },
            { key: "FriendlyBotQuota", type: "number", def: 4, desc: "Number of friendly bots" },
            { key: "MinimumEnemies", type: "number", def: 6, desc: "Min enemy bots" },
            { key: "MaximumEnemies", type: "number", def: 12, desc: "Max enemy bots" }
        ]
    },
    {
        title: "Gamemode: Checkpoint",
        section: "[/Script/Insurgency.INSCheckpointGameMode]",
        fields: [
            { key: "DefendTimer", type: "number", def: 90, desc: "Counter-attack duration" },
            { key: "DefendTimerFinal", type: "number", def: 180, desc: "Final objective counter-attack duration" },
            { key: "RespawnDPR", type: "number", def: 0.1, desc: "Dead Player Ratio to respawn team" },
            { key: "RespawnDelay", type: "number", def: 20, desc: "Respawn delay in seconds" },
            { key: "CounterAttackRespawnDPR", type: "number", def: 0.2, desc: "DPR during counter-attack" },
            { key: "bForceSoloWaves", type: "bool", def: true, desc: "Enable local play reinforcement system" }
        ]
    },
    {
        title: "Gamemode: Survival",
        section: "[/Script/Insurgency.INSSurvivalGameMode]",
        fields: [
            { key: "NumWaves", type: "number", def: 7, desc: "Successful captures required" },
            { key: "bEnableExtractionObjective", type: "bool", def: true, desc: "Enable extraction sequence" },
            { key: "ExtractionObjectiveHoldTime", type: "number", def: 150, desc: "Hold time for extraction" },
            { key: "ObjectiveDefendDistance", type: "number", def: 2000, desc: "Bot defense radius" }
        ]
    },
    {
        title: "Gamemode: Outpost",
        section: "[/Script/Insurgency.INSOutpostGameMode]",
        fields: [
            { key: "NumWaves", type: "number", def: 7, desc: "Number of waves to survive" },
            { key: "WaveSurvivalSupplyAward", type: "number", def: 1, desc: "Supply given per wave" },
            { key: "PrepareTimer", type: "number", def: 45, desc: "Time between waves" },
            { key: "DefendTimer", type: "number", def: 120, desc: "Time for attack wave" }
        ]
    }
];

// --- Persistence Functions for Game.ini ---
function saveGameIniState() {
    const inputs = document.querySelectorAll('#iniFormContainer input, #iniFormContainer select');
    const data = {};
    inputs.forEach(input => {
        if(input.dataset.key) {
            data[input.dataset.key] = input.value;
        }
    });
    localStorage.setItem('issl_gameini_v1', JSON.stringify(data));
}

function loadGameIniState() {
    const stored = localStorage.getItem('issl_gameini_v1');
    if (!stored) return;
    try {
        const data = JSON.parse(stored);
        const inputs = document.querySelectorAll('#iniFormContainer input, #iniFormContainer select');
        inputs.forEach(input => {
            if (input.dataset.key && data[input.dataset.key] !== undefined) {
                input.value = data[input.dataset.key];
            }
        });
        generateIniOutput(); // Regenerate text area after loading
    } catch (e) { console.error("Error loading Game.ini", e); }
}

// Initialize the form
function initGameIniForm() {
    const container = document.getElementById('iniFormContainer');
    if(!container) return;
    container.innerHTML = '';

    iniConfigData.forEach((group, index) => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'ini-section';

        const header = document.createElement('div');
        header.className = 'ini-header';
        header.textContent = group.title;
        header.onclick = () => { sectionDiv.classList.toggle('open'); };

        const body = document.createElement('div');
        body.className = 'ini-body';

        group.fields.forEach(field => {
            const wrapper = document.createElement('div');
            wrapper.className = 'ini-input-group';

            const label = document.createElement('label');
            label.textContent = field.key;
            
            let input;
            if (field.type === 'bool') {
                input = document.createElement('select');
                const optTrue = document.createElement('option');
                optTrue.value = 'True'; optTrue.text = 'True';
                const optFalse = document.createElement('option');
                optFalse.value = 'False'; optFalse.text = 'False';
                input.add(optTrue); input.add(optFalse);
                input.value = field.def ? 'True' : 'False';
            } else {
                input = document.createElement('input');
                input.type = field.type === 'number' ? 'number' : 'text';
                input.value = field.def;
                if(field.type === 'number') input.step = "any";
            }

            input.dataset.section = index;
            input.dataset.key = field.key;

            // Listeners for updates AND saving
            input.addEventListener('change', generateIniOutput);
            input.addEventListener('input', generateIniOutput);
            input.addEventListener('change', saveGameIniState);
            input.addEventListener('input', saveGameIniState);

            const desc = document.createElement('div');
            desc.className = 'ini-desc';
            desc.textContent = field.desc;

            wrapper.appendChild(label);
            wrapper.appendChild(input);
            wrapper.appendChild(desc);
            body.appendChild(wrapper);
        });

        sectionDiv.appendChild(header);
        sectionDiv.appendChild(body);
        container.appendChild(sectionDiv);
    });

    // LOAD SAVED DATA IMMEDIATELY
    loadGameIniState();
    
    // Generate initial state
    generateIniOutput();
}

function generateIniOutput() {
    let output = "";
    const inputs = document.querySelectorAll('#iniFormContainer input, #iniFormContainer select');
    const sectionMap = {};

    inputs.forEach(input => {
        const sectionIdx = input.dataset.section;
        if (!sectionMap[sectionIdx]) sectionMap[sectionIdx] = [];
        sectionMap[sectionIdx].push(input);
    });

    Object.keys(sectionMap).forEach(idx => {
        const group = iniConfigData[idx];
        output += `${group.section}\n`;
        sectionMap[idx].forEach(input => {
            output += `${input.dataset.key}=${input.value}\n`;
        });
        output += "\n";
    });

    const outputEl = document.getElementById('iniOutput');
    if(outputEl) outputEl.value = output.trim();
}

function downloadGameIniFile() {
    const content = document.getElementById('iniOutput').value;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Game.ini';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function copyIniToClipboard() {
    const content = document.getElementById('iniOutput');
    content.select();
    document.execCommand('copy'); 
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(content.value).then(() => {
            showNotification('Game.ini content copied!', 'success');
        });
    } else {
        showNotification('Game.ini content copied!', 'success');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    initGameIniForm();
});
</script>
<script>
// ==========================================
// MAPCYCLE GENERATOR LOGIC + PERSISTENCE
// ==========================================

// 1. Data Source
const scenarioDatabase = [
    // Bab
    { map: "Bab", mode: "Checkpoint Insurgents", code: "Scenario_Bab_Checkpoint_Insurgents" },
    { map: "Bab", mode: "Checkpoint Security", code: "Scenario_Bab_Checkpoint_Security" },
    { map: "Bab", mode: "Domination", code: "Scenario_Bab_Domination" },
    { map: "Bab", mode: "Firefight East", code: "Scenario_Bab_Firefight_East" },
    { map: "Bab", mode: "Outpost", code: "Scenario_Bab_Outpost" },
    { map: "Bab", mode: "Push Insurgents", code: "Scenario_Bab_Push_Insurgents" },
    { map: "Bab", mode: "Push Security", code: "Scenario_Bab_Push_Security" },
    { map: "Bab", mode: "Ambush", code: "Scenario_Bab_Ambush" },
    { map: "Bab", mode: "Survival", code: "Scenario_Bab_Survival" },
    { map: "Bab", mode: "Defusal", code: "Scenario_Bab_Defusal" },

    // Crossing
    { map: "Crossing", mode: "Ambush", code: "Scenario_Crossing_Ambush" },
    { map: "Crossing", mode: "Checkpoint Insurgents", code: "Scenario_Crossing_Checkpoint_Insurgents" },
    { map: "Crossing", mode: "Checkpoint Security", code: "Scenario_Crossing_Checkpoint_Security" },
    { map: "Crossing", mode: "Domination", code: "Scenario_Crossing_Domination" },
    { map: "Crossing", mode: "Firefight West", code: "Scenario_Crossing_Firefight_West" },
    { map: "Crossing", mode: "Frontline", code: "Scenario_Crossing_Frontline" },
    { map: "Crossing", mode: "Outpost", code: "Scenario_Crossing_Outpost" },
    { map: "Crossing", mode: "Push Insurgents", code: "Scenario_Crossing_Push_Insurgents" },
    { map: "Crossing", mode: "Push Security", code: "Scenario_Crossing_Push_Security" },
    { map: "Crossing", mode: "Skirmish", code: "Scenario_Crossing_Skirmish" },
    { map: "Crossing", mode: "Team Deathmatch", code: "Scenario_Crossing_Team_Deathmatch" },
    { map: "Crossing", mode: "Defusal", code: "Scenario_Crossing_Defusal" },
    { map: "Crossing", mode: "FFA", code: "Scenario_Crossing_FFA" },

    // Farmhouse
    { map: "Farmhouse", mode: "Ambush", code: "Scenario_Farmhouse_Ambush" },
    { map: "Farmhouse", mode: "Checkpoint Insurgents", code: "Scenario_Farmhouse_Checkpoint_Insurgents" },
    { map: "Farmhouse", mode: "Checkpoint Security", code: "Scenario_Farmhouse_Checkpoint_Security" },
    { map: "Farmhouse", mode: "Domination", code: "Scenario_Farmhouse_Domination" },
    { map: "Farmhouse", mode: "Firefight East", code: "Scenario_Farmhouse_Firefight_East" },
    { map: "Farmhouse", mode: "Firefight West", code: "Scenario_Farmhouse_Firefight_West" },
    { map: "Farmhouse", mode: "Frontline", code: "Scenario_Farmhouse_Frontline" },
    { map: "Farmhouse", mode: "Push Insurgents", code: "Scenario_Farmhouse_Push_Insurgents" },
    { map: "Farmhouse", mode: "Push Security", code: "Scenario_Farmhouse_Push_Security" },
    { map: "Farmhouse", mode: "Skirmish", code: "Scenario_Farmhouse_Skirmish" },
    { map: "Farmhouse", mode: "Survival", code: "Scenario_Farmhouse_Survival" },
    { map: "Farmhouse", mode: "Team Deathmatch", code: "Scenario_Farmhouse_Team_Deathmatch" },
    { map: "Farmhouse", mode: "Outpost", code: "Scenario_Farmhouse_Outpost" },
    { map: "Farmhouse", mode: "Defusal", code: "Scenario_Farmhouse_Defusal" },

    // Hideout
    { map: "Hideout", mode: "Ambush", code: "Scenario_Hideout_Ambush" },
    { map: "Hideout", mode: "Checkpoint Insurgents", code: "Scenario_Hideout_Checkpoint_Insurgents" },
    { map: "Hideout", mode: "Checkpoint Security", code: "Scenario_Hideout_Checkpoint_Security" },
    { map: "Hideout", mode: "Domination", code: "Scenario_Hideout_Domination" },
    { map: "Hideout", mode: "Firefight East", code: "Scenario_Hideout_Firefight_East" },
    { map: "Hideout", mode: "Firefight West", code: "Scenario_Hideout_Firefight_West" },
    { map: "Hideout", mode: "Frontline", code: "Scenario_Hideout_Frontline" },
    { map: "Hideout", mode: "Push Insurgents", code: "Scenario_Hideout_Push_Insurgents" },
    { map: "Hideout", mode: "Push Security", code: "Scenario_Hideout_Push_Security" },
    { map: "Hideout", mode: "Skirmish", code: "Scenario_Hideout_Skirmish" },
    { map: "Hideout", mode: "Survival", code: "Scenario_Hideout_Survival" },
    { map: "Hideout", mode: "Team Deathmatch", code: "Scenario_Hideout_Team_Deathmatch" },
    { map: "Hideout", mode: "Outpost", code: "Scenario_Hideout_Outpost" },
    { map: "Hideout", mode: "Ambush East", code: "Scenario_Hideout_Ambush_East" },
    { map: "Hideout", mode: "Defusal", code: "Scenario_Hideout_Defusal" },

    // Hillside
    { map: "Hillside", mode: "Ambush", code: "Scenario_Hillside_Ambush" },
    { map: "Hillside", mode: "Checkpoint Insurgents", code: "Scenario_Hillside_Checkpoint_Insurgents" },
    { map: "Hillside", mode: "Checkpoint Security", code: "Scenario_Hillside_Checkpoint_Security" },
    { map: "Hillside", mode: "Domination", code: "Scenario_Hillside_Domination" },
    { map: "Hillside", mode: "Firefight East", code: "Scenario_Hillside_Firefight_East" },
    { map: "Hillside", mode: "Firefight West", code: "Scenario_Hillside_Firefight_West" },
    { map: "Hillside", mode: "Frontline", code: "Scenario_Hillside_Frontline" },
    { map: "Hillside", mode: "Outpost", code: "Scenario_Hillside_Outpost" },
    { map: "Hillside", mode: "Push Insurgents", code: "Scenario_Hillside_Push_Insurgents" },
    { map: "Hillside", mode: "Push Security", code: "Scenario_Hillside_Push_Security" },
    { map: "Hillside", mode: "Skirmish", code: "Scenario_Hillside_Skirmish" },
    { map: "Hillside", mode: "Survival", code: "Scenario_Hillside_Survival" },
    { map: "Hillside", mode: "Team Deathmatch", code: "Scenario_Hillside_Team_Deathmatch" },

    // Ministry
    { map: "Ministry", mode: "Ambush", code: "Scenario_Ministry_Ambush" },
    { map: "Ministry", mode: "Checkpoint Insurgents", code: "Scenario_Ministry_Checkpoint_Insurgents" },
    { map: "Ministry", mode: "Checkpoint Security", code: "Scenario_Ministry_Checkpoint_Security" },
    { map: "Ministry", mode: "Domination", code: "Scenario_Ministry_Domination" },
    { map: "Ministry", mode: "Firefight", code: "Scenario_Ministry_Firefight_A" },
    { map: "Ministry", mode: "Skirmish", code: "Scenario_Ministry_Skirmish" },
    { map: "Ministry", mode: "Team Deathmatch", code: "Scenario_Ministry_Team_Deathmatch" },
    { map: "Ministry", mode: "Outpost", code: "Scenario_Ministry_Outpost" },
    { map: "Ministry", mode: "Survival", code: "Scenario_Ministry_Survival" },
    { map: "Ministry", mode: "Defusal", code: "Scenario_Ministry_Defusal" },

    // Outskirts
    { map: "Outskirts", mode: "Checkpoint Insurgents", code: "Scenario_Outskirts_Checkpoint_Insurgents" },
    { map: "Outskirts", mode: "Checkpoint Security", code: "Scenario_Outskirts_Checkpoint_Security" },
    { map: "Outskirts", mode: "Firefight East", code: "Scenario_Outskirts_Firefight_East" },
    { map: "Outskirts", mode: "Firefight West", code: "Scenario_Outskirts_Firefight_West" },
    { map: "Outskirts", mode: "Frontline", code: "Scenario_Outskirts_Frontline" },
    { map: "Outskirts", mode: "Push Insurgents", code: "Scenario_Outskirts_Push_Insurgents" },
    { map: "Outskirts", mode: "Push Security", code: "Scenario_Outskirts_Push_Security" },
    { map: "Outskirts", mode: "Skirmish", code: "Scenario_Outskirts_Skirmish" },
    { map: "Outskirts", mode: "Team Deathmatch", code: "Scenario_Outskirts_Team_Deathmatch" },
    { map: "Outskirts", mode: "Survival", code: "Scenario_Outskirts_Survival" },
    { map: "Outskirts", mode: "Defusal", code: "Scenario_Outskirts_Defusal" },
    { map: "Outskirts", mode: "Domination", code: "Scenario_Outskirts_Domination" },
    { map: "Outskirts", mode: "Outpost", code: "Scenario_Outskirts_Outpost" },
    { map: "Outskirts", mode: "Ambush", code: "Scenario_Outskirts_Ambush" },
    { map: "Outskirts", mode: "Ambush East", code: "Scenario_Outskirts_Ambush_East" },

    // Precinct
    { map: "Precinct", mode: "Ambush", code: "Scenario_Precinct_Ambush" },
    { map: "Precinct", mode: "Checkpoint Insurgents", code: "Scenario_Precinct_Checkpoint_Insurgents" },
    { map: "Precinct", mode: "Checkpoint Security", code: "Scenario_Precinct_Checkpoint_Security" },
    { map: "Precinct", mode: "Firefight East", code: "Scenario_Precinct_Firefight_East" },
    { map: "Precinct", mode: "Firefight West", code: "Scenario_Precinct_Firefight_West" },
    { map: "Precinct", mode: "Frontline", code: "Scenario_Precinct_Frontline" },
    { map: "Precinct", mode: "Push Insurgents", code: "Scenario_Precinct_Push_Insurgents" },
    { map: "Precinct", mode: "Push Security", code: "Scenario_Precinct_Push_Security" },
    { map: "Precinct", mode: "Skirmish", code: "Scenario_Precinct_Skirmish" },
    { map: "Precinct", mode: "Team Deathmatch", code: "Scenario_Precinct_Team_Deathmatch" },
    { map: "Precinct", mode: "Survival", code: "Scenario_Precinct_Survival" },
    { map: "Precinct", mode: "Defusal", code: "Scenario_Precinct_Defusal" },
    { map: "Precinct", mode: "Domination West", code: "Scenario_Precinct_Domination_West" },
    { map: "Precinct", mode: "Domination East", code: "Scenario_Precinct_Domination_East" },
    { map: "Precinct", mode: "Outpost", code: "Scenario_Precinct_Outpost" },
    { map: "Precinct", mode: "Ambush East", code: "Scenario_Precinct_Ambush_East" },
    { map: "Precinct", mode: "FFA", code: "Scenario_Precinct_FFA" },

    // Refinery
    { map: "Refinery", mode: "Ambush", code: "Scenario_Refinery_Ambush" },
    { map: "Refinery", mode: "Checkpoint Insurgents", code: "Scenario_Refinery_Checkpoint_Insurgents" },
    { map: "Refinery", mode: "Checkpoint Security", code: "Scenario_Refinery_Checkpoint_Security" },
    { map: "Refinery", mode: "Firefight West", code: "Scenario_Refinery_Firefight_West" },
    { map: "Refinery", mode: "Frontline", code: "Scenario_Refinery_Frontline" },
    { map: "Refinery", mode: "Push Insurgents", code: "Scenario_Refinery_Push_Insurgents" },
    { map: "Refinery", mode: "Push Security", code: "Scenario_Refinery_Push_Security" },
    { map: "Refinery", mode: "Skirmish", code: "Scenario_Refinery_Skirmish" },
    { map: "Refinery", mode: "Team Deathmatch", code: "Scenario_Refinery_Team_Deathmatch" },
    { map: "Refinery", mode: "Survival", code: "Scenario_Refinery_Survival" },
    { map: "Refinery", mode: "Defusal", code: "Scenario_Refinery_Defusal" },
    { map: "Refinery", mode: "Domination", code: "Scenario_Refinery_Domination" },
    { map: "Refinery", mode: "Outpost", code: "Scenario_Refinery_Outpost" },

    // Summit
    { map: "Summit", mode: "Ambush West", code: "Scenario_Summit_Ambush_West" },
    { map: "Summit", mode: "Checkpoint Insurgents", code: "Scenario_Summit_Checkpoint_Insurgents" },
    { map: "Summit", mode: "Checkpoint Security", code: "Scenario_Summit_Checkpoint_Security" },
    { map: "Summit", mode: "Firefight East", code: "Scenario_Summit_Firefight_East" },
    { map: "Summit", mode: "Firefight West", code: "Scenario_Summit_Firefight_West" },
    { map: "Summit", mode: "Frontline", code: "Scenario_Summit_Frontline" },
    { map: "Summit", mode: "Push Insurgents", code: "Scenario_Summit_Push_Insurgents" },
    { map: "Summit", mode: "Push Security", code: "Scenario_Summit_Push_Security" },
    { map: "Summit", mode: "Skirmish", code: "Scenario_Summit_Skirmish" },
    { map: "Summit", mode: "Team Deathmatch", code: "Scenario_Summit_Team_Deathmatch" },
    { map: "Summit", mode: "Survival", code: "Scenario_Summit_Survival" },
    { map: "Summit", mode: "Domination", code: "Scenario_Summit_Domination" },
    { map: "Summit", mode: "Outpost", code: "Scenario_Summit_Outpost" },
    { map: "Summit", mode: "Ambush East", code: "Scenario_Summit_Ambush_East" },
    { map: "Summit", mode: "Defusal", code: "Scenario_Summit_Defusal" },

    // Power Plant
    { map: "PowerPlant", mode: "Ambush", code: "Scenario_Powerplant_Ambush" },
    { map: "PowerPlant", mode: "Checkpoint Insurgents", code: "Scenario_PowerPlant_Checkpoint_Insurgents" },
    { map: "PowerPlant", mode: "Checkpoint Security", code: "Scenario_PowerPlant_Checkpoint_Security" },
    { map: "PowerPlant", mode: "Domination", code: "Scenario_PowerPlant_Domination" },
    { map: "PowerPlant", mode: "Firefight East", code: "Scenario_PowerPlant_Firefight_East" },
    { map: "PowerPlant", mode: "Firefight West", code: "Scenario_PowerPlant_Firefight_West" },
    { map: "PowerPlant", mode: "Push Insurgents", code: "Scenario_PowerPlant_Push_Insurgents" },
    { map: "PowerPlant", mode: "Push Security", code: "Scenario_PowerPlant_Push_Security" },
    { map: "PowerPlant", mode: "Survival", code: "Scenario_PowerPlant_Survival" },
    { map: "PowerPlant", mode: "Frontline", code: "Scenario_PowerPlant_Frontline" },
    { map: "PowerPlant", mode: "Outpost", code: "Scenario_PowerPlant_Outpost" },
    { map: "PowerPlant", mode: "FFA", code: "Scenario_PowerPlant_FFA" },
    { map: "PowerPlant", mode: "Skirmish", code: "Scenario_PowerPlant_Skirmish" },

    // Tell
    { map: "Tell", mode: "Ambush West", code: "Scenario_Tell_Ambush_West" },
    { map: "Tell", mode: "Checkpoint Insurgents", code: "Scenario_Tell_Checkpoint_Insurgents" },
    { map: "Tell", mode: "Checkpoint Security", code: "Scenario_Tell_Checkpoint_Security" },
    { map: "Tell", mode: "Domination East", code: "Scenario_Tell_Domination_East" },
    { map: "Tell", mode: "Firefight East", code: "Scenario_Tell_Firefight_East" },
    { map: "Tell", mode: "Firefight West", code: "Scenario_Tell_Firefight_West" },
    { map: "Tell", mode: "Outpost", code: "Scenario_Tell_Outpost" },
    { map: "Tell", mode: "Push Insurgents", code: "Scenario_Tell_Push_Insurgents" },
    { map: "Tell", mode: "Push Security", code: "Scenario_Tell_Push_Security" },
    { map: "Tell", mode: "Survival", code: "Scenario_Tell_Survival" },
    { map: "Tell", mode: "Frontline", code: "Scenario_Tell_Frontline" },
    { map: "Tell", mode: "Ambush East", code: "Scenario_Tell_Ambush_East" },
    { map: "Tell", mode: "Defusal", code: "Scenario_Tell_Defusal" },
    { map: "Tell", mode: "FFA", code: "Scenario_Tell_FFA" },

    // Tideway
    { map: "Tideway", mode: "Checkpoint Insurgents", code: "Scenario_Tideway_Checkpoint_Insurgents" },
    { map: "Tideway", mode: "Checkpoint Security", code: "Scenario_Tideway_Checkpoint_Security" },
    { map: "Tideway", mode: "Domination", code: "Scenario_Tideway_Domination" },
    { map: "Tideway", mode: "Firefight West", code: "Scenario_Tideway_Firefight_West" },
    { map: "Tideway", mode: "Frontline", code: "Scenario_Tideway_Frontline" },
    { map: "Tideway", mode: "Push Insurgents", code: "Scenario_Tideway_Push_Insurgents" },
    { map: "Tideway", mode: "Push Security", code: "Scenario_Tideway_Push_Security" },
    { map: "Tideway", mode: "Survival", code: "Scenario_Tideway_Survival" },
    { map: "Tideway", mode: "Outpost", code: "Scenario_Tideway_Outpost" },
    { map: "Tideway", mode: "Ambush", code: "Scenario_Tideway_Ambush" },
    { map: "Tideway", mode: "Defusal", code: "Scenario_Tideway_Defusal" }
];

// 2. Global State for Map Cycle
let currentMapCycle = [];

// --- Persistence Functions for MapCycle ---
function saveMapCycleState() {
    localStorage.setItem('issl_mapcycle_v1', JSON.stringify(currentMapCycle));
}

function loadMapCycleState() {
    const stored = localStorage.getItem('issl_mapcycle_v1');
    if (!stored) return;
    try {
        currentMapCycle = JSON.parse(stored);
        updateMapCycleOutput();
    } catch (e) { console.error("Error loading MapCycle", e); }
}

// 3. Initialize Dropdowns
function initMapCycleUI() {
    const mapSelect = document.getElementById('mcMapSelect');
    const modeSelect = document.getElementById('mcModeSelect');
    if(!mapSelect || !modeSelect) return;

    // Get unique Maps
    const uniqueMaps = [...new Set(scenarioDatabase.map(s => s.map))].sort();
    uniqueMaps.forEach(map => {
        const opt = document.createElement('option');
        opt.value = map;
        opt.textContent = map;
        mapSelect.appendChild(opt);
    });

    // Get unique Modes
    const uniqueModes = [...new Set(scenarioDatabase.map(s => s.mode))].sort();
    uniqueModes.forEach(mode => {
        const opt = document.createElement('option');
        opt.value = mode;
        opt.textContent = mode;
        modeSelect.appendChild(opt);
    });
}

// 4. Logic: Add scenarios based on filters
function addScenariosToCycle() {
    const mapFilter = document.getElementById('mcMapSelect').value;
    const modeFilter = document.getElementById('mcModeSelect').value;
    const lighting = document.getElementById('mcLightingSelect').value;

    let matches = scenarioDatabase.filter(scenario => {
        const mapMatch = (mapFilter === "All") || (scenario.map === mapFilter);
        const modeMatch = (modeFilter === "All") || (scenario.mode === modeFilter);
        return mapMatch && modeMatch;
    });

    if(matches.length === 0) {
        showNotification("No scenarios found with those filters.", "error");
        return;
    }

    // Process lighting logic
    let addedCount = 0;
    matches.forEach(scen => {
        if(lighting === "Day" || lighting === "Both") {
            currentMapCycle.push(`(Scenario="${scen.code}",Lighting="Day")`);
            addedCount++;
        }
        if(lighting === "Night" || lighting === "Both") {
            currentMapCycle.push(`(Scenario="${scen.code}",Lighting="Night")`);
            addedCount++;
        }
    });

    // Save state after adding
    saveMapCycleState();

    updateMapCycleOutput();
    showNotification(`Added ${addedCount} entries.`, "success");
}

function clearMapCycle() {
    if(confirm("Clear the entire map cycle list?")) {
        currentMapCycle = [];
        // Save state after clearing
        saveMapCycleState();
        updateMapCycleOutput();
    }
}

function updateMapCycleOutput() {
    const textArea = document.getElementById('mapCycleOutput');
    if(textArea) {
        textArea.value = currentMapCycle.join("\n");
    }
}

function copyMapCycle() {
    const content = document.getElementById('mapCycleOutput');
    content.select();
    document.execCommand('copy');
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(content.value).then(() => {
            showNotification('MapCycle copied!', 'success');
        });
    } else {
        showNotification('MapCycle copied!', 'success');
    }
}

function downloadMapCycle() {
    const content = document.getElementById('mapCycleOutput').value;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'MapCycle.txt';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

// Init on load
document.addEventListener('DOMContentLoaded', function() {
    initMapCycleUI();
    loadMapCycleState(); // Load saved data
});
</script>
<script>
// ==========================================
// ADMIN LIST GENERATOR LOGIC + PERSISTENCE
// ==========================================

let adminUsers = [];

// --- Persistence Functions for Admin List ---
function saveAdminState() {
    localStorage.setItem('issl_admin_v1', JSON.stringify(adminUsers));
}

function loadAdminState() {
    const stored = localStorage.getItem('issl_admin_v1');
    if (!stored) return;
    try {
        adminUsers = JSON.parse(stored);
        updateAdminUI();
    } catch (e) { console.error("Error loading Admins", e); }
}

function addAdminUser() {
    const idInput = document.getElementById('adminSteamID');
    const nameInput = document.getElementById('adminName');
    
    const id = idInput.value.trim();
    const name = nameInput.value.trim();

    // Basic Validation
    if (!id) {
        showNotification("Please enter a SteamID64.", "error");
        return;
    }
    
    // Check if ID looks like a SteamID64 (usually starts with 7656 and is 17 digits)
    if (!/^\d{17}$/.test(id)) {
        if(!confirm("That doesn't look like a standard SteamID64 (17 digits). Add it anyway?")) {
            return;
        }
    }

    // Check for duplicates
    if (adminUsers.some(admin => admin.id === id)) {
        showNotification("This SteamID is already in the list.", "warning");
        return;
    }

    // Add to array
    adminUsers.push({ id: id, name: name });
    
    // SAVE STATE
    saveAdminState();

    // Clear inputs
    idInput.value = '';
    nameInput.value = '';

    updateAdminUI();
    showNotification("Admin added!", "success");
}

function removeAdmin(index) {
    adminUsers.splice(index, 1);
    
    // SAVE STATE
    saveAdminState();

    updateAdminUI();
}

function updateAdminUI() {
    const listContainer = document.getElementById('adminVisualList');
    const outputArea = document.getElementById('adminOutput');
    
    // 1. Update Visual List
    listContainer.innerHTML = '';
    
    if (adminUsers.length === 0) {
        listContainer.innerHTML = '<p style="color:#999; font-style:italic; text-align:center;">No admins added yet.</p>';
    } else {
        adminUsers.forEach((admin, index) => {
            const item = document.createElement('div');
            item.className = 'admin-item';
            
            const info = document.createElement('div');
            info.className = 'admin-item-info';
            
            const idSpan = document.createElement('span');
            idSpan.className = 'admin-item-id';
            idSpan.textContent = admin.id;
            
            info.appendChild(idSpan);
            
            if (admin.name) {
                const nameSpan = document.createElement('span');
                nameSpan.className = 'admin-item-name';
                nameSpan.textContent = admin.name;
                info.appendChild(nameSpan);
            }
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'admin-remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = 'Remove Admin';
            removeBtn.onclick = () => removeAdmin(index);
            
            item.appendChild(info);
            item.appendChild(removeBtn);
            listContainer.appendChild(item);
        });
    }

    // 2. Update Output Textarea
    const fileContent = adminUsers.map(u => u.id).join('\n');
    outputArea.value = fileContent;
}

function copyAdminList() {
    const content = document.getElementById('adminOutput');
    content.select();
    document.execCommand('copy');
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(content.value).then(() => {
            showNotification('Admin list copied!', 'success');
        });
    } else {
        showNotification('Admin list copied!', 'success');
    }
}

function downloadAdminList() {
    const content = document.getElementById('adminOutput').value;
    if(!content.trim()) {
        showNotification("List is empty!", "error");
        return;
    }
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Admins.txt';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

// Load Saved Data on Init
document.addEventListener('DOMContentLoaded', function() {
    loadAdminState();
});
</script>
</body>
</html>
