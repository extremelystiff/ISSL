<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <iframe src="https://extremelystiff.github.io/sandstormplayercount/widget.html" frameborder="0" scrolling="no" width="100%" height="auto"></iframe>
    <title>Insurgency Sandstorm Server Launcher</title>
    <meta property="og:title" content="Insurgency: Sandstorm Server Launcher">
    <meta property="og:description" content="A powerful and user-friendly web application that allows you to effortlessly launch and configure your own Insurgency: Sandstorm dedicated server right from your browser.">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 1px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .quick-start {
            text-align: center;
            margin-bottom: 30px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 5px;
            font-weight: 500;
            text-decoration: none; /* Added for <a> tags */
            display: inline-block; /* Added for <a> tags */
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-large {
            font-size: 1.2em;
            padding: 15px 25px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        #serverForm {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        #serverForm label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        #serverForm input,
        #serverForm select {
            width: 95%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center; /* Align items vertically */
            margin-top: 20px;
        }

        .config-output {
            margin-top: 30px;
            width: 100%;
        }

        #configOutput {
            width: 100%;
            height: 200px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }

        #presetsContainer {
            margin-top: 30px;
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
        }

        #presetButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #fff;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .preset-actions {
            display: flex;
            gap: 10px;
        }

        h1, h2 {
            color: #2c3e50;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: bold;
            color: #777;
            transition: color 0.3s;
        }

        .tab.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .mutator-section {
            margin-top: 20px;
        }

        .mod-section {
            margin-top: 20px;
        }

        details {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }

        summary {
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
        }

        #mutatorCheckboxes, #modCheckboxes {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .checkbox-item:hover {
            background-color: #f9f9f9;
        }

        .checkbox-item label {
            margin-left: 10px;
            flex: 1;
        }

        .item-description {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            margin-left: 25px;
        }

        #selectedModsOutput {
            margin-top: 10px;
            width: 100%;
            min-height: 100px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
        }

        .info-box {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            margin-bottom: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }

        .search-box button {
            border-radius: 0 4px 4px 0;
            padding: 8px 12px;
        }

        abbr {
            text-decoration: none;
            border-bottom: 1px dotted #666;
            cursor: help;
        }
		
/* ============================================ */
/* == FORCE MUTATOR CHECKBOX VISIBILITY FIX === */
/* ============================================ */

/* Ensure the main mutators tab content is visible when active */
#mutators.tab-content.active {
  display: block !important; /* Or flex if you use flexbox layout */
  visibility: visible !important;
  opacity: 1 !important;
  height: auto !important; /* Allow height to adjust */
  overflow: visible !important; /* Prevent accidental clipping */
}

/* Ensure the checkbox container itself is always visible */
#mutatorCheckboxes {
  display: flex !important;
  flex-direction: column !important;
  gap: 10px !important;
  visibility: visible !important;
  opacity: 1 !important;
  min-height: 100px !important; /* Crucial */
  height: auto !important;      /* Let it grow naturally */
  max-height: 400px !important; /* Limit growth */
  overflow-y: auto !important;   /* Add scrollbar if needed */
  overflow-x: hidden !important;
  padding: 10px !important;
  /* border: 3px dashed red !important;  <-- DELETE OR COMMENT OUT THIS LINE */
  background-color: #fffafa !important; /* Light background */
  width: 98% !important; /* Ensure it has width */
  margin-top: 10px !important; /* Add some top margin */
}

/* Ensure each individual checkbox item is visible */
#mutatorCheckboxes .checkbox-item {
  display: flex !important;
  align-items: center !important;
  visibility: visible !important;
  opacity: 1 !important;
  min-height: 30px !important;
  height: auto !important;
  width: 100% !important;
  padding: 8px !important;
  border-bottom: 1px solid #eee !important;
  background-color: #ffffff !important;
}

/* Make labels and inputs visible within the item */
#mutatorCheckboxes .checkbox-item input[type="checkbox"],
#mutatorCheckboxes .checkbox-item label,
#mutatorCheckboxes .checkbox-item .item-description {
  visibility: visible !important;
  opacity: 1 !important;
}

/* Ensure the "Selected Mutators" output is also visible */
#selectedMutatorsOutput {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    min-height: 50px !important; /* Give it some space */
}

/* ============================================ */
/* == END VISIBILITY FIX                 ==== */
/* ============================================ */
		
		
  /* Mutator Suggestions Styling */
  .mutator-suggestions {
    margin-top: 20px;
    padding: 15px;
    background-color: #e3f2fd;
    border-radius: 4px;
    border-left: 4px solid #2196F3;
  }
  
  .suggestion-box {
    margin-bottom: 10px;
    padding: 12px;
    background-color: #fff;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }
  
  .suggestion-box:hover {
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  .suggestion-mod-name {
    font-weight: bold;
    margin-bottom: 3px;
  }
  
  .suggestion-mutator-name {
    color: #0d47a1;
  }
  
  .suggestion-description {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
    margin-bottom: 10px;
  }
  
  .apply-suggestion {
    padding: 5px 10px;
    font-size: 0.85em;
  }
  
  .highlight-mutator {
    animation: highlight-pulse 2s ease-in-out;
  }
  
  @keyframes highlight-pulse {
    0% { background-color: #ffffff; }
    50% { background-color: #e3f2fd; }
    100% { background-color: #ffffff; }
  }
  
  /* Add notification styling */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 15px 20px;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    transition: opacity 0.5s ease;
    opacity: 0;
  }
  
  .notification.show {
    opacity: 1;
  }
  
  /* Tooltip improvements */
  abbr[title] {
    position: relative;
    cursor: help;
  }
  
  abbr[title]:hover::after {
    content: attr(title);
    position: absolute;
    left: 100%;
    top: -5px;
    background-color: #333;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    z-index: 10;
    width: 200px;
    font-size: 0.8em;
    white-space: normal;
  }

  #suggestionInfoModal {
    display: none;
    position: absolute; /* Changed from fixed */
    top: 0; /* Will be set by JS */
    left: 0; /* Will be set by JS */
    width: 100%; /* Keep this for overlay effect if needed, or remove if just popup */
    height: 100%; /* Keep this for overlay effect if needed, or remove */
    /* background-color: rgba(0,0,0,0.5); */ /* Optional: remove background overlay if distracting */
    z-index: 1000;
    /* Remove centering margin */
  }

  #suggestionInfoModal .modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 5px;
    width: 90%; /* Adjusted for potentially smaller absolute box */
    max-width: 450px; /* Adjusted max width */
    position: relative; /* Needed for absolute positioning inside */
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* Add shadow for floating effect */
    border: 1px solid #ccc;
    /* Remove margin: 15% auto; */
  }

  .modal-pointer {
    position: absolute;
    bottom: -10px; /* Position below the modal box */
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid white; /* Same color as modal background */
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); /* Optional shadow for pointer */
  }

    </style>
</head>
<body>
    <div class="container">
        <h1>Insurgency Sandstorm Server Setup</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'serverConfig')">Server Configuration</button>
            <button class="tab" onclick="openTab(event, 'mods')">Mods</button>
            <button class="tab" onclick="openTab(event, 'mutators')">Mutators</button>
        </div>
        
        <div class="main-content">
            <div id="serverConfig" class="tab-content active">
                <div class="quick-start">
                    <button id="quickStartButton" class="btn btn-primary btn-large" onclick="quickStart()">Quick Launch Random Map Server</button>
                </div>
                
                <h2>Server Configuration</h2>
                <form id="serverForm">
                    <div class="form-group">
                        <label for="os">Operating System:</label>
                        <select name="os" id="os">
                            <option value="windows">Windows</option>
                            <option value="linux">Linux</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="hostname">Server Name:</label>
                        <input type="text" id="hostname" name="hostname" placeholder="Enter server name">
                    </div>
                    
                    <div class="form-group">
                        <label for="maxPlayers">Max Players:</label>
                        <input type="number" id="maxPlayers" name="maxPlayers" placeholder="24" min="1" max="99" value="24">
                    </div>
                    
                    <div class="form-group">
                        <label for="port">
                            Game Port
                            <abbr title="For your server to show up on the server browser, you will have to forward both TCP and UDP. You can find tutorials on port forwarding on a lot of websites. We suggest portforward.com, which offers tutorials for most router manufacturers.">?</abbr>:
                        </label>
                        <input type="number" id="port" name="port" placeholder="27102" min="1" max="65535" value="27102">
                    </div>
                    
                    <div class="form-group">
                        <label for="queryPort">
                            Query Port
                            <abbr title="The query port is used by the server browser to retrieve information about your server. It should be a different port than the game port.">?</abbr>:
                        </label>
                        <input type="number" id="queryPort" name="queryPort" placeholder="27131" min="1" max="65535" value="27131">
                    </div>
                    
                    <div class="form-group">
                        <label for="scenario">Choose a Scenario:</label>
                        <select name="scenario" id="scenario">
                			<option value="Bab?Scenario=Scenario_Bab_Checkpoint_Insurgents">Bab Checkpoint Insurgents</option>
                			<option value="Bab?Scenario=Scenario_Bab_Checkpoint_Security">Bab Checkpoint Security</option>
                			<option value="Bab?Scenario=Scenario_Bab_Domination">Bab Domination</option>
                			<option value="Bab?Scenario=Scenario_Bab_Firefight_East">Bab Firefight East</option>
                			<option value="Bab?Scenario=Scenario_Bab_Outpost">Bab Outpost</option>
                			<option value="Bab?Scenario=Scenario_Bab_Push_Insurgents">Bab Push Insurgents</option>
                			<option value="Bab?Scenario=Scenario_Bab_Push_Security">Bab Push Security</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Ambush">Citadel Ambush</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Checkpoint_Insurgents">Citadel Checkpoint Insurgents</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Checkpoint_Security">Citadel Checkpoint Security</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Domination">Citadel Domination</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Firefight_East">Citadel Firefight East</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Outpost">Citadel Outpost</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Push_Insurgents">Citadel Push Insurgents</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Push_Security">Citadel Push Security</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Survival">Citadel Survival</option>
                			<option value="Citadel?Scenario=Scenario_Citadel_Defusal">Citadel Defusal</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Ambush">Crossing Ambush</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Checkpoint_Insurgents">Crossing Checkpoint Insurgents</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Checkpoint_Security">Crossing Checkpoint Security</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Domination">Crossing Domination</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Firefight_West">Crossing Firefight West</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Frontline">Crossing Frontline</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Outpost">Crossing Outpost</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Push_Insurgents">Crossing Push Insurgents</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Push_Security">Crossing Push Security</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Skirmish">Crossing Skirmish</option>
                			<option value="Canyon?Scenario=Scenario_Crossing_Team_Deathmatch">Crossing Team Deathmatch</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Ambush">Farmhouse Ambush</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Checkpoint_Insurgents">Farmhouse Checkpoint Insurgents</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Checkpoint_Security">Farmhouse Checkpoint Security</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Domination">Farmhouse Domination</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Firefight_East">Farmhouse Firefight East</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Firefight_West">Farmhouse Firefight West</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Frontline">Farmhouse Frontline</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Push_Insurgents">Farmhouse Push Insurgents</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Push_Security">Farmhouse Push Security</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Skirmish">Farmhouse Skirmish</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Survival">Farmhouse Survival</option>
                			<option value="Farmhouse?Scenario=Scenario_Farmhouse_Team_Deathmatch">Farmhouse Team Deathmatch</option>
					<option value="Forest?Scenario=Scenario_Forest_Push_Insurgents">Forest Push Insurgents</option>
					<option value="Forest?Scenario=Scenario_Forest_Push_Security">Forest Push Security</option>
					<option value="Forest?Scenario=Scenario_Forest_Firefight_East">Forest Firefight East</option>
					<option value="Forest?Scenario=Scenario_Forest_Firefight_West">Forest Firefight West</option>
					<option value="Forest?Scenario=Scenario_Forest_Survival">Forest Survival</option>
					<option value="Forest?Scenario=Scenario_Forest_Ambush">Forest Ambush</option>
					<option value="Forest?Scenario=Scenario_Forest_FFA">Forest FFA</option>
					<option value="Forest?Scenario=Scenario_Forest_Defusal">Forest Defusal</option>
					<option value="Forest?Scenario=Scenario_Forest_TDM">Forest Team Deathmatch</option>
					<option value="Forest?Scenario=Scenario_Forest_Domination">Forest Domination</option>
					<option value="Forest?Scenario=Scenario_Forest_Frontline">Forest Frontline</option>
					<option value="Forest?Scenario=Scenario_Forest_Skirmish">Forest Skirmish</option>
					<option value="Forest?Scenario=Scenario_Forest_Checkpoint_Insurgents">Forest Checkpoint Insurgents</option>
					<option value="Forest?Scenario=Scenario_Forest_Checkpoint_Security">Forest Checkpoint Security</option>
					<option value="Forest?Scenario=Scenario_Forest_Outpost">Forest Outpost</option>
                			<option value=Gap?Scenario=Scenario_Gap_Ambush">Gap Ambush</option>
                			<option value=Gap?Scenario=Scenario_Gap_Checkpoint_Insurgents">Gap Checkpoint Insurgents</option>
                			<option value=Gap?Scenario=Scenario_Gap_Checkpoint_Security">Gap Checkpoint Security</option>
                			<option value=Gap?Scenario=Scenario_Gap_Domination">Gap Domination</option>
                			<option value=Gap?Scenario=Scenario_Gap_Firefight">Gap Firefight</option>
                			<option value=Gap?Scenario=Scenario_Gap_Frontline">Gap Frontline</option>
                			<option value=Gap?Scenario=Scenario_Gap_Outpost">Gap Outpost</option>
                			<option value=Gap?Scenario=Scenario_Gap_Push_Insurgents">Gap Push Insurgents</option>
                			<option value=Gap?Scenario=Scenario_Gap_Push_Security">Gap Push Security</option>
                			<option value=Gap?Scenario=Scenario_Gap_Survival">Gap Survival</option>
                			<option value=Gap?Scenario=Scenario_Gap_Defusal">Gap Defusal</option>
                			<option value="Town?Scenario=Scenario_Hideout_Ambush">Hideout Ambush</option>
                			<option value="Town?Scenario=Scenario_Hideout_Checkpoint_Insurgents">Hideout Checkpoint Insurgents</option>
                			<option value="Town?Scenario=Scenario_Hideout_Checkpoint_Security">Hideout Checkpoint Security</option>
                			<option value="Town?Scenario=Scenario_Hideout_Domination">Hideout Domination</option>
                			<option value="Town?Scenario=Scenario_Hideout_Firefight_East">Hideout Firefight East</option>
                			<option value="Town?Scenario=Scenario_Hideout_Firefight_West">Hideout Firefight West</option>
                			<option value="Town?Scenario=Scenario_Hideout_Frontline">Hideout Frontline</option>
                			<option value="Town?Scenario=Scenario_Hideout_Push_Insurgents">Hideout Push Insurgents</option>
                			<option value="Town?Scenario=Scenario_Hideout_Push_Security">Hideout Push Security</option>
                			<option value="Town?Scenario=Scenario_Hideout_Skirmish">Hideout Skirmish</option>
                			<option value="Town?Scenario=Scenario_Hideout_Survival">Hideout Survival</option>
                			<option value="Town?Scenario=Scenario_Hideout_Team_Deathmatch">Hideout Team Deathmatch</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Ambush">Hillside Ambush</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Checkpoint_Insurgents">Hillside Checkpoint Insurgents</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Checkpoint_Security">Hillside Checkpoint Security</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Domination">Hillside Domination</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Firefight_East">Hillside Firefight East</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Firefight_West">Hillside Firefight West</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Frontline">Hillside Frontline</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Outpost">Hillside Outpost</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Push_Insurgents">Hillside Push Insurgents</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Push_Security">Hillside Push Security (INS2014 layout)</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Skirmish">Hillside Skirmish</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Survival">Hillside Survival</option>
                			<option value="Sinjar?Scenario=Scenario_Hillside_Team_Deathmatch">Hillside Team Deathmatch</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Push_Security">LastLight Push Security</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Checkpoint_Insurgents">LastLight Checkpoint Insurgents</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Checkpoint_Security">LastLight Checkpoint Security</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Domination">LastLight Domination</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Firefight">LastLight Firefight</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Ambush"LastLight >Ambush</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Survival">LastLight Survival</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Push_Insurgents">LastLight Push Insurgents</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Push_Security">LastLight Push Security</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Outpost">LastLight Outpost</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Defusal">LastLight Defusal</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Frontline">LastLight Frontline</option>
                			<option value="LastLight?Scenario=Scenario_LastLight_Team_Deathmatch">LastLight Team Deathmatch</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Ambush">Ministry Ambush</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Checkpoint_Insurgents">Ministry Checkpoint Insurgents</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Checkpoint_Security">Ministry Checkpoint Security</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Domination">Ministry Domination</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Firefight_A">Ministry Firefight</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Skirmish">Ministry Skirmish</option>
                			<option value="Ministry?Scenario=Scenario_Ministry_Team_Deathmatch">Ministry Team Deathmatch</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Checkpoint_Insurgents">Outskirts Checkpoint Insurgents</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Checkpoint_Security">Outskirts Checkpoint Security</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Firefight_East">Outskirts Firefight East</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Firefight_West">Outskirts Firefight West</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Frontline">Outskirts Frontline</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Push_Insurgents">Outskirts Push Insurgents</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Push_Security">Outskirts Push Security</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Skirmish">Outskirts Skirmish</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Team_Deathmatch">Outskirts Team Deathmatch</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Survival">Outskirts Survival</option>
                			<option value=Compound?Scenario=Scenario_Outskirts_Defusal">Outskirts Defusal</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Ambush">PowerPlant Ambush</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Checkpoint_Insurgents">PowerPlant Checkpoint Insurgents</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Checkpoint_Security">PowerPlant Checkpoint Security</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Domination">PowerPlant Domination</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Firefight_East">PowerPlant Firefight East</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Firefight_West">PowerPlant Firefight West</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Push_Insurgents">PowerPlant Push Insurgents</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Push_Security">PowerPlant Push Security</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Survival">PowerPlant Survival</option>
                			<option value="PowerPlant?Scenario=Scenario_PowerPlant_Frontline">PowerPlant Frontline</option>	
                			<option value="Precinct?Scenario=Scenario_Precinct_Ambush">Precinct Ambush</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Checkpoint_Insurgents">Precinct Checkpoint Insurgents</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Checkpoint_Security">Precinct Checkpoint Security</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Firefight_East">Precinct Firefight East</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Firefight_West">Precinct Firefight West</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Frontline">Precinct Frontline</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Push_Insurgents">Precinct Push Insurgents</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Push_Security">Precinct Push Security</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Skirmish">Precinct Skirmish</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Team_Deathmatch">Precinct Team Deathmatch</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Survival">Precinct Survival</option>
                			<option value="Precinct?Scenario=Scenario_Precinct_Defusal">Precinct Defusal</option>
                			<option value="Prison?Scenario=Scenario_Prison_Push_Security">Prison Push Security</option>
                			<option value="Prison?Scenario=Scenario_Prison_Checkpoint_Insurgents">Prison Checkpoint Insurgents</option>
                			<option value="Prison?Scenario=Scenario_Prison_Checkpoint_Security">Prison Checkpoint Security</option>
                			<option value="Prison?Scenario=Scenario_Prison_Domination">Prison Domination</option>
                			<option value="Prison?Scenario=Scenario_Prison_Firefight">Prison Firefight</option>
                			<option value="Prison?Scenario=Scenario_Prison_Ambush">Prison Ambush</option>
                			<option value="Prison?Scenario=Scenario_Prison_Survival">Prison Survival</option>
                			<option value="Prison?Scenario=Scenario_Prison_Push_Insurgents">Prison Push Insurgents</option>
                			<option value="Prison?Scenario=Scenario_Prison_Push_Security">Prison Push Security</option>
                			<option value="Prison?Scenario=Scenario_Prison_Defusal">Prison Defusal</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Push_Security">Refinery Push Security</option>    
                			<option value="Oilfield?Scenario=Scenario_Refinery_Ambush">Refinery Ambush</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Checkpoint_Insurgents">Refinery Checkpoint Insurgents</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Checkpoint_Security">Refinery Checkpoint Security</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Domination">Refinery Domination</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Firefight_West">Refinery Firefight West</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Frontline">Refinery Frontline</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Push_Insurgents">Refinery Push Insurgents</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Push_Security">Refinery Push Security</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Skirmish">Refinery Skirmish</option>
                			<option value="Oilfield?Scenario=Scenario_Refinery_Survival">Refinery Survival</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Ambush">Summit Ambush</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Checkpoint_Insurgents">Summit Checkpoint Insurgents</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Checkpoint_Security">Summit Checkpoint Security</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Firefight_East">Summit Firefight East</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Firefight_West">Summit Firefight West</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Frontline">Summit Frontline</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Push_Insurgents">Summit Push Insurgents</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Push_Security">Summit Push Security</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Skirmish">Summit Skirmish</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Team_Deathmatch">Summit Team Deathmatch</option>
                			<option value="Mountain?Scenario=Scenario_Summit_Survival">Summit Survival</option>
                			<option value="Tell?Scenario=Scenario_Tell_Ambush">Tell Ambush</option>
                			<option value="Tell?Scenario=Scenario_Tell_Checkpoint_Insurgents">Tell Checkpoint Insurgents</option>
                			<option value="Tell?Scenario=Scenario_Tell_Checkpoint_Security">Tell Checkpoint Security</option>
                			<option value="Tell?Scenario=Scenario_Tell_Domination">Tell Domination</option>
                			<option value="Tell?Scenario=Scenario_Tell_Firefight_East">Tell Firefight East</option>
                			<option value="Tell?Scenario=Scenario_Tell_Firefight_West">Tell Firefight West</option>
                			<option value="Tell?Scenario=Scenario_Tell_Outpost">Tell Outpost</option>
                			<option value="Tell?Scenario=Scenario_Tell_Push_Insurgents">Tell Push Insurgents</option>
                			<option value="Tell?Scenario=Scenario_Tell_Push_Security">Tell Push Security</option>
                			<option value="Tell?Scenario=Scenario_Tell_Survival">Tell Survival</option>
                			<option value="Tell?Scenario=Scenario_Tell_Frontline">Tell Frontline</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Checkpoint_Insurgents">Tideway Checkpoint Insurgents</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Checkpoint_Security">Tideway Checkpoint Security</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Domination">Tideway Domination</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Firefight_West">Tideway Firefight West</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Frontline">Tideway Frontline</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Push_Insurgents">Tideway Push Insurgents</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Push_Security">Tideway Push Security</option>
                			<option value="Buhriz?Scenario=Scenario_Tideway_Survival">Tideway Survival</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Push_Security">Trainyard Push Security</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Push_Insurgents">Trainyard Push Insurgents</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Firefight_West">Trainyard Firefight West</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Firefight_East">Trainyard Firefight East</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Domination_West">Trainyard Domination West</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Domination_East">Trainyard Domination East</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Frontline">Trainyard Frontline</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Ambush_East">Trainyard Ambush East</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Ambush_West">Trainyard Ambush West</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Defusal_West">Trainyard Defusal West</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Checkpoint_Security">Trainyard Checkpoint Security</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Checkpoint_Insurgents">Trainyard Checkpoint Insurgents</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Outpost">Trainyard Outpost</option>
                			<option value="Trainyard?Scenario=Scenario_Trainyard_Survival">Trainyard Survival</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password (optional):</label>
                        <input type="text" id="password" name="password" placeholder="Enter password">
                    </div>
                    
                    <div class="form-group">
                        <label for="gameStatsToken">
                            <a href="https://gamestats.sandstorm.game/" target="_blank">GameStats Token</a>
                            <abbr title="Any Insurgency: Sandstorm community server can host a stats-enabled game. Enabling stats on your server also enables experience gain while playing on the server. The only requirement is that you must use a Steam GSLT, and you must not have a server password.">?</abbr>
                            (optional):
                        </label>
                        <input type="text" id="gameStatsToken" name="gameStatsToken" placeholder="Enter GameStats token">
                    </div>
                    
                    <div class="form-group">
                        <label for="gsltToken">
                            <a href="https://steamcommunity.com/dev/managegameservers" target="_blank">GSLT Token</a>
                            <abbr title="For your server to authenticate with the stats server, you must authenticate your server through Steam GSLT (Game Server Login Token). GSLTs can be obtained from Steam's Game Server Account Management page.">?</abbr>
                            (optional):
                        </label>
                        <input type="text" id="gsltToken" name="gsltToken" placeholder="Enter GSLT token">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableGameStats" name="enableGameStats">
                            Enable GameStats
                            <abbr title="By default, the game servers will not attempt to report to the stats system. Following the GSLT login steps, adding -GameStats to your server's command line will enable the opt-in to the system.">?</abbr>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="officialRules" name="officialRules">
                            Use Official Rules
                            <abbr title="The game ships with a ruleset which are considered official rules; this locks down the options you can change on your dedicated server. If you are running a mostly vanilla server, you may consider opting into this ruleset for your server to appear under the 'official rules' filter. To opt-in, add -OfficialRules to your server's command line.">?</abbr>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableCheats" name="enableCheats">
                            Enable Cheats
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <!-- === MODIFIED PART === -->
                        <!-- Replaced the button with a link (anchor tag) -->
                        <a id="launchLink" href="#" class="btn btn-primary btn-large" role="button">Launch Server</a>
                        <!-- === END MODIFIED PART === -->
                        
                        <div>
                            <button type="button" class="btn btn-secondary" onclick="generateConfig()">Generate Config</button>
                            <button type="button" class="btn btn-info" onclick="generateShareLink()" style="margin-left: 10px;">Share Configuration</button>
                        </div>
                    </div>
                </form>
                
                <div class="config-output">
                    <label for="configOutput">Generated Config:</label>
                    <textarea id="configOutput" readonly></textarea>
                </div>
                
                <div id="presetsContainer">
                    <h2>Presets</h2>
                    <div id="presetButtons"></div>
                    <div class="preset-actions">
                        <button type="button" class="btn btn-secondary" onclick="savePreset()">Save Preset</button>
                        <button type="button" class="btn btn-secondary" onclick="exportPresets()">Export Presets</button>
                        <button type="button" class="btn btn-secondary" onclick="importPresets()">Import Presets</button>
                    </div>
                </div>
            </div>
            
            <div id="mods" class="tab-content">
                <h2>Mods</h2>
                <div class="info-box">
                    Select mods to include with your server. The selected mods will be added to the server launch parameters.
                </div>
                
                <div class="search-box">
                    <input type="text" id="modSearch" placeholder="Search mods..." onkeyup="searchMods()">
                    <button type="button" class="btn btn-primary" onclick="searchMods()">Search</button>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="fetchMods()">Refresh Mod List</button>
                
                <div id="modCheckboxes">
                    <p>Loading mods list... Please wait or click "Refresh Mod List"</p>
                </div>
                
                <div>
                    <h3>Selected Mods:</h3>
                    <div id="selectedModsOutput"></div>
                </div>
            </div> <!-- This closes #mods -->

            <div id="mutators" class="tab-content">
                <h2>Mutators</h2>
                <div class="info-box">
                    Select mutators to enable on your server. Mutators change gameplay mechanics and rules.
                </div>
                <div class="search-box">
                    <input type="text" id="mutatorSearch" placeholder="Search mutators..." onkeyup="searchMutators()">
                    <button type="button" class="btn btn-primary" onclick="searchMutators()">Search</button>
                </div>
                <div id="mutatorCheckboxes">
                    <!-- Mutator checkboxes will be dynamically generated here -->
                </div>
                <div> <!-- Consider removing this wrapper if not needed -->
				    <h3>Selected Mutators:</h3>
				    <div id="selectedMutatorsOutput">
				    </div>
			    </div> <!-- Closes potential wrapper -->
		    </div> <!-- This closes #mutators -->

        </div> <!-- MOVED HERE: This now correctly closes .main-content -->

    </div> <!-- This closes .container -->

    <div id="notification" class="notification"></div>
    


    <script>
    // =========================================================================
    // == IMMEDIATE LAUNCH REDIRECT HANDLER (FOR DISCORD-FRIENDLY LINKS)      ==
    // =========================================================================
    // This code runs instantly. If it finds "action=launch" in the URL, it
    // takes over the page to launch the game and prevents the tool from loading.
    (function() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');

            if (action === 'launch') {
                const serverParams = urlParams.get('params');
                if (serverParams) {
                    // Display a user-friendly launching message so they know what's happening
			document.body.innerHTML = `
			    <div style="font-family: 'Roboto', sans-serif; text-align: center; color: #333; background-color: #f0f2f5; height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;">
			        <div>
			             <h1>Launching Insurgency: Sandstorm Server...</h1>
			             <p>Your server should open shortly. If it doesn't, please ensure Steam is running and you allow steam links.</p>
			             <p style="font-size: 0.8em; color: #666;">You can close this tab.</p>
			        </div>
			    </div>
                    `;

                    // The serverParams from the URL are already URI-encoded.
                    const steamUrl = 'steam://rungameid/581330//' + serverParams;
                    
                    // Perform the redirect to launch Steam
                    window.location.href = steamUrl;
                } else {
                    document.body.innerHTML = '<h1>Error: Launch parameters were not found in the link.</h1>';
                }
                // This error is thrown intentionally to stop the rest of the script (the tool UI) from running.
                throw new Error("Redirecting to Steam. Halting further script execution.");
            }
        } catch (e) {
            // We expect the "Halting" error, so we only log other unexpected errors.
            if (!e.message.startsWith("Redirecting to Steam")) {
                console.error("An error occurred in the redirect handler:", e);
            }
        }
    })();
    // =========================================================================
    // == END OF REDIRECT HANDLER                                             ==
    // =========================================================================

        // Global variables
        let mods = [];
        let selectedMods = [];
        let customMutators = [];
        let selectedMutators = [];
		// Store the global mods array alphabetically once fetched/defined
		let sortedMods = [];
		

        let modMutatorSuggestions = {
          // Format: modId: { name, suggestedMutator, description, popularity }
          // Common mod-mutator relationships based on community knowledge
          "89591": { 
            name: "Shoot House", 
            suggestedMutator: "Competitive", 
            description: "Competitive mutator improves the training experience on this map",
            popularity: 0.85
          },
          "91912": { 
            name: "Wolf-land (Nightfall 1.7 Update)", 
            suggestedMutator: "Hardcore", 
            description: "Hardcore mutator enhances the nighttime atmosphere",
            popularity: 0.9
          },
          "92807": { 
            name: "M45A1 Wolfpack", 
            suggestedMutator: "FullyLoaded", 
            description: "Makes all weapons available including this mod",
            popularity: 0.75
          },
          
          // Add ISMC mod suggestions
          "150867": { 
            name: "ISMCmod", 
            suggestedMutator: "ISMC_Casual", 
            description: "ISMC_Casual is the recommended mutator for ISMCmod",
            popularity: 0.90
          },
          "1516914": { 
            name: "ISMC Resources", 
            suggestedMutator: "ISMC_Casual", 
            description: "ISMC_Casual is the recommended mutator for ISMC Resources",
            popularity: 0.95
          }
        };



        // Load custom mutators from local storage on page load
        function loadCustomMutators() {
          try {
            const savedMutators = localStorage.getItem('customMutators');
            if (savedMutators) {
              customMutators = JSON.parse(savedMutators);
              console.log('Loaded custom mutators:', customMutators);
            }
          } catch (error) {
            console.error('Error loading custom mutators:', error);
            customMutators = [];
          }
        }
        
        // Function to add custom mutator
        function addCustomMutator() {
          const mutatorInput = document.getElementById('customMutatorInput');
          const mutatorName = mutatorInput.value.trim();
          
          if (!mutatorName) {
            alert('Please enter a mutator name');
            return;
          }
          
          // Check if already in standard mutators
          const existingStandardMutator = mutators.find(m => m.name.toLowerCase() === mutatorName.toLowerCase());
          if (existingStandardMutator) {
            alert('This mutator already exists in the standard list');
            return;
          }
          
          // Check if already in custom mutators
          const existingCustomMutator = customMutators.find(m => m.name.toLowerCase() === mutatorName.toLowerCase());
          if (existingCustomMutator) {
            alert('This custom mutator has already been added');
            return;
          }
          
          // Add to custom mutators
          const newMutator = { name: mutatorName, description: 'Custom user-added mutator', isCustom: true };
          customMutators.push(newMutator);
          
          // Save to local storage
          localStorage.setItem('customMutators', JSON.stringify(customMutators));
          
          // Add to selected mutators
          if (!selectedMutators.includes(mutatorName)) {
            selectedMutators.push(mutatorName);
          }
          
          // Clear input
          mutatorInput.value = '';
          
          // Regenerate the mutator checkboxes to include the new custom mutator
          generateMutatorCheckboxes();
          
          // Log to GAS if mods are selected
          if (selectedMods && selectedMods.length > 0) {
            logCustomMutatorToGAS(mutatorName);
          }
        }

        function logSelectedCustomMutators() {
          // Only proceed if there are mods and custom mutators selected
          if (!selectedMods || selectedMods.length === 0) return;
          
          // Find which custom mutators are currently selected
          const selectedCustomMutatorNames = selectedMutators.filter(mutatorName => {
            // Check if this is a custom mutator (not in standard mutators list)
            return !mutators.some(m => m.name === mutatorName) && 
                   customMutators.some(m => m.name === mutatorName);
          });
          
          // Log each selected custom mutator
          if (selectedCustomMutatorNames.length > 0) {
            selectedCustomMutatorNames.forEach(mutatorName => {
              logCustomMutatorToGAS(mutatorName);
            });
          }
        }
        
        // Generate mutator checkboxes
		// Generate mutator checkboxes, sorting selected to the top
		// Generate mutator checkboxes, sorting selected to top, and grouping custom
		function generateMutatorCheckboxes() {
			console.log("Generating mutator checkboxes (sorted + grouped)");
			const mutatorCheckboxesContainer = document.getElementById('mutatorCheckboxes');

			if (!mutatorCheckboxesContainer) {
				console.error("Mutator checkboxes container not found!");
				return;
			}
			mutatorCheckboxesContainer.innerHTML = ''; // Clear previous

			// --- NEW: Four lists for detailed sorting ---
			const enabledStandardItems = [];
			const enabledCustomItems = [];
			const availableStandardItems = [];
			const availableCustomItems = [];

			// Combine standard and custom into one list for iteration
			const allMutatorsData = [
				...mutators.map(m => ({ ...m, isCustom: false })),
				...customMutators.map(m => ({ ...m, isCustom: true }))
			];

			allMutatorsData.forEach(mutator => {
				const isSelected = selectedMutators.includes(mutator.name);
				const checkboxItem = document.createElement('div');
				checkboxItem.className = 'checkbox-item';
				if (mutator.isCustom) {
					checkboxItem.classList.add('custom-mutator-item');
				}

				const checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.value = mutator.name;
				checkbox.id = mutator.isCustom ? `mutator-custom-${mutator.name}` : `mutator-${mutator.name}`;
				checkbox.checked = isSelected;

				checkbox.addEventListener('change', function() {
					const mutatorName = this.value;
					if (this.checked) {
						if (!selectedMutators.includes(mutatorName)) {
							selectedMutators.push(mutatorName);
						}
					} else {
						const index = selectedMutators.indexOf(mutatorName);
						if (index !== -1) {
							selectedMutators.splice(index, 1);
						}
					}
					updateSelectedMutatorsDisplay();
					generateMutatorCheckboxes(); // Re-render this list to sort/group
					updateMutatorSuggestions(); // Re-render suggestions for button states
                    generateConfig(); // <<< NEW: Update link/config on change
				});

				const label = document.createElement('label');
				label.htmlFor = checkbox.id;
				label.textContent = mutator.name;

				const description = document.createElement('div');
				description.className = 'item-description';
				description.textContent = mutator.description || (mutator.isCustom ? 'Custom user-added mutator' : '');
				 // Align description better when delete button is present
				 description.style.flexGrow = '1';
				 description.style.marginLeft = '10px'; // Add some space after label/button

				checkboxItem.appendChild(checkbox);
				checkboxItem.appendChild(label);

				// Add delete button for custom mutators (before description)
				if (mutator.isCustom) {
					const deleteButton = document.createElement('button');
					deleteButton.className = 'btn btn-danger btn-sm';
					deleteButton.textContent = 'Delete';
					deleteButton.style.marginLeft = 'auto'; // Push button to the right
					deleteButton.style.marginRight = '10px'; // Space before description
					deleteButton.onclick = function(e) {
						e.preventDefault();
						deleteCustomMutator(mutator.name);
					};
					checkboxItem.appendChild(deleteButton);
				}

				checkboxItem.appendChild(description);

				// Assign to the correct temporary list
				if (isSelected) {
					if (mutator.isCustom) {
						enabledCustomItems.push(checkboxItem);
					} else {
						enabledStandardItems.push(checkboxItem);
					}
				} else {
					if (mutator.isCustom) {
						availableCustomItems.push(checkboxItem);
					} else {
						availableStandardItems.push(checkboxItem);
					}
				}
			});

			// --- Append sorted and grouped items ---
			const hasEnabled = enabledStandardItems.length > 0 || enabledCustomItems.length > 0;
			const hasAvailable = availableStandardItems.length > 0 || availableCustomItems.length > 0;

			// 1. Enabled Section
			if (hasEnabled) {
				const enabledHeader = document.createElement('h4');
				enabledHeader.textContent = "Enabled Mutators";
				enabledHeader.style.marginTop = '15px';
				enabledHeader.style.marginBottom = '5px';
				mutatorCheckboxesContainer.appendChild(enabledHeader);

				enabledStandardItems.forEach(item => mutatorCheckboxesContainer.appendChild(item));
				// Add custom enabled after standard enabled
				if (enabledCustomItems.length > 0) {
					 // Optional: Add a small sub-header or just let them list
					enabledCustomItems.forEach(item => mutatorCheckboxesContainer.appendChild(item));
				}
			}

			// 2. Separator
			if (hasEnabled && hasAvailable) {
				const separator = document.createElement('hr');
				separator.style.margin = '20px 0';
				mutatorCheckboxesContainer.appendChild(separator);
			}

			// 3. Available Section
			if (hasAvailable) {
				const availableHeader = document.createElement('h4');
				availableHeader.textContent = "Available Mutators";
				if (!hasEnabled) { // Add top margin if no enabled section
					availableHeader.style.marginTop = '15px';
				}
				availableHeader.style.marginBottom = '5px';
				mutatorCheckboxesContainer.appendChild(availableHeader);

				availableStandardItems.forEach(item => mutatorCheckboxesContainer.appendChild(item));
				// Add custom available after standard available
				if (availableCustomItems.length > 0) {
					const customSeparator = document.createElement('div');
					customSeparator.textContent = '--- Custom ---'; // Simple text separator
					customSeparator.style.textAlign = 'center';
					customSeparator.style.margin = '10px 0 5px 0';
					customSeparator.style.color = '#666';
					customSeparator.style.fontSize = '0.9em';
					mutatorCheckboxesContainer.appendChild(customSeparator);
					availableCustomItems.forEach(item => mutatorCheckboxesContainer.appendChild(item));
				}
			}
			// --- END Appending Logic ---

			updateSelectedMutatorsDisplay(); // Update the text list below
			console.log("Mutator checkboxes container generated with sorting/grouping.");
		}
function forceRegenerateMutators() {
  console.log("Forcing regeneration of mutator checkboxes");
  generateMutatorCheckboxes();
  alert("Mutator checkboxes have been regenerated.");
}

        
        // Function to delete custom mutator
        function deleteCustomMutator(mutatorName) {
          // Remove from customMutators array
          customMutators = customMutators.filter(m => m.name !== mutatorName);
          
          // Save updated list to local storage
          localStorage.setItem('customMutators', JSON.stringify(customMutators));
          
          // Remove from selectedMutators if present
          const index = selectedMutators.indexOf(mutatorName);
          if (index !== -1) {
            selectedMutators.splice(index, 1);
          }
          
          // Regenerate mutator checkboxes
          generateMutatorCheckboxes();
        }
        
        // Initialize custom mutators form
function initializeCustomMutators() {
  // First load any saved custom mutators
  loadCustomMutators();
  
  // Add the custom mutator input form
  const mutatorContainer = document.getElementById('mutatorCheckboxes');
  if (!mutatorContainer) {
    console.error("Mutator container not found!");
    return;
  }
  
  const customMutatorForm = document.createElement('div');
  customMutatorForm.className = 'custom-mutator-form';
  customMutatorForm.style.marginBottom = '20px';
  customMutatorForm.innerHTML = `
    <h3>Add Custom Mutator</h3>
    <div class="form-group" style="display: flex; gap: 10px;">
      <input type="text" id="customMutatorInput" placeholder="Enter custom mutator name" style="flex: 1;">
      <button type="button" class="btn btn-primary" onclick="addCustomMutator()">Add</button>
    </div>
  `;
  
  // Insert before the mutator checkboxes
  mutatorContainer.parentNode.insertBefore(customMutatorForm, mutatorContainer);
  
  // Generate mutator checkboxes (which will now include any loaded custom mutators)
  // This call is important to ensure mutators appear
  generateMutatorCheckboxes();
}

        function updateMutatorCheckboxes() {
            const checkboxes = document.querySelectorAll('#mutatorCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectedMutators.includes(checkbox.value);
            });
            generateConfig(); // Update link/config
        }

        function updateSelectedMutatorsDisplay() {
            const output = document.getElementById('selectedMutatorsOutput');
            if (selectedMutators.length === 0) {
                output.textContent = 'No mutators selected';
            } else {
                output.textContent = selectedMutators.join(', ');
            }
        }

        function searchMutators() {
            const searchTerm = document.getElementById('mutatorSearch').value.toLowerCase();
            const checkboxItems = document.querySelectorAll('#mutatorCheckboxes .checkbox-item');
            
            checkboxItems.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                const description = item.querySelector('.item-description').textContent.toLowerCase();
                
                if (label.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

// Add this function somewhere in your <script> block
function applyUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    console.log("Checking for URL parameters:", window.location.search);

    // Helper function to set value if param exists and element is found
    const setInputValue = (id, paramName) => {
        if (urlParams.has(paramName)) {
            const element = document.getElementById(id);
            if (element) {
                try {
                    element.value = decodeURIComponent(urlParams.get(paramName)); // Decode potential encoding
                    console.log(`Set ${id} from param '${paramName}' to: ${element.value}`);
                } catch (e) {
                    console.error(`Error decoding parameter ${paramName} for ${id}:`, e);
                    // Fallback to raw value if decoding fails
                    element.value = urlParams.get(paramName);
                }
            } else {
                console.warn(`Element with ID ${id} not found for param ${paramName}`);
            }
        }
    };

    // Helper function for checkboxes
    const setCheckboxValue = (id, paramName) => {
        if (urlParams.has(paramName)) {
            const element = document.getElementById(id);
            if (element) {
                // Treat 'true' or existence of param (with empty value) as checked
                const paramValue = urlParams.get(paramName).toLowerCase();
                element.checked = (paramValue === 'true' || paramValue === '');
                console.log(`Set ${id} checked state from param '${paramName}' to: ${element.checked}`);
            } else {
                console.warn(`Element with ID ${id} not found for param ${paramName}`);
            }
        }
    };

    // --- Apply to Standard Form Fields ---
    setInputValue('os', 'os');
    setInputValue('hostname', 'hostname');
    setInputValue('maxPlayers', 'maxPlayers');
    setInputValue('port', 'port');
    setInputValue('queryPort', 'queryPort');
    setInputValue('scenario', 'scenario');
    setInputValue('password', 'password');
    setInputValue('gameStatsToken', 'gameStatsToken');
    setInputValue('gsltToken', 'gsltToken');

    // --- Apply to Checkboxes ---
    setCheckboxValue('enableGameStats', 'enableGameStats');
    setCheckboxValue('officialRules', 'officialRules');
    setCheckboxValue('enableCheats', 'enableCheats');

    // --- Handle Mods ---
    // Needs to run AFTER mods have been fetched and 'sortedMods' is populated
    if (urlParams.has('mods')) {
        const modIdsParam = urlParams.get('mods');
        if (modIdsParam && sortedMods.length > 0) { // Ensure mods are loaded
            const modIds = modIdsParam.split(',')
                                    .map(id => parseInt(id.trim()))
                                    .filter(id => !isNaN(id));
            console.log("Applying mod IDs from URL:", modIds);

            // Filter the fetched mods based on the IDs from the URL
            selectedMods = sortedMods.filter(mod => mod && modIds.includes(mod.id));
            console.log("Selected mods after URL processing:", selectedMods);

        } else if (modIdsParam === '') { // Handle empty mods param "?mods="
             selectedMods = [];
             console.log("Cleared mods due to empty URL parameter.");
        }
        // Update UI AFTER processing mods
        generateModCheckboxes(); // Regenerate to show selections correctly
        updateSelectedModsDisplay();
    } else {
        // If no 'mods' param, ensure initial mod UI state is correct (might be redundant if fetchMods already did this)
        // generateModCheckboxes(); // Usually called after fetchMods anyway
        // updateSelectedModsDisplay();
    }


    // --- Handle Mutators ---
    if (urlParams.has('mutators')) {
        const mutatorsParam = urlParams.get('mutators');
         if (mutatorsParam) {
            selectedMutators = mutatorsParam.split(',')
                                         .map(m => decodeURIComponent(m.trim())) // Decode mutator names
                                         .filter(m => m !== '');
            console.log("Applying mutators from URL:", selectedMutators);
         } else { // Handle empty mutators param "?mutators="
             selectedMutators = [];
             console.log("Cleared mutators due to empty URL parameter.");
         }
         // Update UI AFTER processing mutators
         generateMutatorCheckboxes(); // Regenerate checkboxes to reflect selection
         updateSelectedMutatorsDisplay();
    } else {
        // If no 'mutators' param, ensure initial mutator UI state is correct
        // generateMutatorCheckboxes(); // Usually called by initializeCustomMutators
        // updateSelectedMutatorsDisplay();
    }

    // --- Final UI Updates ---
    // Trigger generation of the config string based on prefilled values
    generateConfig();
    // Update suggestions based on potentially prefilled mods/mutators
    updateMutatorSuggestions();
    console.log("URL parameter application complete.");
}

// Modify your DOMContentLoaded listener to call applyUrlParameters appropriately
document.addEventListener('DOMContentLoaded', function() {
    // Keep your existing initialization
    loadPresetsFromStorage();
    initializeCustomMutators(); // Generates initial mutator list
    initMutatorSuggestions();
    setupModTabBehavior();

    // Fetch mods, THEN apply URL parameters (important for mods)
    fetchMods().then(() => {
        console.log("Mods fetched, now applying URL parameters.");
        applyUrlParameters(); // Apply params after mods are loaded and sortedMods is ready
        // Check if suggestions need updating *after* params applied
        updateMutatorSuggestions();
    }).catch(error => {
        console.error("Error fetching mods during init:", error);
        // Still try to apply other parameters even if mods fail
        applyUrlParameters();
    });

    // Add event listeners to form inputs to regenerate config on change
    document.getElementById('serverForm').addEventListener('change', generateConfig);
    document.getElementById('serverForm').addEventListener('keyup', generateConfig);


    console.log("Initial DOM Content Loaded setup complete.");
});
        
// This code integrates with your Google App Script backend
// to fetch popular mutator suggestions based on collected data

function createInfoModal() {
  if (document.getElementById('suggestionInfoModal')) {
    // If the modal already exists, just return (we'll show it elsewhere)
    return;
  }
  
  const modalHTML = `
    <div id="suggestionInfoModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Mod-Based Mutator Suggestions</h2>
        <p>Many Insurgency: Sandstorm mods require specific mutators to be enabled to work correctly.</p>
        <p>This feature will automatically suggest appropriate mutators based on the mods you select.</p>
        
        <div class="suggestion-examples">
          <h3>Common Mod-Mutator Combinations:</h3>
          <ul>
            <li><strong>ISMC Mods</strong> → Use with <code>ISMC_Casual</code> mutator</li>
            <li><strong>Shoot House</strong> → Use with <code>Competitive</code> mutator</li>
            <li><strong>Night Maps</strong> → Often work best with <code>Hardcore</code> mutator</li>
          </ul>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
          <label>
            <input type="checkbox" id="dontShowAgain"> Don't show this message again
          </label>
        </div>
        <button class="btn btn-primary" style="margin-top: 15px; float: right;" onclick="closeInfoModal()">Got it!</button>
      </div>
    </div>
  `;
  
  // Add some additional styling
  const modalStyle = document.createElement('style');
  modalStyle.textContent = `
    #suggestionInfoModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    #suggestionInfoModal .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    #suggestionInfoModal .close {
      position: absolute;
      top: 15px;
      right: 20px;
      cursor: pointer;
      font-size: 24px;
      color: #666;
    }
    
    #suggestionInfoModal .close:hover {
      color: #000;
    }
    
    .suggestion-examples {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
    }
    
    .suggestion-examples ul {
      padding-left: 20px;
    }
    
    .suggestion-examples li {
      margin-bottom: 8px;
    }
    
    .suggestion-examples code {
      background-color: #e9ecef;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  `;
  
  // Append the modal and styles to the document
  document.head.appendChild(modalStyle);
  const modalContainer = document.createElement('div');
  modalContainer.innerHTML = modalHTML;
  document.body.appendChild(modalContainer.firstElementChild);
  
  // Add event listener for close button
  document.querySelector('#suggestionInfoModal .close').addEventListener('click', closeInfoModal);
}


// Fix 3: Improve the notification system
function createNotificationElement() {
  if (document.getElementById('notification')) return;
  
  const notificationElement = document.createElement('div');
  notificationElement.id = 'notification';
  notificationElement.className = 'notification';
  notificationElement.style.position = 'fixed';
  notificationElement.style.bottom = '20px';
  notificationElement.style.right = '20px';
  notificationElement.style.backgroundColor = '#4CAF50';
  notificationElement.style.color = 'white';
  notificationElement.style.padding = '15px 20px';
  notificationElement.style.borderRadius = '4px';
  notificationElement.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
  notificationElement.style.zIndex = '1000';
  notificationElement.style.transition = 'opacity 0.5s ease';
  notificationElement.style.opacity = '0';
  
  document.body.appendChild(notificationElement);
}

// Fix 4: Create the suggestions container properly
function createSuggestionsContainer() {
  if (document.getElementById('mutatorSuggestions')) {
    console.log("Suggestions container already exists");
    return;
  }
  
  const modsTab = document.getElementById('mods');
  if (!modsTab) {
    console.error("Mods tab not found!");
    return;
  }
  
  const suggestionsContainer = document.createElement('div');
  suggestionsContainer.id = 'mutatorSuggestions';
  suggestionsContainer.className = 'mutator-suggestions';
  
  // Explicit styling to ensure visibility
  suggestionsContainer.style.marginTop = '20px';
  suggestionsContainer.style.padding = '15px';
  suggestionsContainer.style.backgroundColor = '#e3f2fd';
  suggestionsContainer.style.borderRadius = '4px';
  suggestionsContainer.style.borderLeft = '4px solid #2196F3';
  suggestionsContainer.style.display = 'none'; // Initially hidden until we have suggestions
  
  const suggestionsTitle = document.createElement('h3');
  suggestionsTitle.textContent = 'Suggested Mutators ';
  
  const refreshButton = document.createElement('button');
  refreshButton.id = 'refreshSuggestions';
  refreshButton.className = 'btn btn-secondary btn-sm';
  refreshButton.textContent = 'Refresh Suggestions';
  refreshButton.onclick = fetchMutatorSuggestionsFromGAS;
  
  suggestionsTitle.appendChild(refreshButton);
  suggestionsContainer.appendChild(suggestionsTitle);
  
  const suggestionsContent = document.createElement('div');
  suggestionsContent.id = 'suggestionsContent';
  suggestionsContainer.appendChild(suggestionsContent);
  
  // Find the best place to insert it
  const selectedModsOutput = document.getElementById('selectedModsOutput');
  if (selectedModsOutput && selectedModsOutput.parentNode) {
    selectedModsOutput.parentNode.insertBefore(suggestionsContainer, selectedModsOutput.nextSibling);
    console.log("Inserted suggestions container after selectedModsOutput");
  } else {
    // Fallback - add to the end of the mods tab
    modsTab.appendChild(suggestionsContainer);
    console.log("Appended suggestions container to mods tab");
  }
  
  console.log("Suggestions container created with ID:", suggestionsContainer.id);
}

// Fix 5: More reliable JSONP handling
function fetchMutatorSuggestionsFromGAS() {
  try {
    // Show loading state
    showNotification("Fetching mutator suggestions...", "info");
    
    // Clean URL without any redirects
    const gasUrl = "https://script.google.com/macros/s/AKfycbyNTg4bdelp719MfGOBZePkX64zrYuQe8y9uMTlHFcwIVuO1yTcKwic33amzMD66Dex/exec";
    
    // Generate a unique callback function name
    const callbackName = 'gasCallback_' + Math.floor(Math.random() * 1000000);
    
    // Build query params - include selected mods if any
    let queryParams = `?action=getSuggestions&callback=${callbackName}&t=${Date.now()}`;
    
    // Add selected mod IDs to query if available
    if (selectedMods && selectedMods.length > 0) {
      console.log("Selected mod IDs to send:", selectedMods.map(mod => mod.id));
      const modIds = selectedMods.map(mod => String(mod.id)).join(',');
      queryParams += `&mods=${modIds}`;
    }
    
    console.log("Fetching from GAS with URL:", gasUrl + queryParams);
    
    // Create a script element for JSONP
    const script = document.createElement('script');
    script.src = gasUrl + queryParams;
    
    // Define the callback function
    window[callbackName] = function(data) {
      // Clean up
      if (script.parentNode) {
        document.head.removeChild(script);
      }
      
      delete window[callbackName];
      
      // Process the data
      console.log("Received suggestions from GAS:", data);
      
      if (data && data.success) {
        if (data.suggestions && Object.keys(data.suggestions).length > 0) {
          // If we got actual suggestions, update our database
          console.log("Received new suggestions from GAS:", data.suggestions);
          Object.assign(modMutatorSuggestions, data.suggestions);
          showNotification("Mutator suggestions updated!", "success");
        } else {
          console.log("No new suggestions in GAS response. Using existing suggestions.");
          showNotification("Using local suggestions", "info");
        }
        
        // Log our current suggestions database
        console.log("Current modMutatorSuggestions:", modMutatorSuggestions);
        
        // Always update UI
        updateMutatorSuggestions();
      }
    };
    
    // Add the script to the document to start the request
    document.head.appendChild(script);
    
  } catch (error) {
    console.error("Error in fetchMutatorSuggestionsFromGAS:", error);
    showNotification("Error loading suggestions", "error");
    
    // Fallback to existing suggestions
    updateMutatorSuggestions();
  }
}
// Fix 6: Improved updateMutatorSuggestions function
// Update the display of mutator suggestions, attaching mod data to buttons
function updateMutatorSuggestions() {
    const suggestionsContainer = document.getElementById('mutatorSuggestions');
    const suggestionsContent = document.getElementById('suggestionsContent');

    if (!suggestionsContainer || !suggestionsContent) {
        console.error("Suggestions container or content element not found");
        return;
    }
    suggestionsContent.innerHTML = ''; // Clear previous

    if (!selectedMods || selectedMods.length === 0) {
        suggestionsContainer.style.display = 'none';
        return;
    }

    const relevantSuggestions = [];
    selectedMods.forEach(mod => {
        const modIdStr = String(mod.id);
        if (modMutatorSuggestions[modIdStr]) {
            relevantSuggestions.push({
                mod: mod, // Keep the whole mod object
                suggestion: modMutatorSuggestions[modIdStr]
            });
        }
    });

    if (relevantSuggestions.length === 0) {
        suggestionsContainer.style.display = 'none';
        return;
    }

    suggestionsContainer.style.display = 'block';
    suggestionsContent.innerHTML = `<p>Recommended mutators for your selected mods:</p>`;
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'suggestion-cards';
    cardsContainer.style.display = 'flex';
    cardsContainer.style.flexWrap = 'wrap';
    cardsContainer.style.gap = '15px';
    cardsContainer.style.marginTop = '10px';

    relevantSuggestions.forEach(item => {
        const mutatorName = item.suggestion.suggestedMutator;
        const isApplied = selectedMutators.includes(mutatorName);

        const suggestionBox = document.createElement('div');
        suggestionBox.className = 'suggestion-box';
        suggestionBox.innerHTML = `
            <div class="suggestion-mod-name">Mod: ${item.mod.name}</div>
            <div class="suggestion-mutator-name">Suggests: ${mutatorName}</div>
            <div class="suggestion-description">${item.suggestion.description || 'Recommended for this mod.'}</div>
        `;

        const applyButton = document.createElement('button');
        applyButton.dataset.mutatorName = mutatorName;
        applyButton.className = 'btn apply-suggestion';

        // --- NEW: Attach suggesting mod data to the button ---
        applyButton.suggestingModData = { // Store necessary mod info
             name: item.mod.name,
             summary: item.mod.summary || '' // Include summary if available
        };
        // --- END NEW ---

        if (isApplied) {
            applyButton.textContent = 'Applied';
            applyButton.classList.add('btn-success');
            applyButton.style.backgroundColor = '#28a745';
            applyButton.style.color = 'white';
        } else {
            applyButton.textContent = 'Apply This Mutator';
            applyButton.classList.add('btn-primary');
        }

        // --- MODIFIED: Pass the mod data in the onclick call ---
        applyButton.onclick = function() {
            // Pass mutator name, button element, and the attached mod data
            applyMutatorSuggestion(this.dataset.mutatorName, this, this.suggestingModData);
        };
        // --- END MODIFIED ---

        suggestionBox.appendChild(applyButton);
        cardsContainer.appendChild(suggestionBox);
    });

    suggestionsContent.appendChild(cardsContainer);
}

function showNotification(message, type = "info") {
  const notification = document.getElementById('notification');
  if (!notification) return;
  
  // Clear any existing timeout
  if (window.notificationTimeout) {
    clearTimeout(window.notificationTimeout);
  }
  
  // Set the message
  notification.textContent = message;
  notification.className = "notification show";
  
  // Set color based on type
  notification.style.backgroundColor = 
    type === "success" ? "#4CAF50" : 
    type === "error" ? "#F44336" : 
    type === "warning" ? "#FF9800" : "#2196F3";
  
  // Hide after 3 seconds
  window.notificationTimeout = setTimeout(() => {
    notification.className = "notification";
  }, 3000);
}

// Fix 8: Modal display functions
function showSuggestionInfoModal() {
  createInfoModal();
  
  // Only show if user hasn't dismissed it before
  if (localStorage.getItem('suggestionInfoDismissed') !== 'true') {
    const modal = document.getElementById('suggestionInfoModal');
    if (modal) {
      modal.style.display = 'block';
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.transition = 'opacity 0.3s ease';
        modal.style.opacity = '1';
      }, 50);
    }
  }
}
function checkSuggestionContainerVisibility() {
  const container = document.getElementById('mutatorSuggestions');
  if (!container) {
    console.error("Mutator suggestions container not found!");
    return;
  }
  
  console.log("Mutator suggestions container:", {
    display: container.style.display,
    visibility: window.getComputedStyle(container).visibility,
    height: window.getComputedStyle(container).height,
    element: container
  });
  
  // Force visibility
  container.style.removeProperty('display');
  container.style.display = 'block';
  container.style.visibility = 'visible';
  
  console.log("Forced visibility on container");
}
        
function closeInfoModal() {
  const modal = document.getElementById('suggestionInfoModal');
  if (modal) {
    // Animate the modal closing
    modal.style.transition = 'opacity 0.3s ease';
    modal.style.opacity = '0';
    
    // After animation completes, hide the modal
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
    
    // Check if "don't show again" is checked
    const dontShowAgain = document.getElementById('dontShowAgain');
    if (dontShowAgain && dontShowAgain.checked) {
      localStorage.setItem('suggestionInfoDismissed', 'true');
    }
  }
}

// Fix 9: Function to apply a suggested mutator
// Apply a suggested mutator - MODIFIED to use suggesting mod info for new descriptions
function applyMutatorSuggestion(mutatorName, buttonElement, suggestingMod) { // Added suggestingMod parameter
    const isAlreadyApplied = selectedMutators.includes(mutatorName);

    if (isAlreadyApplied) {
        // Deselect logic (optional, as implemented before)
        const index = selectedMutators.indexOf(mutatorName);
        if (index !== -1) {
            selectedMutators.splice(index, 1);
        }
        buttonElement.textContent = 'Apply This Mutator';
        buttonElement.classList.remove('btn-success');
        buttonElement.style.backgroundColor = '';
        buttonElement.classList.add('btn-primary');
        showNotification(`Deselected mutator: ${mutatorName}`, "info");

    } else {
        // Apply the mutator
        const isStandard = mutators.some(m => m.name === mutatorName);
        const isCustom = customMutators.some(m => m.name === mutatorName);

        // --- MODIFIED: Create specific description if adding a new custom mutator ---
        if (!isStandard && !isCustom) {
            let newDescription = 'Added via suggestion'; // Default fallback
            if (suggestingMod && suggestingMod.name) {
                 newDescription = `Suggested for mod: ${suggestingMod.name}`;
                 // Optional: Add summary if you want it too
                 // if (suggestingMod.summary) {
                 //     newDescription += ` (${suggestingMod.summary})`;
                 // }
            }

            const newMutator = {
                name: mutatorName,
                description: newDescription, // Use the specific description
                isCustom: true
            };
            customMutators.push(newMutator);
            localStorage.setItem('customMutators', JSON.stringify(customMutators));
            console.log(`Added new custom mutator '${mutatorName}' with description: ${newDescription}`);
        }
        // --- END MODIFIED ---

        // Add to selected list if not already there
        if (!selectedMutators.includes(mutatorName)) {
            selectedMutators.push(mutatorName);
        }

        // Update the button state
        buttonElement.textContent = 'Applied';
        buttonElement.classList.remove('btn-primary');
        buttonElement.classList.add('btn-success');
        buttonElement.style.backgroundColor = '#28a745';
        buttonElement.style.color = 'white';

        showNotification(`Applied mutator: ${mutatorName}`, "success");
        logMutatorSelection(mutatorName); // Log if needed
    }

    // Update the underlying data and regenerate lists
    updateSelectedMutatorsDisplay();
    generateMutatorCheckboxes(); // Regenerate checkbox list on Mutators tab
}

// Fix 10: Initialize everything properly
function initMutatorSuggestions() {
  // Create UI elements
  createNotificationElement();
  createInfoModal();
  createSuggestionsContainer();
  
  // Hook into mod selection changes
  // We need to extend the existing updateSelectedModsDisplay function
  if (window.updateSelectedModsDisplay) {
    const originalUpdateSelectedModsDisplay = window.updateSelectedModsDisplay;
    window.updateSelectedModsDisplay = function() {
      // Call original function
      originalUpdateSelectedModsDisplay.apply(this, arguments);
      
      // Then update mutator suggestions
      updateMutatorSuggestions();
      
      // If mods are selected and we haven't already fetched suggestions in this session
      if (selectedMods && selectedMods.length > 0 && !window.hasFetchedSuggestions) {
        fetchMutatorSuggestionsFromGAS();
        window.hasFetchedSuggestions = true;
      }
    };
  }
  
  // Add a global function for other scripts to access
  window.showSuggestionModal = showSuggestionInfoModal;
  window.closeSuggestionModal = closeInfoModal;
  
  // Show info modal after a short delay
  setTimeout(showSuggestionInfoModal, 1000);
  
  // Update suggestions initially with the built-in data
  updateMutatorSuggestions();
}


// 4. Function to log when a user applies a suggested mutator
function logMutatorSelection(mutatorName) {
  if (!selectedMods || selectedMods.length === 0) return;
  
  // Basic input validation
  if (!mutatorName || typeof mutatorName !== 'string' || mutatorName.length > 100) return;
  
  // Prepare data to send - limit what we collect
  const data = {
    timestamp: new Date().toISOString(),
    mutator: mutatorName,
    source: 'suggestion', // Indicate this was from a suggestion
    mods: selectedMods.map(mod => ({
      id: mod.id,
      name: mod.name.substring(0, 100) // Limit name length
    })).slice(0, 20) // Limit number of mods
  };
  
  // Add a nonce to prevent replay attacks
  const nonce = Math.random().toString(36).substring(2, 15);
  data.nonce = nonce;
  
  // Send data to GAS Web App
  fetch('https://script.google.com/macros/s/AKfycbyNTg4bdelp719MfGOBZePkX64zrYuQe8y9uMTlHFcwIVuO1yTcKwic33amzMD66Dex/exec', {
    method: 'POST',
    mode: 'no-cors', // Important for GAS web apps
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  }).catch(error => {
    console.error('Error logging mutator selection:', error);
    // Silently fail - don't interrupt user experience
  });
}
        
        // Mutators data
	const mutators = [
	    { name: 'AllYouCanEat', description: 'Start with 100 supply points.' },
	    { name: 'AntiMaterielRiflesOnly', description: 'Only anti-materiel rifles are available along with normal equipment and explosives.' },
	    { name: 'ArmsRace', description: 'Every two kills give a new weapon. A kill with the final weapon wins the round.' },
	    { name: 'BoltActionsOnly', description: 'Only bolt-action rifles are available along with normal equipment and explosives.' },
	    { name: 'Broke', description: 'Start with 0 supply points.' },
	    { name: 'BudgetAntiquing', description: 'Normal equipment and explosives, but limited to old and inexpensive weapons.' },
	    { name: 'BulletSponge', description: 'Health is increased.' },
	    { name: 'Competitive', description: 'Equipment is more expensive, rounds are shorter, and capturing objectives is faster.' },
	    { name: 'CompetitiveLoadouts', description: 'Player classes are replaced with those from Competitive.' },
	    { name: 'DesertEaglesOnly', description: 'Only Desert Eagle pistols are available along with normal equipment and explosives.' },
	    { name: 'FastMovement', description: 'Move Faster.' },
	    { name: 'Frenzy', description: 'Fight against AI enemies who only use melee attacks. Watch out for special enemies.' },
	    { name: 'FullyLoaded', description: 'All weapons, equipment, and explosives in the game are available in the Loadout Menu' },
	    { name: 'GrenadeLaunchersOnly', description: 'Only Grenade Launchers are available.' },
	    { name: 'Guerrillas', description: 'Start with 5 supply points.' },
	    { name: 'Gunslingers', description: 'Kill the enemy more than they kill you with a big stinkin\' revolver. And explosives.' },
	    { name: 'Hardcore', description: 'Mutator featuring slower movement speeds and longer capture times.' },
	    { name: 'HeadshotOnly', description: 'Players only take damage when shot in the head.' },
	    { name: 'HotPotato', description: 'A live fragmentation grenade is dropped on death.' },
	    { name: 'LMGOnly', description: 'Only light machine guns are available along with normal equipment and explosives.' },
	    { name: 'LockedAim', description: 'Weapons always point to the center of the screen.' },
	    { name: 'MakarovsOnly', description: 'Makarovs are the only option.' },
	    { name: 'NoAim', description: 'Aiming down sights is disabled.' },
	    { name: 'NoDeathCam', description: 'Forces the death camera to be disabled for all players.' },
	    { name: 'NoDrops', description: 'No scavenging allowed.' },
	    { name: 'NoThirdPerson', description: 'The third person camera for spectator mode is disabled.' },
	    { name: 'OfficialRules', description: 'All gamemodes are forced to default rules.' },
	    { name: 'PistolsOnly', description: 'Only pistols are available along with normal equipment and explosives.' },
	    { name: 'Poor', description: 'Start with limited supply.' },
	    { name: 'ShotgunsOnly', description: 'Only Shotguns are available along with normal equipment and explosives.' },
	    { name: 'SlowCaptureTimes', description: 'Objectives will take longer to capture.' },
	    { name: 'SlowMovement', description: 'Move slower.' },
	    { name: 'SmallFirefight', description: 'Adjusts Firefight to suit a smaller player count by adjusting round count, round timer, and capture times.' },
	    { name: 'SoldierOfFortune', description: 'Gain supply points as your score increases.' },
	    { name: 'SpecialOperations', description: 'Start with 30 supply points.' },
	    { name: 'Strapped', description: 'Start with 1 supply point.' },
	    { name: 'TacticalVoiceChat', description: 'Allows dead players to speak to the living, disables proximity chat to the enemy.' },
	    { name: 'TieBreaker', description: 'In Firefight, enable overtime and replaying rounds in the event of a draw.' },
	    { name: 'Ultralethal', description: 'Everyone dies with one shot.' },
	    { name: 'Vampirism', description: 'Receive health when dealing damage to enemies equal to the amount of damage dealt.' },
	    { name: 'Warlords', description: 'Start with 10 supply points.' },
	    { name: 'Welrods', description: 'Every player is forced to use the bolt-action Welrod pistol.' },
	    { name: 'WelrodsOnly', description: 'Only bolt-action Welrod pistols are available along with normal equipment and explosives.' }
	];
        
        function logCustomMutatorToGAS(mutatorName) {
          // Only send if user has mods selected
          if (!selectedMods || selectedMods.length === 0) return;
          
          // Basic input validation
          if (!mutatorName || typeof mutatorName !== 'string' || mutatorName.length > 100) return;
          
          // Prepare data to send - limit what we collect
          const data = {
            timestamp: new Date().toISOString(),
            mutator: mutatorName,
            mods: selectedMods.map(mod => ({
              id: mod.id,
              name: mod.name.substring(0, 100) // Limit name length
            })).slice(0, 20) // Limit number of mods to prevent abuse
          };
          
          // Add a random delay to prevent timing attacks (50-200ms)
          const randomDelay = 50 + Math.floor(Math.random() * 150);
          setTimeout(() => {
            // Add a nonce to prevent replay attacks
            const nonce = Math.random().toString(36).substring(2, 15);
            data.nonce = nonce;
            
            // Rate limiting - check if we've sent too many requests recently
            const recentRequests = localStorage.getItem('recentGASRequests') || '[]';
            let requests = JSON.parse(recentRequests);
            const now = Date.now();
            
            // Keep only requests from the last minute
            requests = requests.filter(time => now - time < 60000);
            
            // If we've made more than 5 requests in the last minute, don't send another
            if (requests.length >= 5) {
              console.log('Rate limited: Too many requests to GAS');
              return;
            }
            
            // Add this request time
            requests.push(now);
            localStorage.setItem('recentGASRequests', JSON.stringify(requests));
            
            // Send data to GAS Web App (replace with your actual GAS URL)
            fetch('https://script.google.com/macros/s/AKfycbyNTg4bdelp719MfGOBZePkX64zrYuQe8y9uMTlHFcwIVuO1yTcKwic33amzMD66Dex/exec', {
              method: 'POST',
              mode: 'no-cors', // Important for GAS web apps
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            }).catch(error => {
              console.error('Error logging custom mutator:', error);
              // Silently fail - don't interrupt user experience
            });
          }, randomDelay);
        }

        // Tab switching
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;

            // Get all elements with class="tab-content" and hide them
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                // Remove the active class from all content divs
                tabcontent[i].classList.remove("active");
            }

            // Get all elements with class="tab" and remove the class "active"
            tablinks = document.getElementsByClassName("tab");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            // Get the specific tab content element to show
            const currentTabContent = document.getElementById(tabName);

            // Show the current tab content, and add an "active" class to it
            if (currentTabContent) {
                currentTabContent.style.display = "block";
                currentTabContent.classList.add("active");
            }

            // Add the "active" class to the button that opened the tab
            if (evt && evt.currentTarget) {
              evt.currentTarget.classList.add("active");
            }
        }

        // === MODIFIED/NEW SERVER CONFIGURATION FUNCTIONS ===
        
        /**
         * Generates the server configuration string for the text area
         * AND the steam:// launch URL for the launch link. This is now the
         * single source of truth for the server command line.
         */
function generateConfig() {
    const os = document.getElementById('os').value;
    const steamParamsString = getServerParamsString(); // Use the helper
    const launchLink = document.getElementById('launchLink');
    const baseCommand = os === "windows" ?
        "InsurgencyServer.exe" :
        "Insurgency/Binaries/Linux/InsurgencyServer-Linux-Shipping";
    
    // Update the text area
    document.getElementById('configOutput').value = `${baseCommand} ${steamParamsString}`;

    // Update the main "Launch Server" link
    if (launchLink) {
        const steamURL = `steam://rungameid/581330//${encodeURIComponent(steamParamsString)}`;
        launchLink.href = steamURL;
    }
}

        /**
         * The launchServer function is now removed, as the <a> tag handles launching.
         * This function remains to power the Quick Launch button.
         */
        function quickStart() {
            document.getElementById('hostname').value = 'My Insurgency Server';
            document.getElementById('maxPlayers').value = '24';
            document.getElementById('port').value = '27102';
            document.getElementById('queryPort').value = '27131';
            
            const scenarioDropdown = document.getElementById('scenario');
            const randomIndex = Math.floor(Math.random() * scenarioDropdown.options.length);
            scenarioDropdown.selectedIndex = randomIndex;
            
            // First, generate the config and update the link's href
            generateConfig();
            
            // Then, programmatically click the link to launch the game
            document.getElementById('launchLink').click();
        }
        
        // === END MODIFIED/NEW FUNCTIONS ===

        // Preset functions
        function savePreset() {
            const presetName = prompt('Enter a name for the preset:');
            if (!presetName) return;
            
            const preset = {
                name: presetName,
                os: document.getElementById('os').value,
                hostname: document.getElementById('hostname').value,
                maxPlayers: document.getElementById('maxPlayers').value,
                port: document.getElementById('port').value,
                queryPort: document.getElementById('queryPort').value,
                scenario: document.getElementById('scenario').value,
                password: document.getElementById('password').value,
                enableCheats: document.getElementById('enableCheats').checked,
                gameStatsToken: document.getElementById('gameStatsToken').value,
                gsltToken: document.getElementById('gsltToken').value,
                enableGameStats: document.getElementById('enableGameStats').checked,
                officialRules: document.getElementById('officialRules').checked,
                selectedMutators: [...selectedMutators],
                selectedMods: [...selectedMods]
            };
            
            let presets = JSON.parse(localStorage.getItem('presets') || '[]');
            presets.push(preset);
            localStorage.setItem('presets', JSON.stringify(presets));
            renderPresetButtons(presets);
        }

        function loadPresetsFromStorage() {
            const presets = JSON.parse(localStorage.getItem('presets') || '[]');
            renderPresetButtons(presets);
        }

        function renderPresetButtons(presets) {
            const presetButtonsContainer = document.getElementById('presetButtons');
            presetButtonsContainer.innerHTML = '';
            
            presets.forEach((preset, index) => {
                const presetDiv = document.createElement('div');
                presetDiv.className = 'preset';

                const presetNameSpan = document.createElement('span');
                presetNameSpan.textContent = preset.name;

                const launchButton = document.createElement('button');
                launchButton.textContent = 'Launch';
                launchButton.className = 'btn btn-primary';
                launchButton.onclick = function() {
                    loadPreset(index);
                    // After loading, click the main launch link
                    document.getElementById('launchLink').click();
                };

                const renameButton = document.createElement('button');
                renameButton.textContent = 'Rename';
                renameButton.className = 'btn btn-secondary';
                renameButton.onclick = function() {
                    renamePreset(index);
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'btn btn-danger';
                deleteButton.onclick = function() {
                    deletePreset(index);
                };

                presetDiv.appendChild(presetNameSpan);
                presetDiv.appendChild(launchButton);
                presetDiv.appendChild(renameButton);
                presetDiv.appendChild(deleteButton);

                presetButtonsContainer.appendChild(presetDiv);
            });
        }

        function deletePreset(index) {
            const presets = JSON.parse(localStorage.getItem('presets') || '[]');
            presets.splice(index, 1);
            localStorage.setItem('presets', JSON.stringify(presets));
            renderPresetButtons(presets);
        }

        function renamePreset(index) {
            const presets = JSON.parse(localStorage.getItem('presets') || '[]');
            const newName = prompt('Enter a new name for the preset:', presets[index].name);
            if (newName) {
                presets[index].name = newName;
                localStorage.setItem('presets', JSON.stringify(presets));
                renderPresetButtons(presets);
            }
        }

        function loadPreset(index) {
            const presets = JSON.parse(localStorage.getItem('presets') || '[]');
            const preset = presets[index];
            if (!preset) return;
            
            document.getElementById('os').value = preset.os;
            document.getElementById('hostname').value = preset.hostname;
            document.getElementById('maxPlayers').value = preset.maxPlayers;
            document.getElementById('port').value = preset.port;
            document.getElementById('queryPort').value = preset.queryPort;
            document.getElementById('scenario').value = preset.scenario;
            document.getElementById('password').value = preset.password;
            document.getElementById('enableCheats').checked = preset.enableCheats;
            document.getElementById('gameStatsToken').value = preset.gameStatsToken;
            document.getElementById('gsltToken').value = preset.gsltToken;
            document.getElementById('enableGameStats').checked = preset.enableGameStats;
            document.getElementById('officialRules').checked = preset.officialRules;
            
            // Load saved mutators and mods
            selectedMutators = preset.selectedMutators || [];
            selectedMods = preset.selectedMods || [];
            
            updateMutatorCheckboxes();
            updateModCheckboxes();
            updateSelectedMutatorsDisplay();
            updateSelectedModsDisplay();
            generateConfig(); // <<< NEW: Regenerate config after loading a preset.
        }

        function exportPresets() {
            const presets = JSON.parse(localStorage.getItem('presets') || '[]');
            const presetsJSON = JSON.stringify(presets, null, 2);
            const blob = new Blob([presetsJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'insurgency_server_presets.json';
            link.click();
        }

        function importPresets() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'application/json';
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const presetsJSON = e.target.result;
                        const presets = JSON.parse(presetsJSON);
                        localStorage.setItem('presets', JSON.stringify(presets));
                        renderPresetButtons(presets);
                        alert('Presets imported successfully!');
                    } catch (error) {
                        alert('Error importing presets: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            fileInput.click();
        }




        // Mod functions
		// Function to fetch mods and sort them immediately
        // Mod functions
        async function fetchMods() {
            try {
                // Add timestamp as query parameter to prevent caching
                const timestamp = new Date().getTime();
                // Ensure the URL is correct and accessible
                const response = await fetch(`https://extremelystiff.github.io/ISSL/mods.json?t=${timestamp}`);
                if (!response.ok) {
                    // More specific error for debugging
                    throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
                }

                let fetchedMods = await response.json();

                // --- Sort fetched mods alphabetically by name ---
                // Add safety check here too, just in case fetched data is inconsistent
                 sortedMods = fetchedMods.sort((a, b) => {
                     const nameA = (a && typeof a.name === 'string') ? a.name : '';
                     const nameB = (b && typeof b.name === 'string') ? b.name : '';
                     return nameA.localeCompare(nameB);
                 });
                // --- END ---

                generateModCheckboxes(); // Generate using the sorted list
                console.log('Fetched and sorted mods:', sortedMods);

            } catch (error) {
                // Log the specific error that occurred during fetch/parse
                console.error('Error fetching or parsing mods:', error);
                alert('Failed to fetch mods. Using default list. Please check console for errors.');

                // Fallback list
                let fallbackMods = [
                     { id: 81844, name: "Example Content", summary: "Example Content from mod kit." },
                     { id: 89591, name: "Shoot House", summary: "Shoot House" },
                     { id: 91912, name: "Wolf-land (Nightfall 1.7 Update)", summary: "Update 0.6 - Added Night Lighting Scenario, temporarily disabled Checkpoint, various cover tweaks" },
                     { id: 92807, name: "M45A1 Wolfpack", summary: "Black variant of the M45A1" }
                ];

                // --- MODIFIED: Sort fallback mods safely ---
                sortedMods = fallbackMods.sort((a, b) => {
                    // Safety checks: Ensure a/b are objects and a.name/b.name are strings
                    const nameA = (a && typeof a.name === 'string') ? a.name : '';
                    const nameB = (b && typeof b.name === 'string') ? b.name : '';
                    // Compare the safe names (defaults to '' if invalid)
                    return nameA.localeCompare(nameB);
                });
                // --- END MODIFIED ---

                console.log('Using fallback mods (sorted):', sortedMods);
                generateModCheckboxes(); // Generate using the sorted fallback list
            }
        }

		// Generate mod checkboxes using the pre-sorted 'sortedMods' list
		function generateModCheckboxes() {
			const modCheckboxesContainer = document.getElementById('modCheckboxes');
			modCheckboxesContainer.innerHTML = ''; // Clear previous

			// Use the globally sorted 'sortedMods' array
			if (!sortedMods || sortedMods.length === 0) {
				modCheckboxesContainer.innerHTML = '<p>No mods available. Please try refreshing the mod list.</p>';
				return;
			}

			// --- NEW: Create separate containers for visual grouping ---
			const enabledModsSection = document.createElement('div');
			enabledModsSection.id = 'enabledModsSection';
			enabledModsSection.style.marginBottom = '25px'; // Space below enabled mods

			const availableModsSection = document.createElement('div');
			availableModsSection.id = 'availableModsSection';

			const enabledModItems = [];
			const availableModItems = [];
			// --- END NEW ---


			sortedMods.forEach(mod => {
				const isSelected = selectedMods.some(selectedMod => selectedMod.id === mod.id);

				// Create the checkbox item (same logic as before)
				const checkboxItem = document.createElement('div');
				checkboxItem.className = 'checkbox-item mod-item'; // Add 'mod-item' for search

				const checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.value = mod.id;
				checkbox.id = `mod-${mod.id}`;
				checkbox.checked = isSelected;
				checkbox.addEventListener('change', function() {
					const modId = parseInt(this.value); // Ensure ID is number for comparison if needed
					if (this.checked) {
						const modToAdd = sortedMods.find(m => m.id === modId);
						if (modToAdd && !selectedMods.some(sm => sm.id === modId)) {
							selectedMods.push(modToAdd);
							logSelectedCustomMutators(); // Keep if needed
						}
					} else {
						selectedMods = selectedMods.filter(sm => sm.id !== modId);
					}
					updateSelectedModsDisplay(); // This triggers suggestion updates
					generateModCheckboxes(); // Re-render the list to move the item between sections
                    generateConfig(); // <<< NEW: Update link/config on change
				});

				const label = document.createElement('label');
				label.htmlFor = checkbox.id;
				label.textContent = mod.name;

				const description = document.createElement('div');
				description.className = 'item-description';
				description.textContent = mod.summary || 'No description available';
				description.style.marginLeft = '10px'; // Space after label

				checkboxItem.appendChild(checkbox);
				checkboxItem.appendChild(label);
				checkboxItem.appendChild(description);

				// --- NEW: Add to the correct list/section ---
				if (isSelected) {
					enabledModItems.push(checkboxItem);
				} else {
					availableModItems.push(checkboxItem);
				}
				// --- END NEW ---
			});

			// --- NEW: Append items to their respective sections with headers ---
			// 1. Enabled Section
			if (enabledModItems.length > 0) {
				const enabledHeader = document.createElement('h4');
				enabledHeader.textContent = `Enabled Mods (${enabledModItems.length})`;
				enabledHeader.style.marginBottom = '10px';
				enabledModsSection.appendChild(enabledHeader);
				// Style this section slightly differently?
				enabledModsSection.style.border = '1px solid #d1ecf1';
				enabledModsSection.style.backgroundColor = '#f8f9fa';
				enabledModsSection.style.padding = '15px';
				enabledModsSection.style.borderRadius = '5px';

				enabledModItems.forEach(item => enabledModsSection.appendChild(item));
				modCheckboxesContainer.appendChild(enabledModsSection); // Add section to main container
			}

			// 2. Available Section
			if (availableModItems.length > 0) {
				 const availableHeader = document.createElement('h4');
				 availableHeader.textContent = 'Available Mods';
				 // Add margin top only if there *was* an enabled section
				 if (enabledModItems.length > 0) {
					 availableHeader.style.marginTop = '20px';
				 }
				 availableHeader.style.marginBottom = '10px';
				 availableModsSection.appendChild(availableHeader);

				availableModItems.forEach(item => availableModsSection.appendChild(item));
				modCheckboxesContainer.appendChild(availableModsSection); // Add section to main container
			}
			// --- END NEW ---

			// We still call updateSelectedModsDisplay to update the separate text list below
			updateSelectedModsDisplay();
			console.log("Mod checkboxes generated with enabled/available sections.");
		}

        function updateModCheckboxes() {
            const checkboxes = document.querySelectorAll('#modCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const modId = parseInt(checkbox.value);
                checkbox.checked = selectedMods.some(mod => mod.id === modId);
            });
            generateConfig(); // Update link/config
        }

        // Modify the updateSelectedModsDisplay function to trigger suggestion updates
        function updateSelectedModsDisplay() {
          const output = document.getElementById('selectedModsOutput');
          if (selectedMods.length === 0) {
            output.textContent = 'No mods selected';
          } else {
            let modInfo = selectedMods.map(mod => `${mod.name} (ID: ${mod.id})`).join('\n');
            output.textContent = modInfo;
          }
          
          // Always update mutator suggestions when mod selection changes
          updateMutatorSuggestions();
          
          // If mods are selected, fetch the latest suggestions
          if (selectedMods.length > 0) {
            fetchMutatorSuggestionsFromGAS();
          }
        }

		// Update search function to look in both sections if they exist
		function searchMods() {
			const searchTerm = document.getElementById('modSearch').value.toLowerCase();

			// Target all items within both potential sections
			const checkboxItems = document.querySelectorAll('#enabledModsSection .mod-item, #availableModsSection .mod-item');

			checkboxItems.forEach(item => {
				const label = item.querySelector('label')?.textContent.toLowerCase() || ''; // Safe access
				const description = item.querySelector('.item-description')?.textContent.toLowerCase() || ''; // Safe access

				if (label.includes(searchTerm) || description.includes(searchTerm)) {
					item.style.display = ''; // Show if matches
				} else {
					item.style.display = 'none'; // Hide if doesn't match
				}
			});
		}

        // GameStats token auto-check enableGameStats
        document.getElementById('gameStatsToken').addEventListener('input', function(e) {
            document.getElementById('enableGameStats').checked = !!e.target.value.trim();
            generateConfig(); // Update link/config
        });
        
        // Modio info
        function setupModTabBehavior() {
          const tabButtons = document.querySelectorAll('.tab');
          tabButtons.forEach(button => {
            if (button.textContent.trim() === 'Mods') {
              button.addEventListener('click', function() {
                const modCheckboxesContainer = document.getElementById('modCheckboxes');
                if (!modCheckboxesContainer) return;

                if (sortedMods && sortedMods.length > 0) {
                  generateModCheckboxes();
                  console.log("Mods tab clicked: Regenerated mod list from existing data.");
                } else {
                  modCheckboxesContainer.innerHTML = '<p>Loading mod list...</p>';
                  console.log("Mods tab clicked: Mods not ready, showing loading. Attempting fetch.");
                  fetchMods().then(() => {
                     generateModCheckboxes();
                     checkAndShowApiSetupHelper();
                  }).catch(err => {
                     modCheckboxesContainer.innerHTML = '<p>Failed to load mod list. Please refresh the page.</p>';
                     console.error("Error fetching mods on tab click:", err);
                     checkAndShowApiSetupHelper();
                  });
                  return; 
                }
                setTimeout(() => {
                    checkAndShowApiSetupHelper();
                }, 50);
              });
            }
          });
        }

        function checkAndShowApiSetupHelper() {
          const hasApiToken = localStorage.getItem('modioApiToken');
          if (!hasApiToken) {
            showApiSetupHelper();
          }
        }

        function ensureModListIsVisible() {
            console.log("Ensuring mod list is visible after modal close/action.");
            const modCheckboxesContainer = document.getElementById('modCheckboxes');
            if (!modCheckboxesContainer) {
                console.error("Mod checkboxes container not found in ensureModListIsVisible.");
                return;
            }
            if (sortedMods && sortedMods.length > 0) {
                generateModCheckboxes();
            } else {
                modCheckboxesContainer.innerHTML = '<p>Mod list could not be loaded. Please try refreshing the page.</p>';
                console.warn("ensureModListIsVisible: sortedMods data is missing.");
            }
        }

        function showApiSetupHelper() {
          if (document.getElementById('apiSetupModal')) {
            document.getElementById('apiSetupModal').style.display = 'block';
            return;
          }

          const modalHTML = `
            <div id="apiSetupModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
              <div class="modal-content" style="background-color: white; margin: 10% auto; padding: 20px; border-radius: 5px; width: 80%; max-width: 700px; position: relative;">
                <span class="close" style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 24px;">×</span>
                <h2>Mod.io API Setup (Optional for this Tool)</h2>
                <p><strong>Note:</strong> An API token is needed for your <strong>game server</strong> to use mods, but this tool can list mods without it.</p>
                <p>Follow these steps if you want to set up your server:</p>

                <div class="setup-steps">
                  <h3>Step 1: Get your API token</h3>
                  <ol>
                    <li>Create or sign in to your <a href="https://mod.io" target="_blank">Mod.io account</a></li>
                    <li>Click your username at the top right, then click "API Access" from the left navigation</li>
                    <li>Under "OAuth 2 Management", look for "Generate Access Token"</li>
                    <li>Enter a name for your token (e.g., "My Sandstorm Server") and set it to "Read" access</li>
                    <li>Click "Create Token" and copy the generated token</li>
                  </ol>

                  <h3>Step 2: Enter your API token (Optional Storage)</h3>
                   <p>You can paste your token here to generate the config snippet, but it's primarily needed in your server's INI file.</p>
                  <div class="form-group">
                    <input type="text" id="apiTokenInput" placeholder="Paste your API token here" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                  </div>

                  <h3>Step 3: Save to GameUserSettings.ini</h3>
                  <p>Your token <strong>must</strong> be saved in this file on your server:</p>
                  <code style="display: block; background: #f5f5f5; padding: 10px; margin: 10px 0; word-break: break-all;">
                    \\sandstorm_server\\Insurgency\\Saved\\Config\\WindowsServer\\GameUserSettings.ini
                  </code>

                  <div class="generated-config" style="background: #f0f0f0; padding: 15px; margin: 15px 0; border-left: 3px solid #3498db;">
                    <h4>Copy this text to your GameUserSettings.ini file:</h4>
                    <pre id="iniConfigOutput" style="white-space: pre-wrap; word-break: break-all;"></pre>
                    <button id="copyIniConfig" class="btn btn-primary">Copy to Clipboard</button>
                  </div>
                </div>

                <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: space-between;">
                  <button id="remindLaterButton" class="btn btn-secondary">Close Helper</button>
                  <button id="saveApiToken" class="btn btn-primary">Save Token Locally & Close</button>
                </div>
              </div>
            </div>
          `;

          const modalContainer = document.createElement('div');
          modalContainer.innerHTML = modalHTML;
          document.body.appendChild(modalContainer.firstElementChild);

          document.querySelector('#apiSetupModal .close').addEventListener('click', function() {
            document.getElementById('apiSetupModal').style.display = 'none';
            ensureModListIsVisible();
          });
          document.getElementById('remindLaterButton').addEventListener('click', function() {
              document.getElementById('apiSetupModal').style.display = 'none';
              ensureModListIsVisible();
          });
          document.getElementById('apiTokenInput').addEventListener('input', updateIniConfig);
          document.getElementById('saveApiToken').addEventListener('click', saveApiToken);
          document.getElementById('copyIniConfig').addEventListener('click', copyIniConfig);
          updateIniConfig();
        }

        function updateIniConfig() {
          const token = document.getElementById('apiTokenInput').value.trim();
          const iniConfig = `[/Script/ModKit.ModIOClient]
        bHasUserAcceptedTerms=True
        AccessToken=${token || 'YOUR_TOKEN_HERE'}`;
          document.getElementById('iniConfigOutput').textContent = iniConfig;
        }

        function copyIniConfig() {
          const configText = document.getElementById('iniConfigOutput').textContent;
          navigator.clipboard.writeText(configText).then(function() {
            showNotification('Configuration copied to clipboard!', 'success');
          }).catch(function(err) {
            console.error('Could not copy text: ', err);
            showNotification('Failed to copy. Please select and copy manually.', 'error');
          });
        }

        function saveApiToken() {
          const token = document.getElementById('apiTokenInput').value.trim();
          if (token) {
              localStorage.setItem('modioApiToken', token);
              showNotification('API token saved locally!', 'success');
          } else {
              localStorage.removeItem('modioApiToken');
              showNotification('Local API token cleared.', 'info');
          }
          document.getElementById('apiSetupModal').style.display = 'none';
          ensureModListIsVisible();
        }
        
function generateShareLink() {
    // 1. Get the current server parameters string from the form.
    // We can reuse the generateConfig logic to ensure it's always up-to-date.
    generateConfig(); 
    const steamParamsString = getServerParamsString(); // We will create this small helper function.

    // 2. URI-encode the entire parameter string so it can be safely passed in a URL.
    const encodedServerParams = encodeURIComponent(steamParamsString);

    // 3. Construct the base URL of the current page.
    const baseUrl = window.location.origin + window.location.pathname;
    
    // 4. Create the final shareable URL with the action and params.
    const shareUrl = `${baseUrl}?action=launch&params=${encodedServerParams}`;

    // 5. Copy the HTTPS link to the clipboard.
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(shareUrl).then(() => {
            showNotification('Shareable link for Discord copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy link automatically: ', err);
            prompt('Copy this shareable link:', shareUrl); // Fallback for errors
        });
    } else {
        // Fallback for non-secure contexts or older browsers
        prompt('Copy this shareable link:', shareUrl);
    }
}
/**
 * HELPER FUNCTION: Extracts the core logic for getting the server parameter string.
 * This avoids code duplication between generateConfig and generateShareLink.
 */
function getServerParamsString() {
    const hostname = document.getElementById('hostname').value || "My Insurgency Server";
    const maxPlayers = document.getElementById('maxPlayers').value || "24";
    const port = document.getElementById('port').value || "27102";
    const queryPort = document.getElementById('queryPort').value || "27131";
    const scenario = document.getElementById('scenario').value;
    const password = document.getElementById('password').value;
    const enableCheats = document.getElementById('enableCheats').checked;
    const gameStatsToken = document.getElementById('gameStatsToken').value;
    const gsltToken = document.getElementById('gsltToken').value;
    const enableGameStats = document.getElementById('enableGameStats').checked;
    const officialRules = document.getElementById('officialRules').checked;

    let travelUrl = scenario;
    const travelUrlParams = [];
    travelUrlParams.push(`MaxPlayers=${maxPlayers}`);
    if (password) {
        travelUrlParams.push(`Password=${password}`);
    }
    if (travelUrlParams.length > 0) {
        travelUrl += '?' + travelUrlParams.join('?');
    }

    const otherParams = [
        `-Port=${port}`,
        `-QueryPort=${queryPort}`,
        '-log',
        `-hostname="${hostname}"`
    ];
    if (enableCheats) otherParams.push("-EnableCheats");
    if (gameStatsToken && enableGameStats) {
        otherParams.push(`-GameStatsToken=${gameStatsToken}`, "-GameStats");
    }
    if (gsltToken) otherParams.push(`-GSLTToken=${gsltToken}`);
    if (officialRules) otherParams.push("-ruleset=OfficialRules");
    if (selectedMutators.length > 0) {
        otherParams.push(`-Mutators=${selectedMutators.join(',')}`);
    }
    if (selectedMods.length > 0) {
        const modIds = selectedMods.map(mod => mod.id).join(',');
        otherParams.push(`-mods`, `-CmdModList=${modIds}`);
    }

    return `${travelUrl} ${otherParams.join(' ')}`;
}
    </script>
</body>
</html>
